import{w as t,cc as z,ca as te,j as r,cX as A,I as H,p as re,cY as ne,cZ as se,c_ as ie,x as V,c$ as X,d0 as w,f as W,B as le,E as ae,d1 as ce}from"./optional/blueprint-editor-BF9JwLNn.js";import{u as ue}from"./main-vEu0eG08.js";import"./optional/vendor-codemirror-CjDT2NJG.js";import"./optional/vendor-lezer-BVuE63-5.js";import"./optional/lang-php-DAdSG8P3.js";import"./optional/lang-html-B08Fw0dr.js";import"./optional/lang-css-DVB8fG3-.js";import"./optional/lang-javascript-rj9Dnv5V.js";import"./index-BZMAjRjR.js";import"./modulepreload-polyfill-B5Qt9EMX.js";import"./_virtual_cors-proxy-url-DfPPJwK5.js";import"./config-EgTtIA_y.js";const oe=1024*1024,de=n=>{const e=n.byteLength;for(let s=0;s<Math.min(e,4096);s++)if(n[s]===0)return!0;try{return new TextDecoder("utf-8",{fatal:!0}).decode(n),!1}catch{return!0}},Y=(n,e)=>{const s=new Blob([n]),a=URL.createObjectURL(s);return setTimeout(()=>URL.revokeObjectURL(a),6e4),{url:a,filename:e}},fe=n=>{const e=n.split(".").pop();return X[e]||X._default},he=n=>n.startsWith("image/")||n.startsWith("video/")||n.startsWith("audio/");function we({filesystem:n,currentPath:e,selectedDirPath:s,setSelectedDirPath:a,onFileOpened:C,onSelectionCleared:L,onShowMessage:S,documentRoot:l}){const v=t.useRef(null),b=t.useMemo(()=>z(e?te(z(e)):s??l),[e,l]),[E,G]=t.useState(null),g=async(f,o)=>{try{const R=await n.read(f),u=new Uint8Array(await R.arrayBuffer()),B=u.byteLength,N=f.split("/").pop()||"download";if(B>oe){const{url:P,filename:j}=Y(u,N);await S(f,r.jsxs(r.Fragment,{children:[r.jsx("p",{children:"File too large to open (>1MB)."}),r.jsx("p",{children:r.jsxs("a",{href:P,download:j,children:["Download ",j]})})]}));return}if(de(u)){const P=fe(N),{url:j,filename:y}=Y(u,N);if(he(P)){const p=new Blob([u],{type:P}),h=URL.createObjectURL(p);await S(f,r.jsx(ie,{filename:y,mimeType:P,dataUrl:h,downloadUrl:j}));return}await S(f,r.jsxs(r.Fragment,{children:[r.jsx("p",{children:"Binary file. Cannot be edited."}),r.jsx("p",{children:r.jsxs("a",{href:j,download:y,children:["Download ",y]})})]}));return}const M=new TextDecoder("utf-8").decode(u);await C(f,M,o)}catch(R){V.error("Could not open file",R),await S(null,"Could not open file.")}};return r.jsxs("div",{className:A.fileExplorerContainer,children:[r.jsxs("div",{className:A.fileExplorerHeader,children:[r.jsx("span",{className:A.fileExplorerTitle,children:"Files"}),r.jsxs("div",{className:A.fileExplorerActions,children:[r.jsxs("button",{className:A.fileExplorerButton,type:"button",onClick:()=>{v.current&&v.current.createFile(E??void 0)},title:"Create new file",children:[r.jsx(H,{icon:re,size:16}),"New File"]}),r.jsxs("button",{className:A.fileExplorerButton,type:"button",onClick:()=>{v.current&&v.current.createFolder(E??void 0)},title:"Create new folder",children:[r.jsx(H,{icon:ne,size:16}),"New Folder"]})]})]}),r.jsx("div",{className:A.fileExplorerTree,children:r.jsx(se,{ref:v,filesystem:n,root:l,initialSelectedPath:b,onSelect:async f=>{if(G(f),!f){await L();return}try{if(await n.isDir(f)){a(f);return}}catch{}await g(f,!1)},onDoubleClickFile:async f=>{await g(f,!0)}})})]})}const pe=1500,i={IDLE:"idle",PENDING:"pending",SAVING:"saving",SAVED:"saved",ERROR:"error"};function Te({site:n,isVisible:e=!0,documentRoot:s}){const a=ue(n.slug),C=ve(a),[L,S]=t.useState(`${s}/workspace`),[l,v]=t.useState(null),[b,E]=t.useState(""),[G,g]=t.useState(!0),[f,o]=t.useState(i.IDLE),[R,u]=t.useState(null),[B,N]=t.useState(!1),[M,P]=t.useState(!0),[j,y]=t.useState(null),p=t.useRef(null),h=t.useRef(null),D=t.useRef(!1),F=t.useRef(b),x=t.useRef(l),I=t.useRef(a),U=t.useRef(a),_=t.useRef(!1),T=t.useRef(new Map);t.useEffect(()=>{F.current=b},[b]),t.useEffect(()=>{x.current=l},[l]),t.useEffect(()=>{I.current=a??null},[a]),t.useEffect(()=>{U.current&&U.current!==a&&O(U.current,{saveTimeoutRef:h,currentPathRef:x,codeRef:F,setSaveState:o,setSaveError:u}),U.current=a??null},[a]),t.useEffect(()=>()=>{O(I.current,{saveTimeoutRef:h,currentPathRef:x,codeRef:F,setSaveState:o,setSaveError:u})},[]),t.useEffect(()=>{a||(D.current=!0,E(""),v(null),g(!0),o(i.IDLE),u(null),N(!1),y(null))},[a]),t.useEffect(()=>{S(`${s}/workspace`),v(null),E(""),g(!0),o(i.IDLE),u(null),D.current=!0,y(null),_.current=!1},[n.slug,s]),t.useEffect(()=>{const c=I.current;if(!c||!l){h.current!==null&&(window.clearTimeout(h.current),h.current=null),l||o(i.IDLE);return}if(D.current){D.current=!1;return}h.current!==null&&(window.clearTimeout(h.current),h.current=null),o(i.PENDING);const d=window.setTimeout(async()=>{h.current=null,o(i.SAVING);try{await c.writeFile(x.current,F.current),o(i.SAVED),u(null)}catch(m){V.error("Failed to save file",m),o(i.ERROR),u("Could not save changes. Try again.")}},pe);return h.current=d,()=>{h.current===d&&(window.clearTimeout(d),h.current=null)}},[b,l]),t.useEffect(()=>{if(f!==i.SAVED)return;const c=window.setTimeout(()=>{o(d=>d===i.SAVED?i.IDLE:d)},2e3);return()=>window.clearTimeout(c)},[f]),t.useEffect(()=>{if(!a||_.current)return;const c=`${s}/wp-config.php`;(async()=>{try{if(await a.fileExists(c)){const k=await a.readFileAsText(c);D.current=!0,v(c),E(k),g(!1),o(i.IDLE),u(null),setTimeout(()=>{p.current?.focus()},100)}}catch(m){V.debug("Could not auto-open wp-config.php:",m)}finally{_.current=!0}})()},[a,s]);const Z=t.useCallback(async(c,d,m=!0)=>{const k=p.current?.getCursorPosition();k!=null&&x.current&&T.current.set(x.current,k);try{await O(I.current,{saveTimeoutRef:h,currentPathRef:x,codeRef:F,setSaveState:o,setSaveError:u})}catch{}D.current=!0,v(c),E(d),y(null),g(!1),o(i.IDLE),u(null),N(!1),setTimeout(()=>{const $=T.current.get(c);$!==void 0&&p.current?.setCursorPosition($),m?(p.current?.focus(),P(!1)):(p.current?.blur(),P(!0))},50)},[]);t.useEffect(()=>{if(!l)return;const c=setInterval(()=>{const m=p.current?.getCursorPosition();m!=null&&T.current.set(l,m)},1e3),d=p.current?.getCursorPosition();return d!=null&&T.current.set(l,d),()=>{clearInterval(c);const m=p.current?.getCursorPosition();m!=null&&T.current.set(l,m)}},[l]),t.useEffect(()=>{if(!e||!l)return;const c=setTimeout(()=>{const d=T.current.get(l);d!==void 0&&p.current?.setCursorPosition(d),M||p.current?.focus()},100);return()=>clearTimeout(c)},[e,l,M]);const q=t.useCallback(async()=>{const c=p.current?.getCursorPosition();c!=null&&x.current&&T.current.set(x.current,c);try{await O(I.current,{saveTimeoutRef:h,currentPathRef:x,codeRef:F,setSaveState:o,setSaveError:u})}catch{}D.current=!0,v(null),E(""),y(null),g(!0),o(i.IDLE),u(null)},[]),J=t.useCallback(async(c,d)=>{try{await O(I.current,{saveTimeoutRef:h,currentPathRef:x,codeRef:F,setSaveState:o,setSaveError:u})}catch{}D.current=!0,v(null),typeof d=="string"?(E(d),y(null)):(E(""),y(d)),g(!0),o(i.IDLE),u(null),N(!1)},[]),K=t.useCallback(()=>{O(I.current,{saveTimeoutRef:h,currentPathRef:x,codeRef:F,setSaveState:o,setSaveError:u})},[]),Q=xe(f,R),ee=Ee(f,w);return!a||!C?r.jsx("div",{className:w.container,children:r.jsx("div",{className:w.placeholder,children:"Start this Playground to browse and edit its files."})}):r.jsx("div",{className:w.container,children:r.jsxs("div",{className:W(w.content,{[w.sidebarOpen]:B}),children:[r.jsx("div",{className:w.mobileOverlay,onClick:()=>N(!1)}),r.jsx("aside",{className:w.sidebarWrapper,children:r.jsx(we,{filesystem:C,currentPath:l,selectedDirPath:L,setSelectedDirPath:S,onFileOpened:Z,onSelectionCleared:q,onShowMessage:J,documentRoot:s})}),r.jsxs("section",{className:w.editorWrapper,children:[r.jsxs("div",{className:w.editorHeader,children:[r.jsx(le,{className:w.mobileToggle,variant:"secondary",onClick:()=>N(c=>!c),children:B?"Hide files":"Browse files"}),r.jsx("div",{className:W(w.editorPath,{[w.editorPathPlaceholder]:!l?.length}),children:l?.length?l:`Browse files under ${s}`}),r.jsx("div",{className:W(w.saveStatus,ee),children:Q})]}),R?r.jsx("div",{style:{padding:"8px 16px"},children:r.jsx(ae,{status:"error",isDismissible:!1,children:R})}):null,l||b||j?j?r.jsx("div",{className:w.messageArea,children:j}):r.jsx(ce,{ref:p,code:b,onChange:E,currentPath:l,className:w.editor,onSaveShortcut:K,readOnly:G}):r.jsx("div",{className:w.placeholder,children:"Select a file to view or edit its contents."})]})]})})}class me extends EventTarget{constructor(e){super(),this.client=e}isDir(e){return this.client.isDir(e)}fileExists(e){return this.client.fileExists(e)}async read(e){const s=await this.client.readFileAsBuffer(e);return{arrayBuffer:async()=>s.buffer}}readFileAsText(e){return this.client.readFileAsText(e)}listFiles(e){return this.client.listFiles(e)}writeFile(e,s){return this.client.writeFile(e,s)}mkdir(e){return this.client.mkdir(e)}rmdir(e,s){return this.client.rmdir(e,s)}mv(e,s){return this.client.mv(e,s)}unlink(e){return this.client.unlink(e)}}function ve(n){return t.useMemo(()=>n?new me(n):null,[n])}function xe(n,e){switch(n){case i.PENDING:case i.SAVING:return"Savingâ€¦";case i.SAVED:return"Saved";case i.ERROR:return e??"Save failed";default:return""}}function Ee(n,e){switch(n){case i.PENDING:return e.saveStatusPending;case i.SAVING:return e.saveStatusSaving;case i.ERROR:return e.saveStatusError;default:return}}async function O(n,{saveTimeoutRef:e,currentPathRef:s,codeRef:a,setSaveState:C,setSaveError:L}){if(e.current!==null){if(!n||!s.current){window.clearTimeout(e.current),e.current=null;return}window.clearTimeout(e.current),e.current=null,C(i.SAVING);try{await n.writeFile(s.current,a.current),C(i.SAVED),L(null)}catch(S){throw V.error("Failed to save file",S),C(i.ERROR),L("Could not save changes. Try again."),S}}}export{Te as SiteFileBrowser};
//# sourceMappingURL=index-BjX23IKV.js.map
