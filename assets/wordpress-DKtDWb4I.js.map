{"version":3,"file":"wordpress-DKtDWb4I.js","sources":["../../../../../packages/php-wasm/node-polyfills/src/lib/current-js-runtime.ts","../../../../../packages/php-wasm/node-polyfills/src/lib/blob.ts","../../../../../packages/php-wasm/node-polyfills/src/lib/custom-event.ts","../../../../../packages/php-wasm/logger/src/lib/handlers/log-event.ts","../../../../../packages/php-wasm/logger/src/lib/handlers/log-to-console.ts","../../../../../packages/php-wasm/logger/src/lib/handlers/log-to-memory.ts","../../../../../packages/php-wasm/logger/src/lib/logger.ts","../../../../../packages/php-wasm/util/src/lib/sleep.ts","../../../../../packages/php-wasm/util/src/lib/semaphore.ts","../../../../../packages/php-wasm/util/src/lib/php-wasm-error.ts","../../../../../packages/php-wasm/util/src/lib/index.ts","../../../../../packages/php-wasm/universal/src/lib/load-php-runtime.ts","../../../../../packages/php-wasm/universal/src/lib/php-response.ts","../../../../../packages/php-wasm/stream-compression/src/utils/iterable-stream-polyfill.ts","../../../../../packages/php-wasm/stream-compression/src/zip/decode-remote-zip.ts","../../../../../packages/php-wasm/universal/src/lib/comlink-sync.ts","../../../../../packages/php-wasm/universal/src/lib/serialize-error.ts","../../../../../packages/php-wasm/universal/src/lib/api.ts","../../../../../packages/php-wasm/web/src/lib/tls/utils.ts","../../../../../packages/php-wasm/web/src/lib/tls/extensions/types.ts","../../../../../packages/php-wasm/web/src/lib/tls/extensions/0_server_name.ts","../../../../../packages/php-wasm/web/src/lib/tls/cipher-suites.ts","../../../../../packages/php-wasm/web/src/lib/tls/extensions/10_supported_groups.ts","../../../../../packages/php-wasm/web/src/lib/tls/extensions/11_ec_point_formats.ts","../../../../../packages/php-wasm/web/src/lib/tls/extensions/13_signature_algorithms.ts","../../../../../packages/php-wasm/web/src/lib/tls/1_2/types.ts","../../../../../packages/php-wasm/web/src/lib/tls/1_2/connection.ts","../../../../../packages/php-wasm/web-service-worker/src/messaging.ts","../../../../../packages/php-wasm/web/src/lib/chunked-decoder.ts","../../../../../packages/php-wasm/web/src/lib/setup-post-message-relay.ts","../../../../../packages/php-wasm/web/src/lib/worker-thread/spawn-php-worker-thread.ts","../../../../../packages/php-wasm/fs-journal/src/lib/fs-journal.ts","../../../../../packages/playground/remote/src/lib/progress-bar/index.ts","../../../../../packages/playground/remote/src/lib/boot-playground-remote.ts","../../../../../packages/playground/wordpress-builds/src/index.ts","../../../../../packages/playground/remote/remote.html?html-proxy&index=1.js"],"sourcesContent":["export const currentJsRuntime = (function () {\n\tif (typeof process !== 'undefined' && process.release?.name === 'node') {\n\t\treturn 'NODE';\n\t} else if (typeof window !== 'undefined') {\n\t\treturn 'WEB';\n\t} else if (\n\t\t// @ts-ignore\n\t\ttypeof WorkerGlobalScope !== 'undefined' &&\n\t\t// @ts-ignore\n\t\tself instanceof (WorkerGlobalScope as any)\n\t) {\n\t\treturn 'WORKER';\n\t} else {\n\t\treturn 'NODE';\n\t}\n})();\n","import { currentJsRuntime } from './current-js-runtime';\n\n// Without this check, the polyfills below would also be applied\n// in web browsers. Unfortunately, Safari doesn't sypport BYOB streams\n// and doesn't support the polyfill provided here. Let's only apply\n// those polyfills in Node.js environments.\nif (currentJsRuntime === 'NODE') {\n\t/**\n\t * WordPress Playground heavily realies on the File class. This module\n\t * polyfill the File class for the different environments where\n\t * WordPress Playground may run.\n\t */\n\tif (typeof File === 'undefined') {\n\t\t/**\n\t\t * Polyfill the File class that isn't shipped in Node.js version 18.\n\t\t *\n\t\t * Blob conveniently provides a lot of the same methods as File, we\n\t\t * just need to implement a few File-specific properties.\n\t\t */\n\t\tclass File extends Blob {\n\t\t\treadonly name: string;\n\t\t\treadonly lastModified: number;\n\t\t\treadonly lastModifiedDate: Date;\n\t\t\twebkitRelativePath: any;\n\t\t\tconstructor(\n\t\t\t\tsources: BlobPart[],\n\t\t\t\tfileName: string,\n\t\t\t\toptions?: FilePropertyBag\n\t\t\t) {\n\t\t\t\tsuper(sources);\n\t\t\t\t/*\n\t\t\t\t * Compute a valid last modified date as that's what the\n\t\t\t\t * browsers do:\n\t\t\t\t *\n\t\t\t\t * ```\n\t\t\t\t * > new File([], '').lastModifiedDate\n\t\t\t\t * Sat Dec 16 2023 10:07:53 GMT+0100 (czas środkowoeuropejski standardowy)\n\t\t\t\t *\n\t\t\t\t * > new File([], '', { lastModified: NaN }).lastModifiedDate\n\t\t\t\t * Thu Jan 01 1970 01:00:00 GMT+0100 (czas środkowoeuropejski standardowy)\n\t\t\t\t *\n\t\t\t\t * > new File([], '', { lastModified: 'string' }).lastModifiedDate\n\t\t\t\t * Thu Jan 01 1970 01:00:00 GMT+0100 (czas środkowoeuropejski standardowy)\n\t\t\t\t *\n\t\t\t\t * > new File([], '', { lastModified: {} }).lastModifiedDate\n\t\t\t\t * Thu Jan 01 1970 01:00:00 GMT+0100 (czas środkowoeuropejski standardowy)\n\t\t\t\t * ```\n\t\t\t\t */\n\t\t\t\tlet date;\n\t\t\t\tif (options?.lastModified) {\n\t\t\t\t\tdate = new Date();\n\t\t\t\t}\n\t\t\t\tif (!date || isNaN(date.getFullYear())) {\n\t\t\t\t\tdate = new Date();\n\t\t\t\t}\n\t\t\t\tthis.lastModifiedDate = date;\n\t\t\t\tthis.lastModified = date.getMilliseconds();\n\t\t\t\tthis.name = fileName || '';\n\t\t\t}\n\t\t}\n\t\tglobal.File = File;\n\t}\n\n\t// eslint-disable-next-line no-inner-declarations\n\tfunction asPromise<T>(obj: FileReader) {\n\t\treturn new Promise<T>(function (resolve, reject) {\n\t\t\tobj.onload = obj.onerror = function (event: Event) {\n\t\t\t\tobj.onload = obj.onerror = null;\n\n\t\t\t\tif (event.type === 'load') {\n\t\t\t\t\tresolve(obj.result as T);\n\t\t\t\t} else {\n\t\t\t\t\treject(new Error('Failed to read the blob/file'));\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t}\n\n\t/**\n\t * File is a subclass of Blob. Let's polyfill the following Blob\n\t * methods that are missing in JSDOM:\n\t *\n\t * – Blob.text()\n\t * – Blob.stream()\n\t * – Blob.arrayBuffer()\n\t *\n\t * See the related JSDom issue:\n\t *\n\t * – [Implement Blob.stream, Blob.text and Blob.arrayBuffer](https://github.com/jsdom/jsdom/issues/2555).\n\t *\n\t * @source `blob-polyfill` npm package.\n\t * * By Eli Grey, https://eligrey.com\n\t * * By Jimmy Wärting, https://github.com/jimmywarting\n\t */\n\tif (typeof Blob.prototype.arrayBuffer === 'undefined') {\n\t\tBlob.prototype.arrayBuffer = function arrayBuffer() {\n\t\t\tconst reader = new FileReader();\n\t\t\treader.readAsArrayBuffer(this);\n\t\t\treturn asPromise<Uint8Array>(reader);\n\t\t};\n\t}\n\n\tif (typeof Blob.prototype.text === 'undefined') {\n\t\tBlob.prototype.text = function text() {\n\t\t\tconst reader = new FileReader();\n\t\t\treader.readAsText(this);\n\t\t\treturn asPromise<string>(reader);\n\t\t};\n\t}\n\n\t/**\n\t * Detects if BYOB (Bring Your Own Buffer) streams are supported\n\t * in the current environment.\n\t *\n\t * BYOB is a new feature in the Streams API that allows reading\n\t * an arbitrary number of bytes from a stream. It's not supported\n\t * in older versions of Node.js.\n\t *\n\t * @see https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamBYOBReader\n\t */\n\t// eslint-disable-next-line no-inner-declarations\n\tfunction isByobSupported() {\n\t\tconst inputBytes = new Uint8Array([1, 2, 3, 4]);\n\t\tconst file = new File([inputBytes], 'test');\n\t\tconst stream = file.stream();\n\t\ttry {\n\t\t\t// This throws on older versions of node:\n\t\t\tstream.getReader({ mode: 'byob' });\n\t\t\treturn true;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Polyfill the stream() method if it either doesn't exist,\n\t * or is an older version shipped with e.g. Node.js 18 where\n\t * BYOB streams seem to be unsupported.\n\t */\n\tif (typeof Blob.prototype.stream === 'undefined' || !isByobSupported()) {\n\t\tBlob.prototype.stream = function () {\n\t\t\tlet position = 0;\n\t\t\t// eslint-disable-next-line\n\t\t\tconst blob = this;\n\t\t\treturn new ReadableStream({\n\t\t\t\ttype: 'bytes',\n\t\t\t\t// 0.5 MB seems like a reasonable chunk size, let's adjust\n\t\t\t\t// this if needed.\n\t\t\t\tautoAllocateChunkSize: 512 * 1024,\n\n\t\t\t\tasync pull(controller) {\n\t\t\t\t\tconst view = controller.byobRequest!.view;\n\n\t\t\t\t\t// Read the next chunk of data:\n\t\t\t\t\tconst chunk = blob.slice(\n\t\t\t\t\t\tposition,\n\t\t\t\t\t\tposition + view!.byteLength\n\t\t\t\t\t);\n\t\t\t\t\tconst buffer = await chunk.arrayBuffer();\n\t\t\t\t\tconst uint8array = new Uint8Array(buffer);\n\n\t\t\t\t\t// Emit that chunk:\n\t\t\t\t\tnew Uint8Array(view!.buffer).set(uint8array);\n\t\t\t\t\tconst bytesRead = uint8array.byteLength;\n\t\t\t\t\tcontroller.byobRequest!.respond(bytesRead);\n\n\t\t\t\t\t// Bump the position and close this stream once\n\t\t\t\t\t// we've read the entire blob.\n\t\t\t\t\tposition += bytesRead;\n\t\t\t\t\tif (position >= blob.size) {\n\t\t\t\t\t\tcontroller.close();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t};\n\t}\n}\n\nexport default {};\n","import { currentJsRuntime } from './current-js-runtime';\n\nif (currentJsRuntime === 'NODE' && typeof CustomEvent === 'undefined') {\n\tclass CustomEvent<T = any> extends Event {\n\t\treadonly detail: T;\n\t\tconstructor(\n\t\t\tname: string,\n\t\t\toptions: {\n\t\t\t\tdetail?: T;\n\t\t\t\tbubbles?: boolean;\n\t\t\t\tcancellable?: boolean;\n\t\t\t\tcomposed?: boolean;\n\t\t\t} = {}\n\t\t) {\n\t\t\tsuper(name, options);\n\t\t\t/*\n\t\t\t * The bang symbol (`!`) here is a lie to make TypeScript happy.\n\t\t\t *\n\t\t\t * Without the bang TS has the following complaint:\n\t\t\t *\n\t\t\t * > T | undefined is not assignable to type T\n\t\t\t *\n\t\t\t * In reality, it's absolutely fine for T (or `options.detail`)\n\t\t\t * to be undefined. However, the CustomEvent interface shipped\n\t\t\t * with TypeScript doesn't think so and marks `this.details` as\n\t\t\t * a required property.\n\t\t\t *\n\t\t\t * This little and harmless trick silences that error.\n\t\t\t */\n\t\t\tthis.detail = options.detail!;\n\t\t}\n\t\tinitCustomEvent(): void {}\n\t}\n\tglobalThis.CustomEvent = CustomEvent;\n}\n","import type { LogHandler } from '../log-handlers';\nimport { type Log, logger } from '../logger';\n\nexport const logEventType = 'playground-log';\n\nexport const logEvent: LogHandler = (log: Log, ...args: any[]): void => {\n\tlogger.dispatchEvent(\n\t\tnew CustomEvent(logEventType, {\n\t\t\tdetail: {\n\t\t\t\tlog,\n\t\t\t\targs,\n\t\t\t},\n\t\t})\n\t);\n};\n","import type { LogHandler } from '../log-handlers';\nimport { type Log, LogSeverity, prepareLogMessage } from '../logger';\n\n/**\n * Log message to the console.\n */\nexport const logToConsole: LogHandler = (log: Log, ...args: any[]): void => {\n\tif (typeof log.message === 'string') {\n\t\t// Some errors have a read-only message property where direct\n\t\t// assignment will throw an error. The assignment is merely for\n\t\t// formatting, so let's assign with Reflect.set and avoid the error.\n\t\tReflect.set(log, 'message', prepareLogMessage(log.message));\n\t} else if (log.message.message && typeof log.message.message === 'string') {\n\t\t// Some errors have a read-only message property where direct\n\t\t// assignment will throw an error. The assignment is merely for\n\t\t// formatting, so let's assign with Reflect.set and avoid the error.\n\t\tReflect.set(\n\t\t\tlog.message,\n\t\t\t'message',\n\t\t\tprepareLogMessage(log.message.message)\n\t\t);\n\t}\n\t/* eslint-disable no-console */\n\tswitch (log.severity) {\n\t\tcase LogSeverity.Debug:\n\t\t\tconsole.debug(log.message, ...args);\n\t\t\tbreak;\n\t\tcase LogSeverity.Info:\n\t\t\tconsole.info(log.message, ...args);\n\t\t\tbreak;\n\t\tcase LogSeverity.Warn:\n\t\t\tconsole.warn(log.message, ...args);\n\t\t\tbreak;\n\t\tcase LogSeverity.Error:\n\t\t\tconsole.error(log.message, ...args);\n\t\t\tbreak;\n\t\tcase LogSeverity.Fatal:\n\t\t\tconsole.error(log.message, ...args);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tconsole.log(log.message, ...args);\n\t}\n\t/* eslint-enable no-console */\n};\n","import type { LogHandler } from '../log-handlers';\nimport { formatLogEntry, type Log, LogPrefix } from '../logger';\n\nconst prepareLogMessage = (logMessage: object): string => {\n\tif (logMessage instanceof Error) {\n\t\treturn [logMessage.message, logMessage.stack].join('\\n');\n\t}\n\treturn JSON.stringify(logMessage, null, 2);\n};\n\nexport const logs: string[] = [];\n\nconst addToLogArray = (message: string): void => {\n\tlogs.push(message);\n};\n\n/**\n * Log to memory\n */\nexport const logToMemory: LogHandler = (log: Log): void => {\n\tif (log.raw === true) {\n\t\taddToLogArray(log.message);\n\t} else {\n\t\tconst message = formatLogEntry(\n\t\t\ttypeof log.message === 'object'\n\t\t\t\t? prepareLogMessage(log.message)\n\t\t\t\t: log.message,\n\t\t\tlog.severity,\n\t\t\tlog.prefix ?? LogPrefix.JS\n\t\t);\n\t\taddToLogArray(message);\n\t}\n};\n\nexport const clearMemoryLogs = (): void => {\n\tlogs.length = 0;\n};\n","import { logEvent } from './handlers/log-event';\nimport {\n\tlogToMemory,\n\tlogToConsole,\n\tlogs,\n\ttype LogHandler,\n} from './log-handlers';\n\nexport { logEventType } from './handlers/log-event';\n\nexport { errorLogPath } from './collectors/collect-php-logs';\n\nexport type Log = {\n\tmessage: any;\n\tseverity: LogSeverity;\n\tprefix?: LogPrefix;\n\traw?: boolean;\n};\n\n/**\n * Log severity levels.\n */\nexport const LogSeverity = {\n\tFatal: { name: 'fatal', level: 0 },\n\tError: { name: 'error', level: 1 },\n\tWarn: { name: 'warn', level: 2 },\n\tLog: { name: 'log', level: 3 },\n\tInfo: { name: 'info', level: 4 },\n\tDebug: { name: 'debug', level: 5 },\n} as const;\n\nexport type LogSeverity = (typeof LogSeverity)[keyof typeof LogSeverity];\n\n/**\n * Log prefix.\n */\nexport const LogPrefix = {\n\tWASM: 'Wasm Crash',\n\tPHP: 'PHP',\n\tJS: 'JavaScript',\n} as const;\n\nexport type LogPrefix = (typeof LogPrefix)[keyof typeof LogPrefix];\n\n/**\n * A logger for Playground.\n */\nexport class Logger extends EventTarget {\n\tpublic readonly fatalErrorEvent = 'playground-fatal-error';\n\tprivate readonly handlers: LogHandler[];\n\tprivate severity: LogSeverity = LogSeverity.Info;\n\n\t// constructor\n\tconstructor(\n\t\t// Log handlers\n\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\n\t\thandlers: LogHandler[] = []\n\t) {\n\t\tsuper();\n\t\tthis.handlers = handlers;\n\t}\n\n\t/**\n\t * Get all logs.\n\t * @returns string[]\n\t */\n\tpublic getLogs(): string[] {\n\t\tif (!this.handlers.includes(logToMemory)) {\n\t\t\tthis\n\t\t\t\t.error(`Logs aren't stored because the logToMemory handler isn't registered.\n\t\t\t\tIf you're using a custom logger instance, make sure to register logToMemory handler.\n\t\t\t`);\n\t\t\treturn [];\n\t\t}\n\t\treturn [...logs];\n\t}\n\n\t/**\n\t * Log message with severity.\n\t *\n\t * @param log Log\n\t * @param args any\n\t */\n\tpublic logMessage(\n\t\tlog: Omit<Log, 'severity'> & { severity?: LogSeverity },\n\t\t...args: any[]\n\t): void {\n\t\tconst logWithSeverity: Log = {\n\t\t\t...log,\n\t\t\tseverity: log.severity ?? LogSeverity.Log,\n\t\t};\n\t\tfor (const handler of this.handlers) {\n\t\t\tif (logWithSeverity.severity.level <= this.severity.level) {\n\t\t\t\thandler(logWithSeverity, ...args);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Filter message based on severity\n\t * @param severity LogSeverity\n\t */\n\tpublic setSeverityFilterLevel(severity: LogSeverity): void {\n\t\tthis.severity = severity;\n\t}\n\n\t/**\n\t * Log message\n\t *\n\t * @param message any\n\t * @param args any\n\t */\n\tpublic log(message: any, ...args: any[]): void {\n\t\tthis.logMessage(\n\t\t\t{\n\t\t\t\tmessage,\n\t\t\t\tseverity: LogSeverity.Log,\n\t\t\t\tprefix: LogPrefix.JS,\n\t\t\t\traw: false,\n\t\t\t},\n\t\t\t...args\n\t\t);\n\t}\n\n\t/**\n\t * Log debug message\n\t *\n\t * @param message any\n\t * @param args any\n\t */\n\tpublic debug(message: any, ...args: any[]): void {\n\t\tthis.logMessage(\n\t\t\t{\n\t\t\t\tmessage,\n\t\t\t\tseverity: LogSeverity.Debug,\n\t\t\t\tprefix: LogPrefix.JS,\n\t\t\t\traw: false,\n\t\t\t},\n\t\t\t...args\n\t\t);\n\t}\n\n\t/**\n\t * Log info message\n\t *\n\t * @param message any\n\t * @param args any\n\t */\n\tpublic info(message: any, ...args: any[]): void {\n\t\tthis.logMessage(\n\t\t\t{\n\t\t\t\tmessage,\n\t\t\t\tseverity: LogSeverity.Info,\n\t\t\t\tprefix: LogPrefix.JS,\n\t\t\t\traw: false,\n\t\t\t},\n\t\t\t...args\n\t\t);\n\t}\n\n\t/**\n\t * Log warning message\n\t *\n\t * @param message any\n\t * @param args any\n\t */\n\tpublic warn(message: any, ...args: any[]): void {\n\t\tthis.logMessage(\n\t\t\t{\n\t\t\t\tmessage,\n\t\t\t\tseverity: LogSeverity.Warn,\n\t\t\t\tprefix: LogPrefix.JS,\n\t\t\t\traw: false,\n\t\t\t},\n\t\t\t...args\n\t\t);\n\t}\n\n\t/**\n\t * Log error message\n\t *\n\t * @param message any\n\t * @param args any\n\t */\n\tpublic error(message: any, ...args: any[]): void {\n\t\tthis.logMessage(\n\t\t\t{\n\t\t\t\tmessage,\n\t\t\t\tseverity: LogSeverity.Error,\n\t\t\t\tprefix: LogPrefix.JS,\n\t\t\t\traw: false,\n\t\t\t},\n\t\t\t...args\n\t\t);\n\t}\n}\n\nconst getDefaultHandlers = () => {\n\ttry {\n\t\tif (process.env['NODE_ENV'] === 'test') {\n\t\t\treturn [logToMemory, logEvent];\n\t\t}\n\t} catch {\n\t\t// Process.env is not available in the browser\n\t}\n\treturn [logToMemory, logToConsole, logEvent];\n};\n\n/**\n * The logger instance.\n */\nexport const logger: Logger = new Logger(getDefaultHandlers());\n\nexport const prepareLogMessage = (message: string) => {\n\treturn message.replace(/\\t/g, '');\n};\n\nexport const formatLogEntry = (\n\tmessage: string,\n\tseverity: LogSeverity,\n\tprefix: string\n): string => {\n\tconst date = new Date();\n\tconst formattedDate = new Intl.DateTimeFormat('en-GB', {\n\t\tyear: 'numeric',\n\t\tmonth: 'short',\n\t\tday: '2-digit',\n\t\ttimeZone: 'UTC',\n\t})\n\t\t.format(date)\n\t\t.replace(/ /g, '-');\n\n\tconst formattedTime = new Intl.DateTimeFormat('en-GB', {\n\t\thour: '2-digit',\n\t\tminute: '2-digit',\n\t\tsecond: '2-digit',\n\t\thour12: false,\n\t\ttimeZone: 'UTC',\n\t\ttimeZoneName: 'short',\n\t}).format(date);\n\tconst now = formattedDate + ' ' + formattedTime;\n\tmessage = prepareLogMessage(message);\n\treturn `[${now}] ${prefix} ${severity.name}: ${message}`;\n};\n\n/**\n * Add a listener for the Playground crashes.\n * These crashes include Playground errors like Asyncify errors.\n * The callback function will receive an Event object with logs in the detail\n * property.\n *\n * @param loggerInstance The logger instance\n * @param callback The callback function\n */\nexport const addCrashListener = (\n\tloggerInstance: Logger,\n\tcallback: EventListenerOrEventListenerObject\n) => {\n\tloggerInstance.addEventListener(loggerInstance.fatalErrorEvent, callback);\n};\n","export const SleepFinished = Symbol('SleepFinished');\n\nexport function sleep(ms: number): Promise<typeof SleepFinished> {\n\treturn new Promise((resolve) => {\n\t\tsetTimeout(() => resolve(SleepFinished), ms);\n\t});\n}\n","import { SleepFinished, sleep } from './sleep';\n\nexport interface SemaphoreOptions {\n\t/**\n\t * The maximum number of concurrent locks.\n\t */\n\tconcurrency: number;\n\t/**\n\t * The maximum time to wait for a lock to become available.\n\t */\n\ttimeout?: number;\n}\n\nexport class AcquireTimeoutError extends Error {\n\tconstructor() {\n\t\tsuper('Acquiring lock timed out');\n\t}\n}\n\nexport default class Semaphore {\n\tprivate _running = 0;\n\tprivate concurrency: number;\n\tprivate timeout?: number;\n\tprivate queue: (() => void)[];\n\n\tconstructor({ concurrency, timeout }: SemaphoreOptions) {\n\t\tthis.concurrency = concurrency;\n\t\tthis.timeout = timeout;\n\t\tthis.queue = [];\n\t}\n\n\tget remaining(): number {\n\t\treturn this.concurrency - this.running;\n\t}\n\n\tget running(): number {\n\t\treturn this._running;\n\t}\n\n\tasync acquire(): Promise<() => void> {\n\t\twhile (true) {\n\t\t\tif (this._running >= this.concurrency) {\n\t\t\t\t// Concurrency exhausted – wait until a lock is released:\n\t\t\t\tconst acquired = new Promise<void>((resolve) => {\n\t\t\t\t\tthis.queue.push(resolve);\n\t\t\t\t});\n\t\t\t\tif (this.timeout !== undefined) {\n\t\t\t\t\tawait Promise.race([acquired, sleep(this.timeout)]).then(\n\t\t\t\t\t\t(value) => {\n\t\t\t\t\t\t\tif (value === SleepFinished) {\n\t\t\t\t\t\t\t\tthrow new AcquireTimeoutError();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tawait acquired;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Acquire the lock:\n\t\t\t\tthis._running++;\n\t\t\t\tlet released = false;\n\t\t\t\treturn () => {\n\t\t\t\t\tif (released) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\treleased = true;\n\t\t\t\t\tthis._running--;\n\t\t\t\t\t// Release the lock:\n\t\t\t\t\tif (this.queue.length > 0) {\n\t\t\t\t\t\tthis.queue.shift()!();\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n\n\tasync run<T>(fn: () => T | Promise<T>): Promise<T> {\n\t\tconst release = await this.acquire();\n\t\ttry {\n\t\t\treturn await fn();\n\t\t} finally {\n\t\t\trelease();\n\t\t}\n\t}\n}\n","export class PhpWasmError extends Error {\n\tuserFriendlyMessage?: string;\n\tconstructor(message: string, userFriendlyMessage?: string) {\n\t\tsuper(message);\n\t\tthis.userFriendlyMessage = userFriendlyMessage ?? message;\n\t}\n}\n","import Semaphore, { AcquireTimeoutError } from './semaphore';\nexport { Semaphore, AcquireTimeoutError };\nexport { PhpWasmError } from './php-wasm-error';\nexport type { SemaphoreOptions } from './semaphore';\nexport {\n\tdirname,\n\tjoinPaths,\n\tbasename,\n\tnormalizePath,\n\tisParentOf,\n\tensureAbsolutePath,\n} from './paths';\nexport { createSpawnHandler } from './create-spawn-handler';\nexport { randomString } from './random-string';\nexport { randomFilename } from './random-filename';\nexport { splitShellCommand } from './split-shell-command';\nexport { WritablePolyfill, type WritableOptions } from './writable-polyfill';\nexport { EventEmitterPolyfill } from './event-emitter-polyfill';\nexport * from './php-vars';\n\nexport * from './sprintf';\n\nexport function concatUint8Arrays(arrays: Uint8Array[]): Uint8Array {\n\tlet totalLength = 0;\n\tarrays.forEach((a) => (totalLength += a.length));\n\tconst result = new Uint8Array(totalLength);\n\tlet offset = 0;\n\tarrays.forEach((a) => {\n\t\tresult.set(a, offset);\n\t\toffset += a.length;\n\t});\n\treturn result;\n}\n\nexport function concatArrayBuffers(buffers: ArrayBuffer[]): ArrayBuffer {\n\treturn concatUint8Arrays(buffers.map((b) => new Uint8Array(b)))\n\t\t.buffer as ArrayBuffer;\n}\n\nexport * from './promised';\n","import { logger } from '@php-wasm/logger';\nimport type { IncomingMessage, Server, ServerResponse } from 'http';\n\nconst RuntimeId = Symbol('RuntimeId');\nconst loadedRuntimes: Map<number, PHPRuntime> = new Map();\nlet lastRuntimeId = 0;\n\n/**\n * Loads the PHP runtime with the given arguments and data dependencies.\n *\n * This function handles the entire PHP initialization pipeline. In particular,\n * it:\n *\n * * Instantiates the Emscripten PHP module\n * * Wires it together with the data dependencies and loads them\n * * Ensures is all happens in a correct order\n * * Waits until the entire loading sequence is finished\n *\n * Basic usage:\n *\n * ```js\n *  const phpLoaderModule = await getPHPLoaderModule(\"7.4\");\n *  const php = await loadPHPRuntime( phpLoaderModule );\n *  console.log(php.run(`<?php echo \"Hello, world!\"; `));\n *  // { stdout: ArrayBuffer containing the string \"Hello, world!\", stderr: [''], exitCode: 0 }\n * ```\n *\n * **The PHP loader module:**\n *\n * In the basic usage example, `phpLoaderModule` is **not** a vanilla\n * Emscripten module. Instead, it's an ESM module that wraps the regular\n * Emscripten output and adds some extra functionality. It's generated by the\n * Dockerfile shipped with this repo. Here's the API it provides:\n *\n * ```js\n * // php.wasm size in bytes:\n * export const dependenciesTotalSize = 5644199;\n *\n * // php.wasm filename:\n * export const dependencyFilename = 'php.wasm';\n *\n * // Run Emscripten's generated module:\n * export default function(jsEnv, emscriptenModuleArgs) {}\n * ```\n *\n * **PHP Filesystem:**\n *\n * Once initialized, the PHP has its own filesystem separate from the project\n * files. It's provided by [Emscripten and uses its FS library](https://emscripten.org/docs/api_reference/Filesystem-API.html).\n *\n * The API exposed to you via the PHP class is succinct and abstracts\n * certain unintuitive parts of low-level filesystem interactions.\n *\n * Here's how to use it:\n *\n * ```js\n * // Recursively create a /var/www directory\n * php.mkdirTree('/var/www');\n *\n * console.log(php.fileExists('/var/www/file.txt'));\n * // false\n *\n * php.writeFile('/var/www/file.txt', 'Hello from the filesystem!');\n *\n * console.log(php.fileExists('/var/www/file.txt'));\n * // true\n *\n * console.log(php.readFile('/var/www/file.txt'));\n * // \"Hello from the filesystem!\n *\n * // Delete the file:\n * php.unlink('/var/www/file.txt');\n * ```\n *\n * For more details consult the PHP class directly.\n *\n * **Data dependencies:**\n *\n * Using existing PHP packages by manually recreating them file-by-file would\n * be quite inconvenient. Fortunately, Emscripten provides a \"data dependencies\"\n * feature.\n *\n * Data dependencies consist of a `dependency.data` file and a `dependency.js`\n * loader and can be packaged with the [file_packager.py tool](\n * https://emscripten.org/docs/porting/files/packaging_files.html#packaging-using-the-file-packager-tool).\n * This project requires wrapping the Emscripten-generated `dependency.js` file\n * in an ES module as follows:\n *\n * 1. Prepend `export default function(emscriptenPHPModule) {'; `\n * 2. Prepend `export const dependencyFilename = '<DATA FILE NAME>'; `\n * 3. Prepend `export const dependenciesTotalSize = <DATA FILE SIZE>;`\n * 4. Append `}`\n *\n * Be sure to use the `--export-name=\"emscriptenPHPModule\"` file_packager.py\n * option.\n *\n * You want the final output to look as follows:\n *\n * ```js\n * export const dependenciesTotalSize = 5644199;\n * export const dependencyFilename = 'dependency.data';\n * export default function(emscriptenPHPModule) {\n *    // Emscripten-generated code:\n *    var Module = typeof emscriptenPHPModule !== 'undefined' ? emscriptenPHPModule : {};\n *    // ... the rest of it ...\n * }\n * ```\n *\n * Such a constructions enables loading the `dependency.js` as an ES Module\n * using `import(\"/dependency.js\")`.\n *\n * Once it's ready, you can load PHP and your data dependencies as follows:\n *\n * ```js\n *  const [phpLoaderModule, wordPressLoaderModule] = await Promise.all([\n *    getPHPLoaderModule(\"7.4\"),\n *    import(\"/wp.js\")\n *  ]);\n *  const php = await loadPHPRuntime(phpLoaderModule, {}, [wordPressLoaderModule]);\n * ```\n *\n * @public\n * @param  phpLoaderModule         - The ESM-wrapped Emscripten module. Consult the Dockerfile for the build process.\n * @param  options                 - The Emscripten module arguments, see https://emscripten.org/docs/api_reference/module.html#affecting-execution.\n * @returns Loaded runtime id.\n */\n\nexport async function loadPHPRuntime(\n\tphpLoaderModule: PHPLoaderModule,\n\t...options: EmscriptenOptions[]\n): Promise<number> {\n\tconst phpModuleArgs = Object.assign({}, ...options);\n\n\tconst [phpReady, resolvePHP, rejectPHP] = makePromise();\n\n\tconst PHPRuntime = phpLoaderModule.init(currentJsRuntime, {\n\t\tonAbort(reason) {\n\t\t\trejectPHP(reason);\n\t\t\t// This can happen after PHP has been initialized so\n\t\t\t// let's just log it.\n\t\t\tlogger.error(reason);\n\t\t},\n\t\tENV: {},\n\t\t// Emscripten sometimes prepends a '/' to the path, which\n\t\t// breaks vite dev mode. An identity `locateFile` function\n\t\t// fixes it.\n\t\tlocateFile: (path) => path,\n\t\t...phpModuleArgs,\n\t\tnoInitialRun: true,\n\t\tonRuntimeInitialized() {\n\t\t\tif (phpModuleArgs.onRuntimeInitialized) {\n\t\t\t\tphpModuleArgs.onRuntimeInitialized(PHPRuntime);\n\t\t\t}\n\t\t\tresolvePHP();\n\t\t},\n\t});\n\n\tawait phpReady;\n\n\tconst id = ++lastRuntimeId;\n\n\t// TODO: Ask @adamziel why this is here.\n\t// eslint-disable-next-line @typescript-eslint/no-unused-expressions -- why is this here?\n\tPHPRuntime.FS;\n\tPHPRuntime.id = id;\n\tPHPRuntime.originalExit = PHPRuntime._exit;\n\n\tPHPRuntime._exit = function (code: number) {\n\t\tif (PHPRuntime.outboundNetworkProxyServer) {\n\t\t\tPHPRuntime.outboundNetworkProxyServer.close();\n\t\t\tPHPRuntime.outboundNetworkProxyServer.closeAllConnections();\n\t\t}\n\t\tloadedRuntimes.delete(id);\n\t\treturn PHPRuntime.originalExit(code);\n\t};\n\n\tPHPRuntime[RuntimeId] = id;\n\tloadedRuntimes.set(id, PHPRuntime);\n\treturn id;\n}\n\nexport type RuntimeType = 'NODE' | 'WEB' | 'WORKER';\n\ndeclare const self: WindowOrWorkerGlobalScope;\ndeclare const WorkerGlobalScope: object | undefined;\n\nexport type PHPRuntimeId = number;\n\nexport function getLoadedRuntime(id: PHPRuntimeId): PHPRuntime {\n\treturn loadedRuntimes.get(id);\n}\n\nexport const currentJsRuntime = (function () {\n\tif (typeof process !== 'undefined' && process.release?.name === 'node') {\n\t\treturn 'NODE';\n\t} else if (typeof window !== 'undefined') {\n\t\treturn 'WEB';\n\t} else if (\n\t\ttypeof WorkerGlobalScope !== 'undefined' &&\n\t\tself instanceof (WorkerGlobalScope as any)\n\t) {\n\t\treturn 'WORKER';\n\t} else {\n\t\treturn 'NODE';\n\t}\n})();\n\n/**\n * Creates and exposes Promise resolve/reject methods for later use.\n */\nconst makePromise = () => {\n\tconst methods: any = [];\n\n\tconst promise = new Promise((resolve, reject) => {\n\t\tmethods.push(resolve, reject);\n\t});\n\tmethods.unshift(promise);\n\n\treturn methods as [Promise<any>, (v?: any) => void, (e?: any) => void];\n};\n\nexport type PHPRuntime = any;\n\nexport type PHPLoaderModule = {\n\tdependencyFilename: string;\n\tdependenciesTotalSize: number;\n\tinit: (jsRuntime: string, options: EmscriptenOptions) => PHPRuntime;\n};\n\nexport type DataModule = {\n\tdependencyFilename: string;\n\tdependenciesTotalSize: number;\n\tdefault: (phpRuntime: PHPRuntime) => void;\n};\n\nexport type EmscriptenOptions = {\n\tonAbort?: (message: string) => void;\n\t/**\n\t * Set to true for debugging tricky WebAssembly errors.\n\t */\n\tdebug?: boolean;\n\tENV?: Record<string, string>;\n\tlocateFile?: (path: string) => string;\n\tnoInitialRun?: boolean;\n\tprint?: (message: string) => void;\n\tprintErr?: (message: string) => void;\n\tquit?: (status: number, toThrow: any) => void;\n\tonRuntimeInitialized?: (phpRuntime: PHPRuntime) => void;\n\tmonitorRunDependencies?: (left: number) => void;\n\tonMessage?: (listener: EmscriptenMessageListener) => void;\n\toutboundNetworkProxyServer?: Server<\n\t\ttypeof IncomingMessage,\n\t\ttypeof ServerResponse\n\t>;\n\tinstantiateWasm?: (\n\t\tinfo: WebAssembly.Imports,\n\t\treceiveInstance: (\n\t\t\tinstance: WebAssembly.Instance,\n\t\t\tmodule: WebAssembly.Module\n\t\t) => void\n\t) => void;\n} & Record<string, any>;\n\nexport type EmscriptenMessageListener = (type: string, data: string) => void;\n","/*\n * This type is used in Comlink.transferHandlers.set('PHPResponse', { ... })\n * so be sure to update that if you change this type.\n */\nexport interface PHPResponseData {\n\t/**\n\t * Response headers.\n\t */\n\treadonly headers: Record<string, string[]>;\n\n\t/**\n\t * Response body. Contains the output from `echo`,\n\t * `print`, inline HTML etc.\n\t */\n\treadonly bytes: Uint8Array;\n\n\t/**\n\t * Stderr contents, if any.\n\t */\n\treadonly errors: string;\n\n\t/**\n\t * The exit code of the script. `0` is a success, while\n\t * `1` and `2` indicate an error.\n\t */\n\treadonly exitCode: number;\n\n\t/**\n\t * Response HTTP status code, e.g. 200.\n\t */\n\treadonly httpStatusCode: number;\n}\n\nconst responseTexts: Record<number, string> = {\n\t500: 'Internal Server Error',\n\t502: 'Bad Gateway',\n\t404: 'Not Found',\n\t403: 'Forbidden',\n\t401: 'Unauthorized',\n\t400: 'Bad Request',\n\t301: 'Moved Permanently',\n\t302: 'Found',\n\t307: 'Temporary Redirect',\n\t308: 'Permanent Redirect',\n\t204: 'No Content',\n\t201: 'Created',\n\t200: 'OK',\n};\n\nexport class StreamedPHPResponse {\n\t/**\n\t * Response headers.\n\t */\n\tprivate readonly headersStream: ReadableStream<Uint8Array>;\n\n\t/**\n\t * Response body. Contains the output from `echo`,\n\t * `print`, inline HTML etc.\n\t */\n\treadonly stdout: ReadableStream<Uint8Array>;\n\n\t/**\n\t * Stderr contents, if any.\n\t */\n\treadonly stderr: ReadableStream<Uint8Array>;\n\n\t/**\n\t * The exit code of the script. `0` is a success, anything\n\t * else is an error.\n\t */\n\treadonly exitCode: Promise<number>;\n\n\tprivate parsedHeaders: Promise<{\n\t\theaders: Record<string, string[]>;\n\t\thttpStatusCode: number;\n\t}> | null = null;\n\n\tprivate cachedStdoutBytes: Promise<Uint8Array> | null = null;\n\tprivate cachedStderrText: Promise<string> | null = null;\n\n\tconstructor(\n\t\theaders: ReadableStream<Uint8Array>,\n\t\tstdout: ReadableStream<Uint8Array>,\n\t\tstderr: ReadableStream<Uint8Array>,\n\t\texitCode: Promise<number>\n\t) {\n\t\tthis.headersStream = headers;\n\t\tthis.stdout = stdout;\n\t\tthis.stderr = stderr;\n\t\tthis.exitCode = exitCode;\n\t}\n\n\t/**\n\t * True if the response is successful (HTTP status code 200-399),\n\t * false otherwise.\n\t */\n\tasync ok(): Promise<boolean> {\n\t\ttry {\n\t\t\tconst statusCode = await this.httpStatusCode;\n\t\t\treturn statusCode >= 200 && statusCode < 400;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Resolves when the response has finished processing – either successfully or not.\n\t */\n\tget finished(): Promise<void> {\n\t\treturn Promise.allSettled([this.exitCode.finally(() => {})]).then(\n\t\t\t() => {}\n\t\t);\n\t}\n\n\t/**\n\t * Resolves once HTTP headers are available.\n\t */\n\tget headers(): Promise<Record<string, string[]>> {\n\t\treturn this.getParsedHeaders().then((headers) => headers.headers);\n\t}\n\n\t/**\n\t * Resolves once HTTP status code is available.\n\t */\n\tget httpStatusCode(): Promise<number> {\n\t\treturn this.getParsedHeaders()\n\t\t\t.then((headers) => headers.httpStatusCode)\n\t\t\t.then((result) => {\n\t\t\t\tif (result !== undefined) {\n\t\t\t\t\treturn result;\n\t\t\t\t}\n\t\t\t\t// If exit code is 0 or not available yet, fall back to parsed headers\n\t\t\t\treturn this.getParsedHeaders().then(\n\t\t\t\t\t(headers) => headers.httpStatusCode,\n\t\t\t\t\t() => 200\n\t\t\t\t);\n\t\t\t})\n\t\t\t.catch(() => 500);\n\t}\n\n\t/**\n\t * Exposes the stdout bytes as they're produced by the PHP instance\n\t */\n\tget stdoutText(): Promise<string> {\n\t\treturn this.stdoutBytes.then((bytes) =>\n\t\t\tnew TextDecoder().decode(bytes)\n\t\t);\n\t}\n\n\t/**\n\t * Exposes the stdout bytes as they're produced by the PHP instance\n\t */\n\tget stdoutBytes(): Promise<Uint8Array> {\n\t\tif (!this.cachedStdoutBytes) {\n\t\t\tthis.cachedStdoutBytes = streamToBytes(this.stdout);\n\t\t}\n\t\treturn this.cachedStdoutBytes;\n\t}\n\n\t/**\n\t * Exposes the stderr bytes as they're produced by the PHP instance\n\t */\n\tget stderrText(): Promise<string> {\n\t\tif (!this.cachedStderrText) {\n\t\t\tthis.cachedStderrText = streamToText(this.stderr);\n\t\t}\n\t\treturn this.cachedStderrText;\n\t}\n\n\tprivate async getParsedHeaders() {\n\t\tif (!this.parsedHeaders) {\n\t\t\tthis.parsedHeaders = parseHeadersStream(this.headersStream);\n\t\t}\n\t\treturn await this.parsedHeaders;\n\t}\n}\n\nasync function parseHeadersStream(\n\theadersStream: ReadableStream<Uint8Array>\n): Promise<{\n\theaders: Record<string, string[]>;\n\thttpStatusCode: number;\n}> {\n\tconst headersText = await streamToText(headersStream);\n\tlet headersData;\n\ttry {\n\t\theadersData = JSON.parse(headersText);\n\t} catch {\n\t\treturn { headers: {}, httpStatusCode: 200 };\n\t}\n\tconst headers: PHPResponse['headers'] = {};\n\tfor (const line of headersData.headers) {\n\t\t// Skip invalid response headers and the last \"__terminator__\" line.\n\t\t// @TODO: Should we log a warning on an invalid header line?\n\t\t//        What's the typical browser behavior when encountering such a line?\n\t\tif (!line.includes(': ')) {\n\t\t\tcontinue;\n\t\t}\n\t\tconst colonIndex = line.indexOf(': ');\n\t\tconst headerName = line.substring(0, colonIndex).toLowerCase();\n\t\tconst headerValue = line.substring(colonIndex + 2);\n\t\tif (!(headerName in headers)) {\n\t\t\theaders[headerName] = [] as string[];\n\t\t}\n\t\theaders[headerName].push(headerValue);\n\t}\n\treturn {\n\t\theaders,\n\t\thttpStatusCode: headersData.status,\n\t};\n}\n\nasync function streamToText(\n\tstream: ReadableStream<Uint8Array>\n): Promise<string> {\n\tconst reader = (stream as ReadableStream<BufferSource>)\n\t\t.pipeThrough(new TextDecoderStream())\n\t\t.getReader();\n\tconst text: string[] = [];\n\twhile (true) {\n\t\tconst { done, value } = await reader.read();\n\t\tif (done) {\n\t\t\treturn text.join('');\n\t\t}\n\t\tif (value) {\n\t\t\ttext.push(value);\n\t\t}\n\t}\n}\n\nasync function streamToBytes(\n\tstream: ReadableStream<Uint8Array>\n): Promise<Uint8Array> {\n\tconst reader = stream.getReader();\n\tconst chunks: Uint8Array[] = [];\n\n\twhile (true) {\n\t\tconst { done, value } = await reader.read();\n\t\tif (done) {\n\t\t\tconst totalLength = chunks.reduce(\n\t\t\t\t(acc, chunk) => acc + chunk.byteLength,\n\t\t\t\t0\n\t\t\t);\n\t\t\tconst result = new Uint8Array(totalLength);\n\t\t\tlet offset = 0;\n\t\t\tfor (const chunk of chunks) {\n\t\t\t\tresult.set(chunk, offset);\n\t\t\t\toffset += chunk.byteLength;\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\t\tif (value) {\n\t\t\tchunks.push(value);\n\t\t}\n\t}\n}\n\n/**\n * PHP response. Body is an `ArrayBuffer` because it can\n * contain binary data.\n *\n * This type is used in Comlink.transferHandlers.set('PHPResponse', \\{ ... \\})\n * so be sure to update that if you change this type.\n */\nexport class PHPResponse implements PHPResponseData {\n\t/** @inheritDoc */\n\treadonly headers: Record<string, string[]>;\n\n\t/** @inheritDoc */\n\treadonly bytes: Uint8Array;\n\n\t/** @inheritDoc */\n\treadonly errors: string;\n\n\t/** @inheritDoc */\n\treadonly exitCode: number;\n\n\t/** @inheritDoc */\n\treadonly httpStatusCode: number;\n\n\tconstructor(\n\t\thttpStatusCode: number,\n\t\theaders: Record<string, string[]>,\n\t\tbody: Uint8Array,\n\t\terrors = '',\n\t\texitCode = 0\n\t) {\n\t\tthis.httpStatusCode = httpStatusCode;\n\t\tthis.headers = headers;\n\t\tthis.bytes = body;\n\t\tthis.exitCode = exitCode;\n\t\tthis.errors = errors;\n\t}\n\n\tstatic forHttpCode(httpStatusCode: number, text = '') {\n\t\treturn new PHPResponse(\n\t\t\thttpStatusCode,\n\t\t\t{},\n\t\t\tnew TextEncoder().encode(\n\t\t\t\ttext || responseTexts[httpStatusCode] || ''\n\t\t\t)\n\t\t);\n\t}\n\n\tstatic fromRawData(data: PHPResponseData): PHPResponse {\n\t\treturn new PHPResponse(\n\t\t\tdata.httpStatusCode,\n\t\t\tdata.headers,\n\t\t\tdata.bytes,\n\t\t\tdata.errors,\n\t\t\tdata.exitCode\n\t\t);\n\t}\n\n\tstatic async fromStreamedResponse(\n\t\tstreamedResponse: StreamedPHPResponse\n\t): Promise<PHPResponse> {\n\t\tawait streamedResponse.finished;\n\t\treturn new PHPResponse(\n\t\t\tawait streamedResponse.httpStatusCode,\n\t\t\tawait streamedResponse.headers,\n\t\t\tawait streamedResponse.stdoutBytes,\n\t\t\tawait streamedResponse.stderrText,\n\t\t\tawait streamedResponse.exitCode\n\t\t);\n\t}\n\n\t/**\n\t * True if the response is successful (HTTP status code 200-399),\n\t * false otherwise.\n\t */\n\tok(): boolean {\n\t\treturn this.httpStatusCode >= 200 && this.httpStatusCode < 400;\n\t}\n\n\ttoRawData(): PHPResponseData {\n\t\treturn {\n\t\t\theaders: this.headers,\n\t\t\tbytes: this.bytes,\n\t\t\terrors: this.errors,\n\t\t\texitCode: this.exitCode,\n\t\t\thttpStatusCode: this.httpStatusCode,\n\t\t};\n\t}\n\n\t/**\n\t * Response body as JSON.\n\t */\n\tget json() {\n\t\treturn JSON.parse(this.text);\n\t}\n\n\t/**\n\t * Response body as text.\n\t */\n\tget text() {\n\t\treturn new TextDecoder().decode(this.bytes);\n\t}\n}\n","/**\n * Polyfill for ReadableStream[Symbol.asyncIterator]\n * This enables the use of for-await-of loops with ReadableStreams\n *\n * @example\n * ```ts\n * for await (const entry of stream) {\n * \t   // ...\n * }\n * ```\n */\n// @ts-ignore\nif (!ReadableStream.prototype[Symbol.asyncIterator]) {\n\t// @ts-ignore\n\tReadableStream.prototype[Symbol.asyncIterator] = async function* () {\n\t\tconst reader = this.getReader();\n\t\ttry {\n\t\t\twhile (true) {\n\t\t\t\tconst { done, value } = await reader.read();\n\t\t\t\tif (done) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tyield value;\n\t\t\t}\n\t\t} finally {\n\t\t\treader.releaseLock();\n\t\t}\n\t};\n\t// @ts-ignore\n\tReadableStream.prototype.iterate =\n\t\t// @ts-ignore\n\t\tReadableStream.prototype[Symbol.asyncIterator];\n}\n\nexport type IterableReadableStream<R> = ReadableStream<R> & AsyncIterable<R>;\n","import { Semaphore } from '@php-wasm/util';\nimport { filterStream } from '../utils/filter-stream';\nimport { concatUint8Array } from '../utils/concat-uint8-array';\nimport { collectBytes } from '../utils/collect-bytes';\nimport {\n\treadCentralDirectoryEntry,\n\treadFileEntry,\n\tdecodeZip,\n} from './decode-zip';\nimport type { CentralDirectoryEntry, FileEntry } from './types';\nimport { SIGNATURE_CENTRAL_DIRECTORY_END } from './types';\nimport type { IterableReadableStream } from '../utils/iterable-stream-polyfill';\n\nconst CENTRAL_DIRECTORY_END_SCAN_CHUNK_SIZE = 110 * 1024;\nconst BATCH_DOWNLOAD_OF_FILES_IF_CLOSER_THAN = 10 * 1024;\nconst PREFER_RANGES_IF_FILE_LARGER_THAN = 1024 * 1024 * 1;\nconst fetchSemaphore = new Semaphore({ concurrency: 10 });\n\nconst DEFAULT_PREDICATE = () => true;\n\n/**\n * Streams the contents of a remote zip file.\n *\n * If the zip is large and the predicate is filtering the zip contents,\n * only the matching files will be downloaded using the Range header\n * (if supported by the server).\n *\n * @param url The URL of the zip file.\n * @param predicate Optional. A function that returns true if the file should be downloaded.\n * @returns A stream of zip entries.\n */\nexport async function decodeRemoteZip(\n\turl: string,\n\tpredicate: (\n\t\tdirEntry: CentralDirectoryEntry | FileEntry\n\t) => boolean = DEFAULT_PREDICATE\n) {\n\tif (predicate === DEFAULT_PREDICATE) {\n\t\t// If we're not filtering the zip contents, let's just\n\t\t// grab the entire zip.\n\t\tconst response = await fetch(url);\n\t\treturn decodeZip(response.body!);\n\t}\n\n\tconst contentLength = await fetchContentLength(url);\n\tif (contentLength <= PREFER_RANGES_IF_FILE_LARGER_THAN) {\n\t\t// If the zip is small enough, let's just grab it.\n\t\tconst response = await fetch(url);\n\t\treturn decodeZip(response.body!);\n\t}\n\n\t// Ensure ranges query support:\n\t// Fetch one byte\n\tconst response = await fetch(url, {\n\t\theaders: {\n\t\t\t// 0-0 looks weird, doesn't it?\n\t\t\t// The Range header is inclusive so it's actually\n\t\t\t// a valid header asking for the first byte.\n\t\t\tRange: 'bytes=0-0',\n\t\t\t'Accept-Encoding': 'none',\n\t\t},\n\t});\n\n\t// Fork the stream so that we can reuse it in case\n\t// the Range header is unsupported and we're now streaming\n\t// the entire file\n\tconst [peekStream, responseStream] = response.body!.tee();\n\n\t// Read from the forked stream and close it.\n\tconst peekReader = peekStream.getReader();\n\tconst { value: peekBytes } = await peekReader.read();\n\tconst { done: peekDone } = await peekReader.read();\n\tpeekReader.releaseLock();\n\tpeekStream.cancel();\n\n\t// Confirm our Range query worked as intended:\n\tconst rangesSupported = peekBytes?.length === 1 && peekDone;\n\tif (!rangesSupported) {\n\t\t// Uh-oh, we're actually streaming the entire file.\n\t\t// Let's reuse the forked stream as our response stream.\n\t\treturn decodeZip(responseStream);\n\t}\n\n\t// We're good, let's clean up the other branch of the response stream.\n\tresponseStream.cancel();\n\tconst source = await createFetchSource(url, contentLength);\n\treturn streamCentralDirectoryEntries(source)\n\t\t.pipeThrough(filterStream(predicate))\n\t\t.pipeThrough(partitionNearbyEntries())\n\t\t.pipeThrough(\n\t\t\tfetchPartitionedEntries(source)\n\t\t) as IterableReadableStream<FileEntry>;\n}\n\n/**\n * Streams the central directory entries of a zip file.\n *\n * @param source\n * @returns\n */\nfunction streamCentralDirectoryEntries(source: BytesSource) {\n\tlet centralDirectoryStream: ReadableStream<Uint8Array>;\n\n\treturn new ReadableStream<CentralDirectoryEntry>({\n\t\tasync start() {\n\t\t\tcentralDirectoryStream = await streamCentralDirectoryBytes(source);\n\t\t},\n\t\tasync pull(controller) {\n\t\t\tconst entry = await readCentralDirectoryEntry(\n\t\t\t\tcentralDirectoryStream\n\t\t\t);\n\t\t\tif (!entry) {\n\t\t\t\tcontroller.close();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tcontroller.enqueue(entry);\n\t\t},\n\t});\n}\n\n/**\n * Streams the central directory bytes of a zip file.\n *\n * @param source\n * @returns\n */\nasync function streamCentralDirectoryBytes(source: BytesSource) {\n\tconst chunkSize = CENTRAL_DIRECTORY_END_SCAN_CHUNK_SIZE;\n\tlet centralDirectory: Uint8Array = new Uint8Array();\n\n\tlet chunkStart = source.length;\n\tdo {\n\t\tchunkStart = Math.max(0, chunkStart - chunkSize);\n\t\tconst chunkEnd = Math.min(\n\t\t\tchunkStart + chunkSize - 1,\n\t\t\tsource.length - 1\n\t\t);\n\t\tconst bytes = await collectBytes(\n\t\t\tawait source.streamBytes(chunkStart, chunkEnd)\n\t\t);\n\t\tcentralDirectory = concatUint8Array(bytes!, centralDirectory);\n\n\t\t// Scan the buffer for the signature\n\t\tconst view = new DataView(bytes!.buffer);\n\t\tfor (let i = view.byteLength - 4; i >= 0; i--) {\n\t\t\tif (view.getUint32(i, true) !== SIGNATURE_CENTRAL_DIRECTORY_END) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// Confirm we have enough data to read the offset and the\n\t\t\t// length of the central directory.\n\t\t\tconst centralDirectoryLengthAt = i + 12;\n\t\t\tconst centralDirectoryOffsetAt = centralDirectoryLengthAt + 4;\n\t\t\tif (centralDirectory.byteLength < centralDirectoryOffsetAt + 4) {\n\t\t\t\tthrow new Error('Central directory not found');\n\t\t\t}\n\n\t\t\t// Read where the central directory starts\n\t\t\tconst dirStart = view.getUint32(centralDirectoryOffsetAt, true);\n\t\t\tif (dirStart < chunkStart) {\n\t\t\t\t// We're missing some bytes, let's grab them\n\t\t\t\tconst missingBytes = await collectBytes(\n\t\t\t\t\tawait source.streamBytes(dirStart, chunkStart - 1)\n\t\t\t\t);\n\t\t\t\tcentralDirectory = concatUint8Array(\n\t\t\t\t\tmissingBytes!,\n\t\t\t\t\tcentralDirectory\n\t\t\t\t);\n\t\t\t} else if (dirStart > chunkStart) {\n\t\t\t\t// We've read too many bytes, let's trim them\n\t\t\t\tcentralDirectory = centralDirectory.slice(\n\t\t\t\t\tdirStart - chunkStart\n\t\t\t\t);\n\t\t\t}\n\t\t\treturn new Blob([centralDirectory]).stream();\n\t\t}\n\t} while (chunkStart >= 0);\n\n\tthrow new Error('Central directory not found');\n}\n\n/**\n * Partitions files that are no further apart in the zip\n * archive than BATCH_DOWNLOAD_OF_FILES_IF_CLOSER_THAN.\n * It may download some extra files living within the gaps\n * between the partitions.\n */\nfunction partitionNearbyEntries() {\n\tlet lastFileEndsAt = 0;\n\tlet currentChunk: CentralDirectoryEntry[] = [];\n\treturn new TransformStream<CentralDirectoryEntry, CentralDirectoryEntry[]>({\n\t\ttransform(zipEntry, controller) {\n\t\t\t// Byte distance too large, flush and start a new chunk\n\t\t\tif (\n\t\t\t\tzipEntry.firstByteAt >\n\t\t\t\tlastFileEndsAt + BATCH_DOWNLOAD_OF_FILES_IF_CLOSER_THAN\n\t\t\t) {\n\t\t\t\tcontroller.enqueue(currentChunk);\n\t\t\t\tcurrentChunk = [];\n\t\t\t}\n\t\t\tlastFileEndsAt = zipEntry.lastByteAt;\n\t\t\tcurrentChunk.push(zipEntry);\n\t\t},\n\t\tflush(controller) {\n\t\t\tcontroller.enqueue(currentChunk);\n\t\t},\n\t});\n}\n\n/**\n * Fetches a chunk of files from the zip archive.\n *\n * If any extra files are present in the received\n * bytes stream, they are filtered out.\n */\nfunction fetchPartitionedEntries(\n\tsource: BytesSource\n): ReadableWritablePair<FileEntry, CentralDirectoryEntry[]> {\n\t/**\n\t * This function implements a ReadableStream and a WritableStream\n\t * instead of a TransformStream. This is intentional.\n\t *\n\t * In TransformStream, the `transform` function may return a\n\t * promise. The next call to `transform` will be delayed until\n\t * the promise resolves. This is a problem for us because we\n\t * want to issue many fetch() requests in parallel.\n\t *\n\t * The only way to do that seems to be creating separate ReadableStream\n\t * and WritableStream implementations.\n\t */\n\tlet isWritableClosed = false;\n\tlet requestsInProgress = 0;\n\tlet readableController: ReadableStreamDefaultController<FileEntry>;\n\tconst byteStreams: Array<\n\t\t[CentralDirectoryEntry[], ReadableStream<Uint8Array>]\n\t> = [];\n\t/**\n\t * Receives chunks of CentralDirectoryEntries, and fetches\n\t * the corresponding byte ranges from the remote zip file.\n\t */\n\tconst writable = new WritableStream<CentralDirectoryEntry[]>({\n\t\twrite(zipEntries, controller) {\n\t\t\tif (!zipEntries.length) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t++requestsInProgress;\n\t\t\t// If the write() method returns a promise, the next\n\t\t\t// call will be delayed until the promise resolves.\n\t\t\t// Let's not return the promise, then.\n\t\t\t// This will effectively issue many requests in parallel.\n\t\t\trequestChunkRange(source, zipEntries)\n\t\t\t\t.then((byteStream) => {\n\t\t\t\t\tbyteStreams.push([zipEntries, byteStream]);\n\t\t\t\t})\n\t\t\t\t.catch((e) => {\n\t\t\t\t\tcontroller.error(e);\n\t\t\t\t})\n\t\t\t\t.finally(() => {\n\t\t\t\t\t--requestsInProgress;\n\t\t\t\t});\n\t\t},\n\t\tabort() {\n\t\t\tisWritableClosed = true;\n\t\t\treadableController.close();\n\t\t},\n\t\tasync close() {\n\t\t\tisWritableClosed = true;\n\t\t},\n\t});\n\t/**\n\t * Decodes zipped bytes into FileEntry objects.\n\t */\n\tconst readable = new ReadableStream<FileEntry>({\n\t\tstart(controller) {\n\t\t\treadableController = controller;\n\t\t},\n\t\tasync pull(controller) {\n\t\t\twhile (true) {\n\t\t\t\tconst allChunksProcessed =\n\t\t\t\t\tisWritableClosed &&\n\t\t\t\t\t!byteStreams.length &&\n\t\t\t\t\trequestsInProgress === 0;\n\t\t\t\tif (allChunksProcessed) {\n\t\t\t\t\tcontroller.close();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// There's no bytes available, but the writable\n\t\t\t\t// stream is still open or there are still requests\n\t\t\t\t// in progress. Let's wait for more bytes.\n\t\t\t\tconst waitingForMoreBytes = !byteStreams.length;\n\t\t\t\tif (waitingForMoreBytes) {\n\t\t\t\t\tawait new Promise((resolve) => setTimeout(resolve, 50));\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst [requestedPaths, stream] = byteStreams[0];\n\t\t\t\tconst file = await readFileEntry(stream);\n\t\t\t\t// The stream is exhausted, let's remove it from the queue\n\t\t\t\t// and try the next one.\n\t\t\t\tconst streamExhausted = !file;\n\t\t\t\tif (streamExhausted) {\n\t\t\t\t\tbyteStreams.shift();\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// There may be some extra files between the ones we're\n\t\t\t\t// interested in. Let's filter out any files that got\n\t\t\t\t// intertwined in the byte stream.\n\t\t\t\tconst isOneOfRequestedPaths = requestedPaths.find(\n\t\t\t\t\t(entry) => entry.path === file.path\n\t\t\t\t);\n\t\t\t\tif (!isOneOfRequestedPaths) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Finally! We've got a file we're interested in.\n\t\t\t\tcontroller.enqueue(file);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t},\n\t});\n\n\treturn {\n\t\treadable,\n\t\twritable,\n\t};\n}\n\n/**\n * Requests a chunk of bytes from the bytes source.\n *\n * @param source\n * @param zipEntries\n */\nasync function requestChunkRange(\n\tsource: BytesSource,\n\tzipEntries: CentralDirectoryEntry[]\n) {\n\tconst release = await fetchSemaphore.acquire();\n\ttry {\n\t\tconst lastZipEntry = zipEntries[zipEntries.length - 1];\n\t\tconst substream = await source.streamBytes(\n\t\t\tzipEntries[0].firstByteAt,\n\t\t\tlastZipEntry.lastByteAt\n\t\t);\n\t\treturn substream;\n\t} finally {\n\t\trelease();\n\t}\n}\n\n/**\n * Fetches the Content-Length header from a remote URL.\n */\nasync function fetchContentLength(url: string) {\n\treturn await fetch(url, { method: 'HEAD' })\n\t\t.then((response) => response.headers.get('Content-Length'))\n\t\t.then((contentLength) => {\n\t\t\tif (!contentLength) {\n\t\t\t\tthrow new Error('Content-Length header is missing');\n\t\t\t}\n\n\t\t\tconst parsedLength = parseInt(contentLength, 10);\n\t\t\tif (isNaN(parsedLength) || parsedLength < 0) {\n\t\t\t\tthrow new Error('Content-Length header is invalid');\n\t\t\t}\n\t\t\treturn parsedLength;\n\t\t});\n}\n\n/**\n * Private and experimental API: Range-based data sources.\n *\n * The idea is that if we can read arbitrary byte ranges from\n * a file, we can retrieve a specific subset of a zip file.\n */\ntype BytesSource = {\n\tlength: number;\n\tstreamBytes: (\n\t\tstart: number,\n\t\tend: number\n\t) => Promise<ReadableStream<Uint8Array>>;\n};\n\n/**\n * Creates a BytesSource enabling fetching ranges of bytes\n * from a remote URL.\n */\nasync function createFetchSource(\n\turl: string,\n\tcontentLength?: number\n): Promise<BytesSource> {\n\tif (contentLength === undefined) {\n\t\tcontentLength = await fetchContentLength(url);\n\t}\n\n\treturn {\n\t\tlength: contentLength,\n\t\tstreamBytes: async (from: number, to: number) =>\n\t\t\tawait fetch(url, {\n\t\t\t\theaders: {\n\t\t\t\t\t// The Range header is inclusive, so we need to subtract 1\n\t\t\t\t\tRange: `bytes=${from}-${to - 1}`,\n\t\t\t\t\t'Accept-Encoding': 'none',\n\t\t\t\t},\n\t\t\t}).then((response) => response.body!),\n\t};\n}\n","/* eslint-disable @typescript-eslint/no-unsafe-function-type */\n/* eslint-disable @typescript-eslint/no-misused-new */\n/* eslint-disable @typescript-eslint/no-empty-object-type */\nimport type { MessagePort as NodeMessagePort } from 'worker_threads';\n\n/**\n * Comlink library protocol extension to use synchronous messaging.\n *\n * Debugging Asyncify is too much of a burden. This extension enables exchanging\n * messages between threads synchronously so that we don't need to rely on Asyncify.\n *\n * Upsides:\n *\n * * Saves dozens-to-hundreds of hours on debugging Asyncify issues\n * * Increased reliability\n * * Useful stack traces when errors do happen.\n *\n * Downsides:\n *\n * * Fragmentation: Both synchronous and asynchronous handlers exist to get the best our of both\n * Asyncify and JSPI. * Node.js-only: This extension does not implement a Safari-friendly\n * transport. SharedArrayBuffer is an option, but\n *                 it requires more restrictive CORP+COEP headers which breaks, e.g., YouTube\n *                 embeds. Synchronous XHR might work if we really need Safari support for one of\n *                 the new asynchronous features, but other than that let's just skip adding new\n *                 asynchronous WASM features to Safari until WebKit supports stack switching.\n * * Message passing between workers is slow. Avoid using synchronous messaging for syscalls that\n * are invoked frequently and\n *   handled asynchronously in the same worker.\n *\n * @see https://github.com/adamziel/js-synchronous-messaging for additional ideas.\n * @see https://github.com/WordPress/wordpress-playground/blob/9a9262cc62cc161d220a9992706b9ed2817f2eb5/packages/docs/site/docs/developers/23-architecture/07-wasm-asyncify.md\n */\ninterface SyncMessage {\n\t/** original Comlink envelope            */\n\tid?: string;\n\ttype: MessageType;\n\t/** existing Comlink fields …            */\n\t[k: string]: any;\n\t/** new part that carries the latch      */\n\tnotifyBuffer?: SharedArrayBuffer;\n}\n\ninterface SyncTransport {\n\tafterResponseSent(ev: MessageEvent): void;\n\tsend(\n\t\tep: IsomorphicMessagePort,\n\t\tmsg: Omit<SyncMessage, 'id' | 'notifyBuffer'>,\n\t\ttransferables?: Transferable[]\n\t): WireValue;\n}\n\nexport function exposeSync(\n\tobj: any,\n\tep: Endpoint,\n\ttransport: SyncTransport,\n\tallowedOrigins: (string | RegExp)[] = ['*']\n) {\n\treturn expose(obj, ep, allowedOrigins, transport.afterResponseSent);\n}\n\n//////////////////////////////\n// 3. Consumer side         //\n//////////////////////////////\n\nfunction createSyncProxy<T>(\n\tep: IsomorphicMessagePort,\n\tpath: (string | number | symbol)[] = [],\n\ttransport: SyncTransport\n): T {\n\treturn new Proxy(() => {}, {\n\t\tget(_t, prop) {\n\t\t\tif (prop === 'then') {\n\t\t\t\t// allow await‑usage without deadlocking\n\t\t\t\tif (!path.length)\n\t\t\t\t\treturn {\n\t\t\t\t\t\tthen: (_: any, res: any) =>\n\t\t\t\t\t\t\tres(createSyncProxy(ep, [], transport)),\n\t\t\t\t\t};\n\t\t\t}\n\t\t\treturn createSyncProxy(ep, [...path, prop], transport);\n\t\t},\n\n\t\tset(_t, prop, value) {\n\t\t\tconst [v, xfer] = toWireValue(value);\n\t\t\ttransport.send(\n\t\t\t\tep,\n\t\t\t\t{\n\t\t\t\t\ttype: MessageType.SET,\n\t\t\t\t\tpath: [...path, prop].map(String),\n\t\t\t\t\tvalue: v,\n\t\t\t\t},\n\t\t\t\txfer\n\t\t\t);\n\t\t\treturn true;\n\t\t},\n\n\t\tapply(_t, _thisArg, rawArgs) {\n\t\t\t// Special cases\n\t\t\tconst last = path.at(-1);\n\t\t\tif (last === 'bind')\n\t\t\t\treturn createSyncProxy(ep, path.slice(0, -1), transport);\n\n\t\t\tconst [argList, xfer] = processArguments(rawArgs);\n\t\t\tconst wire = transport.send(\n\t\t\t\tep,\n\t\t\t\t{\n\t\t\t\t\ttype: MessageType.APPLY,\n\t\t\t\t\tpath: path.map(String),\n\t\t\t\t\targumentList: argList,\n\t\t\t\t},\n\t\t\t\txfer\n\t\t\t);\n\n\t\t\treturn fromWireValue(wire);\n\t\t},\n\n\t\tconstruct(_t, rawArgs) {\n\t\t\tconst [argList, xfer] = processArguments(rawArgs);\n\t\t\tconst wire = transport.send(\n\t\t\t\tep,\n\t\t\t\t{\n\t\t\t\t\ttype: MessageType.CONSTRUCT,\n\t\t\t\t\tpath: path.map(String),\n\t\t\t\t\targumentList: argList,\n\t\t\t\t},\n\t\t\t\txfer\n\t\t\t);\n\t\t\treturn fromWireValue(wire);\n\t\t},\n\t}) as unknown as T;\n}\n\nexport function wrapSync<T>(\n\tep: IsomorphicMessagePort,\n\ttransport: SyncTransport\n): T {\n\treturn createSyncProxy<T>(ep, [], transport);\n}\n\n/// Transport ///\n\nexport type IsomorphicMessagePort = MessagePort | NodeMessagePort;\n\nexport class NodeSABSyncReceiveMessageTransport {\n\tprivate static receiveMessageOnPort: any;\n\n\tstatic async create() {\n\t\tif (!NodeSABSyncReceiveMessageTransport.receiveMessageOnPort) {\n\t\t\ttry {\n\t\t\t\tNodeSABSyncReceiveMessageTransport.receiveMessageOnPort =\n\t\t\t\t\trequire('worker_threads').receiveMessageOnPort;\n\t\t\t} catch {\n\t\t\t\tNodeSABSyncReceiveMessageTransport.receiveMessageOnPort =\n\t\t\t\t\tawait import('worker_threads').then(\n\t\t\t\t\t\t(m) => m.receiveMessageOnPort\n\t\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\treturn new NodeSABSyncReceiveMessageTransport();\n\t}\n\n\tprivate constructor() {}\n\n\tafterResponseSent(ev: MessageEvent) {\n\t\tconst { notifyBuffer } = ev.data as SyncMessage;\n\t\tif (notifyBuffer) {\n\t\t\tconst view = new Int32Array(notifyBuffer);\n\t\t\tview[0] = 1;\n\t\t\tAtomics.notify(view, 0);\n\t\t}\n\t}\n\tsend(\n\t\tep: IsomorphicMessagePort,\n\t\tmsg: Omit<SyncMessage, 'id' | 'notifyBuffer'>,\n\t\ttransferables?: Transferable[]\n\t): WireValue {\n\t\t// SharedArrayBuffer = one 32‑bit cell that starts at 0.\n\t\t// The other worker will set this to 1 when it has sent the response.\n\t\tconst latch = new SharedArrayBuffer(4);\n\t\tconst view = new Int32Array(latch);\n\t\tview[0] = 0;\n\n\t\tconst id = generateUUID();\n\t\tep.postMessage(\n\t\t\t{ ...msg, id, notifyBuffer: latch },\n\t\t\ttransferables as any\n\t\t);\n\n\t\t// Synchronous pull; Node.js-only. Browsers don't support receiveMessageOnPort.\n\t\tconst timeoutMs = 5000;\n\t\tconst result = Atomics.wait(view, 0, 0, timeoutMs);\n\t\tif (result === 'timed-out') {\n\t\t\tthrow new Error('Timeout waiting for response');\n\t\t}\n\t\twhile (true) {\n\t\t\tconst res =\n\t\t\t\tNodeSABSyncReceiveMessageTransport.receiveMessageOnPort(ep);\n\t\t\tif (res.message?.id === id) {\n\t\t\t\treturn res.message;\n\t\t\t} else if (!res) {\n\t\t\t\tthrow new Error('No response received');\n\t\t\t}\n\t\t}\n\t}\n}\n\n/**\n * Original, unmodified Comlink library from Google:\n *\n * @license\n * Copyright 2019 Google LLC\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport const proxyMarker = Symbol('Comlink.proxy');\nexport const createEndpoint = Symbol('Comlink.endpoint');\nexport const releaseProxy = Symbol('Comlink.releaseProxy');\nexport const finalizer = Symbol('Comlink.finalizer');\n\nconst throwMarker = Symbol('Comlink.thrown');\n\n/**\n * @license\n * Copyright 2019 Google LLC\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport interface EventSource {\n\taddEventListener(\n\t\ttype: string,\n\t\tlistener: EventListenerOrEventListenerObject,\n\t\toptions?: object\n\t): void;\n\n\tremoveEventListener(\n\t\ttype: string,\n\t\tlistener: EventListenerOrEventListenerObject,\n\t\toptions?: object\n\t): void;\n}\n\nexport interface PostMessageWithOrigin {\n\tpostMessage(\n\t\tmessage: any,\n\t\ttargetOrigin: string,\n\t\ttransfer?: Transferable[]\n\t): void;\n}\n\nexport interface Endpoint extends EventSource {\n\tpostMessage(message: any, transfer?: Transferable[]): void;\n\n\tstart?: () => void;\n}\n\nexport const WireValueType = {\n\tRAW: 'RAW',\n\tPROXY: 'PROXY',\n\tTHROW: 'THROW',\n\tHANDLER: 'HANDLER',\n} as const;\n\nexport type WireValueType = typeof WireValueType;\n\nexport interface RawWireValue {\n\tid?: string;\n\ttype: WireValueType['RAW'];\n\tvalue: any;\n}\n\nexport interface HandlerWireValue {\n\tid?: string;\n\ttype: WireValueType['HANDLER'];\n\tname: string;\n\tvalue: unknown;\n}\n\nexport type WireValue = RawWireValue | HandlerWireValue;\n\nexport type MessageID = string;\n\nexport const MessageType = {\n\tGET: 'GET',\n\tSET: 'SET',\n\tAPPLY: 'APPLY',\n\tCONSTRUCT: 'CONSTRUCT',\n\tENDPOINT: 'ENDPOINT',\n\tRELEASE: 'RELEASE',\n} as const;\nexport type MessageType = typeof MessageType;\n\nexport interface GetMessage {\n\tid?: MessageID;\n\ttype: MessageType['GET'];\n\tpath: string[];\n}\n\nexport interface SetMessage {\n\tid?: MessageID;\n\ttype: MessageType['SET'];\n\tpath: string[];\n\tvalue: WireValue;\n}\n\nexport interface ApplyMessage {\n\tid?: MessageID;\n\ttype: MessageType['APPLY'];\n\tpath: string[];\n\targumentList: WireValue[];\n}\n\nexport interface ConstructMessage {\n\tid?: MessageID;\n\ttype: MessageType['CONSTRUCT'];\n\tpath: string[];\n\targumentList: WireValue[];\n}\n\nexport interface EndpointMessage {\n\tid?: MessageID;\n\ttype: MessageType['ENDPOINT'];\n}\n\nexport interface ReleaseMessage {\n\tid?: MessageID;\n\ttype: MessageType['RELEASE'];\n}\n\nexport type Message =\n\t| GetMessage\n\t| SetMessage\n\t| ApplyMessage\n\t| ConstructMessage\n\t| EndpointMessage\n\t| ReleaseMessage;\n\n/**\n * Interface of values that were marked to be proxied with `comlink.proxy()`.\n * Can also be implemented by classes.\n */\nexport interface ProxyMarked {\n\t[proxyMarker]: true;\n}\n\n/**\n * Takes a type and wraps it in a Promise, if it not already is one.\n * This is to avoid `Promise<Promise<T>>`.\n *\n * This is the inverse of `Unpromisify<T>`.\n */\ntype Promisify<T> = T extends Promise<unknown> ? T : Promise<T>;\n/**\n * Takes a type that may be Promise and unwraps the Promise type.\n * If `P` is not a Promise, it returns `P`.\n *\n * This is the inverse of `Promisify<T>`.\n */\ntype Unpromisify<P> = P extends Promise<infer T> ? T : P;\n\n/**\n * Takes the raw type of a remote property and returns the type that is visible to the local thread\n * on the proxy.\n *\n * Note: This needs to be its own type alias, otherwise it will not distribute over unions.\n * See https://www.typescriptlang.org/docs/handbook/advanced-types.html#distributive-conditional-types\n */\ntype RemoteProperty<T> =\n\t// If the value is a method, comlink will proxy it automatically.\n\t// Objects are only proxied if they are marked to be proxied.\n\t// Otherwise, the property is converted to a Promise that resolves the cloned value.\n\tT extends Function | ProxyMarked ? Remote<T> : Promisify<T>;\n\n/**\n * Takes the raw type of a property as a remote thread would see it through a proxy (e.g. when\n * passed in as a function argument) and returns the type that the local thread has to supply.\n *\n * This is the inverse of `RemoteProperty<T>`.\n *\n * Note: This needs to be its own type alias, otherwise it will not distribute over unions. See\n * https://www.typescriptlang.org/docs/handbook/advanced-types.html#distributive-conditional-types\n */\ntype LocalProperty<T> = T extends Function | ProxyMarked\n\t? Local<T>\n\t: Unpromisify<T>;\n\n/**\n * Proxies `T` if it is a `ProxyMarked`, clones it otherwise (as handled by structured cloning and\n * transfer handlers).\n */\nexport type ProxyOrClone<T> = T extends ProxyMarked ? Remote<T> : T;\n/**\n * Inverse of `ProxyOrClone<T>`.\n */\nexport type UnproxyOrClone<T> = T extends RemoteObject<ProxyMarked>\n\t? Local<T>\n\t: T;\n\n/**\n * Takes the raw type of a remote object in the other thread and returns the type as it is visible\n * to the local thread when proxied with `Comlink.proxy()`.\n *\n * This does not handle call signatures, which is handled by the more general `Remote<T>` type.\n *\n * @template T The raw type of a remote object as seen in the other thread.\n */\nexport type RemoteObject<T> = { [P in keyof T]: RemoteProperty<T[P]> };\n/**\n * Takes the type of an object as a remote thread would see it through a proxy (e.g. when passed in\n * as a function argument) and returns the type that the local thread has to supply.\n *\n * This does not handle call signatures, which is handled by the more general `Local<T>` type.\n *\n * This is the inverse of `RemoteObject<T>`.\n *\n * @template T The type of a proxied object.\n */\nexport type LocalObject<T> = { [P in keyof T]: LocalProperty<T[P]> };\n\n/**\n * Additional special comlink methods available on each proxy returned by `Comlink.wrap()`.\n */\nexport interface ProxyMethods {\n\t[createEndpoint]: () => Promise<MessagePort>;\n\t[releaseProxy]: () => void;\n}\n\n/**\n * Takes the raw type of a remote object, function or class in the other thread and returns the\n * type as it is visible to the local thread from the proxy return value of `Comlink.wrap()` or\n * `Comlink.proxy()`.\n */\nexport type Remote<T> =\n\t// Handle properties\n\tRemoteObject<T> &\n\t\t// Handle call signature (if present)\n\t\t(T extends (...args: infer TArguments) => infer TReturn\n\t\t\t? (\n\t\t\t\t\t...args: {\n\t\t\t\t\t\t[I in keyof TArguments]: UnproxyOrClone<TArguments[I]>;\n\t\t\t\t\t}\n\t\t\t  ) => Promisify<ProxyOrClone<Unpromisify<TReturn>>>\n\t\t\t: unknown) &\n\t\t// Handle construct signature (if present)\n\t\t// The return of construct signatures is always proxied (whether marked or not)\n\t\t(T extends { new (...args: infer TArguments): infer TInstance }\n\t\t\t? {\n\t\t\t\t\tnew (\n\t\t\t\t\t\t...args: {\n\t\t\t\t\t\t\t[I in keyof TArguments]: UnproxyOrClone<\n\t\t\t\t\t\t\t\tTArguments[I]\n\t\t\t\t\t\t\t>;\n\t\t\t\t\t\t}\n\t\t\t\t\t): Promisify<Remote<TInstance>>;\n\t\t\t  }\n\t\t\t: unknown) &\n\t\t// Include additional special comlink methods available on the proxy.\n\t\tProxyMethods;\n\n/**\n * Expresses that a type can be either a sync or async.\n */\ntype MaybePromise<T> = Promise<T> | T;\n\n/**\n * Takes the raw type of a remote object, function or class as a remote thread would see it through\n * a proxy (e.g. when passed in as a function argument) and returns the type the local thread has\n * to supply.\n *\n * This is the inverse of `Remote<T>`. It takes a `Remote<T>` and returns its original input `T`.\n */\nexport type Local<T> =\n\t// Omit the special proxy methods (they don't need to be supplied, comlink adds them)\n\tOmit<LocalObject<T>, keyof ProxyMethods> &\n\t\t// Handle call signatures (if present)\n\t\t(T extends (...args: infer TArguments) => infer TReturn\n\t\t\t? (\n\t\t\t\t\t...args: {\n\t\t\t\t\t\t[I in keyof TArguments]: ProxyOrClone<TArguments[I]>;\n\t\t\t\t\t}\n\t\t\t  ) => // The raw function could either be sync or async, but is always proxied automatically\n\t\t\t  MaybePromise<UnproxyOrClone<Unpromisify<TReturn>>>\n\t\t\t: unknown) &\n\t\t// Handle construct signature (if present)\n\t\t// The return of construct signatures is always proxied (whether marked or not)\n\t\t(T extends { new (...args: infer TArguments): infer TInstance }\n\t\t\t? {\n\t\t\t\t\tnew (\n\t\t\t\t\t\t...args: {\n\t\t\t\t\t\t\t[I in keyof TArguments]: ProxyOrClone<\n\t\t\t\t\t\t\t\tTArguments[I]\n\t\t\t\t\t\t\t>;\n\t\t\t\t\t\t}\n\t\t\t\t\t): // The raw constructor could either be sync or async, but is always proxied automatically\n\t\t\t\t\tMaybePromise<Local<Unpromisify<TInstance>>>;\n\t\t\t  }\n\t\t\t: unknown);\n\nconst isObject = (val: unknown): val is object =>\n\t(typeof val === 'object' && val !== null) || typeof val === 'function';\n\n/**\n * Customizes the serialization of certain values as determined by `canHandle()`.\n *\n * @template T The input type being handled by this transfer handler.\n * @template S The serialized type sent over the wire.\n */\nexport interface TransferHandler<T, S> {\n\t/**\n\t * Gets called for every value to determine whether this transfer handler\n\t * should serialize the value, which includes checking that it is of the right\n\t * type (but can perform checks beyond that as well).\n\t */\n\tcanHandle(value: unknown): value is T;\n\n\t/**\n\t * Gets called with the value if `canHandle()` returned `true` to produce a\n\t * value that can be sent in a message, consisting of structured-cloneable\n\t * values and/or transferrable objects.\n\t */\n\tserialize(value: T): [S, Transferable[]];\n\n\t/**\n\t * Gets called to deserialize an incoming value that was serialized in the\n\t * other thread with this transfer handler (known through the name it was\n\t * registered under).\n\t */\n\tdeserialize(value: S): T;\n}\n\n/**\n * Internal transfer handle to handle objects marked to proxy.\n */\nconst proxyTransferHandler: TransferHandler<object, MessagePort> = {\n\tcanHandle: (val): val is ProxyMarked =>\n\t\tisObject(val) && (val as ProxyMarked)[proxyMarker],\n\tserialize(obj) {\n\t\tconst { port1, port2 } = new MessageChannel();\n\t\texpose(obj, port1);\n\t\treturn [port2, [port2]];\n\t},\n\tdeserialize(port) {\n\t\tport.start();\n\t\treturn wrap(port);\n\t},\n};\n\ninterface ThrownValue {\n\t[throwMarker]: unknown; // just needs to be present\n\tvalue: unknown;\n}\ntype SerializedThrownValue =\n\t| { isError: true; value: Error }\n\t| { isError: false; value: unknown };\ntype PendingListenersMap = Map<\n\tstring,\n\t(value: WireValue | PromiseLike<WireValue>) => void\n>;\n\n/**\n * Internal transfer handler to handle thrown exceptions.\n */\nconst throwTransferHandler: TransferHandler<\n\tThrownValue,\n\tSerializedThrownValue\n> = {\n\tcanHandle: (value): value is ThrownValue =>\n\t\tisObject(value) && throwMarker in value,\n\tserialize({ value }) {\n\t\tlet serialized: SerializedThrownValue;\n\t\tif (value instanceof Error) {\n\t\t\tserialized = {\n\t\t\t\tisError: true,\n\t\t\t\tvalue: {\n\t\t\t\t\tmessage: value.message,\n\t\t\t\t\tname: value.name,\n\t\t\t\t\tstack: value.stack,\n\t\t\t\t},\n\t\t\t};\n\t\t} else {\n\t\t\tserialized = { isError: false, value };\n\t\t}\n\t\treturn [serialized, []];\n\t},\n\tdeserialize(serialized) {\n\t\tif (serialized.isError) {\n\t\t\tthrow Object.assign(\n\t\t\t\tnew Error(serialized.value.message),\n\t\t\t\tserialized.value\n\t\t\t);\n\t\t}\n\t\tthrow serialized.value;\n\t},\n};\n\n/**\n * Allows customizing the serialization of certain values.\n */\nexport const transferHandlers = new Map<\n\tstring,\n\tTransferHandler<unknown, unknown>\n>([\n\t['proxy', proxyTransferHandler],\n\t['throw', throwTransferHandler],\n]);\n\nfunction isAllowedOrigin(\n\tallowedOrigins: (string | RegExp)[],\n\torigin: string\n): boolean {\n\tfor (const allowedOrigin of allowedOrigins) {\n\t\tif (origin === allowedOrigin || allowedOrigin === '*') {\n\t\t\treturn true;\n\t\t}\n\t\tif (allowedOrigin instanceof RegExp && allowedOrigin.test(origin)) {\n\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\nexport function expose(\n\tobj: any,\n\tep: Endpoint = globalThis as any,\n\tallowedOrigins: (string | RegExp)[] = ['*'],\n\tafterResponseSent?: (ev: MessageEvent) => void\n) {\n\tep.addEventListener('message', function callback(ev: MessageEvent) {\n\t\tif (!ev || !ev.data) {\n\t\t\treturn;\n\t\t}\n\t\tif (!isAllowedOrigin(allowedOrigins, ev.origin)) {\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.warn(`Invalid origin '${ev.origin}' for comlink proxy`);\n\t\t\treturn;\n\t\t}\n\t\tconst { id, type, path } = {\n\t\t\tpath: [] as string[],\n\t\t\t...(ev.data as Message),\n\t\t};\n\t\tconst argumentList = (ev.data.argumentList || []).map(fromWireValue);\n\t\tlet returnValue;\n\t\ttry {\n\t\t\tconst parent = path\n\t\t\t\t.slice(0, -1)\n\t\t\t\t.reduce((obj, prop) => obj[prop], obj);\n\t\t\tconst rawValue = path.reduce((obj, prop) => obj[prop], obj);\n\t\t\tswitch (type) {\n\t\t\t\tcase MessageType.GET:\n\t\t\t\t\t{\n\t\t\t\t\t\treturnValue = rawValue;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase MessageType.SET:\n\t\t\t\t\t{\n\t\t\t\t\t\tparent[path.slice(-1)[0]] = fromWireValue(\n\t\t\t\t\t\t\tev.data.value\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturnValue = true;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase MessageType.APPLY:\n\t\t\t\t\t{\n\t\t\t\t\t\treturnValue = rawValue.apply(parent, argumentList);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase MessageType.CONSTRUCT:\n\t\t\t\t\t{\n\t\t\t\t\t\tconst value = new rawValue(...argumentList);\n\t\t\t\t\t\treturnValue = proxy(value);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase MessageType.ENDPOINT:\n\t\t\t\t\t{\n\t\t\t\t\t\tconst { port1, port2 } = new MessageChannel();\n\t\t\t\t\t\texpose(obj, port2);\n\t\t\t\t\t\treturnValue = transfer(port1, [port1]);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase MessageType.RELEASE:\n\t\t\t\t\t{\n\t\t\t\t\t\treturnValue = undefined;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\treturn;\n\t\t\t}\n\t\t} catch (value) {\n\t\t\treturnValue = { value, [throwMarker]: 0 };\n\t\t}\n\t\tPromise.resolve(returnValue)\n\t\t\t.catch((value) => {\n\t\t\t\treturn { value, [throwMarker]: 0 };\n\t\t\t})\n\t\t\t.then((returnValue) => {\n\t\t\t\tconst [wireValue, transferables] = toWireValue(returnValue);\n\t\t\t\tep.postMessage({ ...wireValue, id }, transferables);\n\t\t\t\tif (type === MessageType.RELEASE) {\n\t\t\t\t\t// detach and deactive after sending release response above.\n\t\t\t\t\tep.removeEventListener('message', callback as any);\n\t\t\t\t\tcloseEndPoint(ep);\n\t\t\t\t\tif (\n\t\t\t\t\t\tfinalizer in obj &&\n\t\t\t\t\t\ttypeof obj[finalizer] === 'function'\n\t\t\t\t\t) {\n\t\t\t\t\t\tobj[finalizer]();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(() => {\n\t\t\t\t// Send Serialization Error To Caller\n\t\t\t\tconst [wireValue, transferables] = toWireValue({\n\t\t\t\t\tvalue: new TypeError('Unserializable return value'),\n\t\t\t\t\t[throwMarker]: 0,\n\t\t\t\t});\n\t\t\t\tep.postMessage({ ...wireValue, id }, transferables);\n\t\t\t})\n\t\t\t.finally(() => {\n\t\t\t\tafterResponseSent?.(ev);\n\t\t\t});\n\t} as any);\n\tif (ep.start) {\n\t\tep.start();\n\t}\n}\n\nfunction isMessagePort(endpoint: Endpoint): endpoint is MessagePort {\n\treturn endpoint.constructor.name === 'MessagePort';\n}\n\nfunction closeEndPoint(endpoint: Endpoint) {\n\tif (isMessagePort(endpoint)) endpoint.close();\n}\n\nexport function wrap<T>(ep: Endpoint, target?: any): Remote<T> {\n\tconst pendingListeners: PendingListenersMap = new Map();\n\n\tep.addEventListener('message', function handleMessage(ev: Event) {\n\t\tconst { data } = ev as MessageEvent;\n\t\tif (!data || !data.id) {\n\t\t\treturn;\n\t\t}\n\t\tconst resolver = pendingListeners.get(data.id);\n\t\tif (!resolver) {\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tresolver(data);\n\t\t} finally {\n\t\t\tpendingListeners.delete(data.id);\n\t\t}\n\t});\n\n\treturn createProxy<T>(ep, pendingListeners, [], target) as any;\n}\n\nfunction throwIfProxyReleased(isReleased: boolean) {\n\tif (isReleased) {\n\t\tthrow new Error('Proxy has been released and is not useable');\n\t}\n}\n\nfunction releaseEndpoint(ep: Endpoint) {\n\treturn requestResponseMessage(ep, new Map(), {\n\t\ttype: MessageType.RELEASE,\n\t}).then(() => {\n\t\tcloseEndPoint(ep);\n\t});\n}\n\ninterface FinalizationRegistry<T> {\n\t// @ts-ignore\n\tnew (cb: (heldValue: T) => void): FinalizationRegistry<T>;\n\tregister(\n\t\tweakItem: object,\n\t\theldValue: T,\n\t\tunregisterToken?: object | undefined\n\t): void;\n\tunregister(unregisterToken: object): void;\n}\ndeclare const FinalizationRegistry: FinalizationRegistry<Endpoint>;\n\nconst proxyCounter = new WeakMap<Endpoint, number>();\nconst proxyFinalizers =\n\t'FinalizationRegistry' in globalThis &&\n\tnew FinalizationRegistry((ep: Endpoint) => {\n\t\tconst newCount = (proxyCounter.get(ep) || 0) - 1;\n\t\tproxyCounter.set(ep, newCount);\n\t\tif (newCount === 0) {\n\t\t\treleaseEndpoint(ep);\n\t\t}\n\t});\n\nfunction registerProxy(proxy: object, ep: Endpoint) {\n\tconst newCount = (proxyCounter.get(ep) || 0) + 1;\n\tproxyCounter.set(ep, newCount);\n\tif (proxyFinalizers) {\n\t\tproxyFinalizers.register(proxy, ep, proxy);\n\t}\n}\n\nfunction unregisterProxy(proxy: object) {\n\tif (proxyFinalizers) {\n\t\tproxyFinalizers.unregister(proxy);\n\t}\n}\n\nfunction createProxy<T>(\n\tep: Endpoint,\n\tpendingListeners: PendingListenersMap,\n\tpath: (string | number | symbol)[] = [],\n\ttarget: object = function () {}\n): Remote<T> {\n\tlet isProxyReleased = false;\n\tconst proxy = new Proxy(target, {\n\t\tget(_target, prop) {\n\t\t\tthrowIfProxyReleased(isProxyReleased);\n\t\t\tif (prop === releaseProxy) {\n\t\t\t\treturn () => {\n\t\t\t\t\tunregisterProxy(proxy);\n\t\t\t\t\treleaseEndpoint(ep);\n\t\t\t\t\tpendingListeners.clear();\n\t\t\t\t\tisProxyReleased = true;\n\t\t\t\t};\n\t\t\t}\n\t\t\tif (prop === 'then') {\n\t\t\t\tif (path.length === 0) {\n\t\t\t\t\treturn { then: () => proxy };\n\t\t\t\t}\n\t\t\t\tconst r = requestResponseMessage(ep, pendingListeners, {\n\t\t\t\t\ttype: MessageType.GET,\n\t\t\t\t\tpath: path.map((p) => p.toString()),\n\t\t\t\t}).then(fromWireValue);\n\t\t\t\treturn r.then.bind(r);\n\t\t\t}\n\t\t\treturn createProxy(ep, pendingListeners, [...path, prop]);\n\t\t},\n\t\tset(_target, prop, rawValue) {\n\t\t\tthrowIfProxyReleased(isProxyReleased);\n\t\t\t// FIXME: ES6 Proxy Handler `set` methods are supposed to return a\n\t\t\t// boolean. To show good will, we return true asynchronously ¯\\_(ツ)_/¯\n\t\t\tconst [value, transferables] = toWireValue(rawValue);\n\t\t\treturn requestResponseMessage(\n\t\t\t\tep,\n\t\t\t\tpendingListeners,\n\t\t\t\t{\n\t\t\t\t\ttype: MessageType.SET,\n\t\t\t\t\tpath: [...path, prop].map((p) => p.toString()),\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t\ttransferables\n\t\t\t).then(fromWireValue) as any;\n\t\t},\n\t\tapply(_target, _thisArg, rawArgumentList) {\n\t\t\tthrowIfProxyReleased(isProxyReleased);\n\t\t\tconst last = path[path.length - 1];\n\t\t\tif ((last as any) === createEndpoint) {\n\t\t\t\treturn requestResponseMessage(ep, pendingListeners, {\n\t\t\t\t\ttype: MessageType.ENDPOINT,\n\t\t\t\t}).then(fromWireValue);\n\t\t\t}\n\t\t\t// We just pretend that `bind()` didn’t happen.\n\t\t\tif (last === 'bind') {\n\t\t\t\treturn createProxy(ep, pendingListeners, path.slice(0, -1));\n\t\t\t}\n\t\t\tconst [argumentList, transferables] =\n\t\t\t\tprocessArguments(rawArgumentList);\n\t\t\treturn requestResponseMessage(\n\t\t\t\tep,\n\t\t\t\tpendingListeners,\n\t\t\t\t{\n\t\t\t\t\ttype: MessageType.APPLY,\n\t\t\t\t\tpath: path.map((p) => p.toString()),\n\t\t\t\t\targumentList,\n\t\t\t\t},\n\t\t\t\ttransferables\n\t\t\t).then(fromWireValue);\n\t\t},\n\t\tconstruct(_target, rawArgumentList) {\n\t\t\tthrowIfProxyReleased(isProxyReleased);\n\t\t\tconst [argumentList, transferables] =\n\t\t\t\tprocessArguments(rawArgumentList);\n\t\t\treturn requestResponseMessage(\n\t\t\t\tep,\n\t\t\t\tpendingListeners,\n\t\t\t\t{\n\t\t\t\t\ttype: MessageType.CONSTRUCT,\n\t\t\t\t\tpath: path.map((p) => p.toString()),\n\t\t\t\t\targumentList,\n\t\t\t\t},\n\t\t\t\ttransferables\n\t\t\t).then(fromWireValue);\n\t\t},\n\t});\n\tregisterProxy(proxy, ep);\n\treturn proxy as any;\n}\n\nfunction myFlat<T>(arr: (T | T[])[]): T[] {\n\treturn Array.prototype.concat.apply([], arr);\n}\n\nfunction processArguments(argumentList: any[]): [WireValue[], Transferable[]] {\n\tconst processed = argumentList.map(toWireValue);\n\treturn [processed.map((v) => v[0]), myFlat(processed.map((v) => v[1]))];\n}\n\nconst transferCache = new WeakMap<any, Transferable[]>();\nexport function transfer<T>(obj: T, transfers: Transferable[]): T {\n\ttransferCache.set(obj, transfers);\n\treturn obj;\n}\n\nexport function proxy<T extends object>(obj: T): T & ProxyMarked {\n\treturn Object.assign(obj, { [proxyMarker]: true }) as any;\n}\n\nexport function windowEndpoint(\n\tw: PostMessageWithOrigin,\n\tcontext: EventSource = globalThis,\n\ttargetOrigin = '*'\n): Endpoint {\n\treturn {\n\t\tpostMessage: (msg: any, transferables: Transferable[]) =>\n\t\t\tw.postMessage(msg, targetOrigin, transferables),\n\t\taddEventListener: context.addEventListener.bind(context),\n\t\tremoveEventListener: context.removeEventListener.bind(context),\n\t};\n}\n\nfunction toWireValue(value: any): [WireValue, Transferable[]] {\n\tfor (const [name, handler] of transferHandlers) {\n\t\tif (handler.canHandle(value)) {\n\t\t\tconst [serializedValue, transferables] = handler.serialize(value);\n\t\t\treturn [\n\t\t\t\t{\n\t\t\t\t\ttype: WireValueType.HANDLER,\n\t\t\t\t\tname,\n\t\t\t\t\tvalue: serializedValue,\n\t\t\t\t},\n\t\t\t\ttransferables,\n\t\t\t];\n\t\t}\n\t}\n\treturn [\n\t\t{\n\t\t\ttype: WireValueType.RAW,\n\t\t\tvalue,\n\t\t},\n\t\ttransferCache.get(value) || [],\n\t];\n}\n\nfunction fromWireValue(value: WireValue): any {\n\tswitch (value.type) {\n\t\tcase WireValueType.HANDLER:\n\t\t\treturn transferHandlers.get(value.name)!.deserialize(value.value);\n\t\tcase WireValueType.RAW:\n\t\t\treturn value.value;\n\t}\n}\n\nfunction requestResponseMessage(\n\tep: Endpoint,\n\tpendingListeners: PendingListenersMap,\n\tmsg: Message,\n\ttransfers?: Transferable[]\n): Promise<WireValue> {\n\treturn new Promise((resolve) => {\n\t\tconst id = generateUUID();\n\t\tpendingListeners.set(id, resolve);\n\t\tif (ep.start) {\n\t\t\tep.start();\n\t\t}\n\t\tep.postMessage({ id, ...msg }, transfers);\n\t});\n}\n\nfunction generateUUID(): string {\n\treturn new Array(4)\n\t\t.fill(0)\n\t\t.map(() =>\n\t\t\tMath.floor(Math.random() * Number.MAX_SAFE_INTEGER).toString(16)\n\t\t)\n\t\t.join('-');\n}\n\n// node-adapter.ts:\n\nexport interface NodeEndpoint {\n\tpostMessage(message: any, transfer?: any[]): void;\n\ton(\n\t\ttype: string,\n\t\tlistener: EventListenerOrEventListenerObject,\n\t\toptions?: object\n\t): void;\n\toff(\n\t\ttype: string,\n\t\tlistener: EventListenerOrEventListenerObject,\n\t\toptions?: object\n\t): void;\n\tstart?: () => void;\n}\n\nexport function nodeEndpoint(nep: NodeEndpoint): Endpoint {\n\tconst listeners = new WeakMap();\n\treturn {\n\t\tpostMessage: nep.postMessage.bind(nep),\n\t\taddEventListener: (_, eh) => {\n\t\t\tconst l = (data: any) => {\n\t\t\t\tif ('handleEvent' in eh) {\n\t\t\t\t\teh.handleEvent({ data } as MessageEvent);\n\t\t\t\t} else {\n\t\t\t\t\teh({ data } as MessageEvent);\n\t\t\t\t}\n\t\t\t};\n\t\t\tnep.on('message', l);\n\t\t\tlisteners.set(eh, l);\n\t\t},\n\t\tremoveEventListener: (_, eh) => {\n\t\t\tconst l = listeners.get(eh);\n\t\t\tif (!l) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tnep.off('message', l);\n\t\t\tlisteners.delete(eh);\n\t\t},\n\t\tstart: nep.start && nep.start.bind(nep),\n\t};\n}\n","/**\n * `serialize-error` package wrapped as a single file for compatibility\n * with both CJS and ESM.\n *\n * @see https://github.com/sindresorhus/serialize-error\n */\nconst list = [\n\t// Native ES errors https://262.ecma-international.org/12.0/#sec-well-known-intrinsic-objects\n\tError,\n\tEvalError,\n\tRangeError,\n\tReferenceError,\n\tSyntaxError,\n\tTypeError,\n\tURIError,\n\tAggregateError,\n\n\t// Built-in errors\n\tglobalThis.DOMException,\n\n\t// Node-specific errors\n\t// https://nodejs.org/api/errors.html\n\t(globalThis as any).AssertionError,\n\t(globalThis as any).SystemError,\n]\n\t// Non-native Errors are used with `globalThis` because they might be missing. This filter drops\n\t// them when undefined.\n\t.filter(Boolean)\n\t.map((constructor) => [constructor.name, constructor]);\n\nexport type ErrorObject = {\n\tname?: string;\n\tmessage?: string;\n\tstack?: string;\n\tcause?: unknown;\n\tcode?: string;\n} & Record<string, unknown>;\n\nexport const errorConstructors = new Map(list as any);\n\nexport function addKnownErrorConstructor(constructor: any) {\n\tconst { name } = constructor;\n\tif (errorConstructors.has(name)) {\n\t\tthrow new Error(`The error constructor \"${name}\" is already known.`);\n\t}\n\n\ttry {\n\t\t// eslint-disable-next-line no-new -- It just needs to be verified\n\t\tnew constructor();\n\t} catch (error) {\n\t\tthrow new Error(`The error constructor \"${name}\" is not compatible`, {\n\t\t\tcause: error,\n\t\t});\n\t}\n\n\terrorConstructors.set(name, constructor);\n}\n\nexport class NonError extends Error {\n\toverride name = 'NonError';\n\n\tconstructor(message: any) {\n\t\tsuper(NonError._prepareSuperMessage(message));\n\t}\n\n\tstatic _prepareSuperMessage(message: any) {\n\t\ttry {\n\t\t\treturn JSON.stringify(message);\n\t\t} catch {\n\t\t\treturn String(message);\n\t\t}\n\t}\n}\n\nconst errorProperties = [\n\t{\n\t\tproperty: 'name',\n\t\tenumerable: false,\n\t},\n\t{\n\t\tproperty: 'message',\n\t\tenumerable: false,\n\t},\n\t{\n\t\tproperty: 'stack',\n\t\tenumerable: false,\n\t},\n\t{\n\t\tproperty: 'code',\n\t\tenumerable: true,\n\t},\n\t{\n\t\tproperty: 'cause',\n\t\tenumerable: false,\n\t},\n\t{\n\t\tproperty: 'errors',\n\t\tenumerable: false,\n\t},\n];\n\nconst toJsonWasCalled = new WeakSet();\n\nconst toJSON = (from: any) => {\n\ttoJsonWasCalled.add(from);\n\tconst json = from.toJSON();\n\ttoJsonWasCalled.delete(from);\n\treturn json;\n};\n\nconst newError = (name: any) => {\n\tconst ErrorConstructor = errorConstructors.get(name) ?? (Error as any);\n\treturn ErrorConstructor === AggregateError\n\t\t? new ErrorConstructor([])\n\t\t: new ErrorConstructor();\n};\n\n// eslint-disable-next-line complexity\nconst destroyCircular = ({\n\tfrom,\n\tseen,\n\tto,\n\tforceEnumerable,\n\tmaxDepth,\n\tdepth,\n\tuseToJSON,\n\tserialize,\n}: {\n\tfrom?: any;\n\tseen: any[];\n\tto?: any;\n\tforceEnumerable: boolean;\n\tmaxDepth: number;\n\tdepth: number;\n\tuseToJSON: boolean;\n\tserialize: boolean;\n}) => {\n\tif (!to) {\n\t\tif (Array.isArray(from)) {\n\t\t\tto = [];\n\t\t} else if (!serialize && isErrorLike(from)) {\n\t\t\tto = newError(from.name);\n\t\t} else {\n\t\t\tto = {};\n\t\t}\n\t}\n\n\tseen.push(from);\n\n\tif (depth >= maxDepth) {\n\t\treturn to;\n\t}\n\n\tif (\n\t\tuseToJSON &&\n\t\ttypeof from.toJSON === 'function' &&\n\t\t!toJsonWasCalled.has(from)\n\t) {\n\t\treturn toJSON(from);\n\t}\n\n\tconst continueDestroyCircular = (value: any) =>\n\t\tdestroyCircular({\n\t\t\tfrom: value,\n\t\t\tseen: [...seen],\n\t\t\tforceEnumerable,\n\t\t\tmaxDepth,\n\t\t\tdepth,\n\t\t\tuseToJSON,\n\t\t\tserialize,\n\t\t});\n\n\tfor (const [key, value] of Object.entries(from)) {\n\t\tif (\n\t\t\tvalue &&\n\t\t\tvalue instanceof Uint8Array &&\n\t\t\tvalue.constructor.name === 'Buffer'\n\t\t) {\n\t\t\tto[key] = '[object Buffer]';\n\t\t\tcontinue;\n\t\t}\n\n\t\t// TODO: Use `stream.isReadable()` when targeting Node.js 18.\n\t\tif (\n\t\t\tvalue !== null &&\n\t\t\ttypeof value === 'object' &&\n\t\t\ttypeof (value as any).pipe === 'function'\n\t\t) {\n\t\t\tto[key] = '[object Stream]';\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (typeof value === 'function') {\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (!value || typeof value !== 'object') {\n\t\t\t// Gracefully handle non-configurable errors like `DOMException`.\n\t\t\ttry {\n\t\t\t\tto[key] = value;\n\t\t\t} catch {\n\t\t\t\t// ignore\n\t\t\t}\n\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (!seen.includes(from[key])) {\n\t\t\tdepth++;\n\t\t\tto[key] = continueDestroyCircular(from[key]);\n\n\t\t\tcontinue;\n\t\t}\n\n\t\tto[key] = '[Circular]';\n\t}\n\n\tif (serialize || to instanceof Error) {\n\t\tfor (const { property, enumerable } of errorProperties) {\n\t\t\tif (from[property] !== undefined && from[property] !== null) {\n\t\t\t\tObject.defineProperty(to, property, {\n\t\t\t\t\tvalue:\n\t\t\t\t\t\tisErrorLike(from[property]) ||\n\t\t\t\t\t\tArray.isArray(from[property])\n\t\t\t\t\t\t\t? continueDestroyCircular(from[property])\n\t\t\t\t\t\t\t: from[property],\n\t\t\t\t\tenumerable: forceEnumerable ? true : enumerable,\n\t\t\t\t\tconfigurable: true,\n\t\t\t\t\twritable: true,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\treturn to;\n};\n\nexport function serializeError(value: any, options: any = {}) {\n\tconst { maxDepth = Number.POSITIVE_INFINITY, useToJSON = true } = options;\n\n\tif (typeof value === 'object' && value !== null) {\n\t\treturn destroyCircular({\n\t\t\tfrom: value,\n\t\t\tseen: [],\n\t\t\tforceEnumerable: true,\n\t\t\tmaxDepth,\n\t\t\tdepth: 0,\n\t\t\tuseToJSON,\n\t\t\tserialize: true,\n\t\t});\n\t}\n\n\t// People sometimes throw things besides Error objects…\n\tif (typeof value === 'function') {\n\t\t// `JSON.stringify()` discards functions. We do too, unless a function is thrown directly.\n\t\t// We intentionally use `||` because `.name` is an empty string for anonymous functions.\n\t\treturn `[Function: ${value.name || 'anonymous'}]`;\n\t}\n\n\treturn value;\n}\n\nexport function deserializeError(value: any, options: any = {}) {\n\tconst { maxDepth = Number.POSITIVE_INFINITY } = options;\n\n\tif (value instanceof Error) {\n\t\treturn value;\n\t}\n\n\tif (isMinimumViableSerializedError(value)) {\n\t\treturn destroyCircular({\n\t\t\tfrom: value,\n\t\t\tseen: [],\n\t\t\tto: newError(value.name),\n\t\t\tmaxDepth,\n\t\t\tdepth: 0,\n\t\t\tserialize: false,\n\t\t} as any);\n\t}\n\n\treturn new NonError(value);\n}\n\nexport function isErrorLike(value: any) {\n\treturn (\n\t\tBoolean(value) &&\n\t\ttypeof value === 'object' &&\n\t\ttypeof value.name === 'string' &&\n\t\ttypeof value.message === 'string' &&\n\t\ttypeof value.stack === 'string'\n\t);\n}\n\n// Used as a weak check for immediately-passed objects, whereas `isErrorLike` is used for nested\n// values to avoid bad detection\nfunction isMinimumViableSerializedError(value: any) {\n\t// @ts-ignore\n\treturn (\n\t\tBoolean(value) &&\n\t\ttypeof value === 'object' &&\n\t\ttypeof value.message === 'string' &&\n\t\t!Array.isArray(value)\n\t);\n}\n","import type { PHPResponseData } from './php-response';\nimport { PHPResponse, StreamedPHPResponse } from './php-response';\nimport * as Comlink from './comlink-sync';\nimport {\n\tNodeSABSyncReceiveMessageTransport,\n\tnodeEndpoint,\n\ttype NodeEndpoint,\n\ttype Remote,\n\ttype Endpoint,\n\ttype IsomorphicMessagePort,\n} from './comlink-sync';\nimport * as ErrorSerializer from './serialize-error';\n\nexport type WithAPIState = {\n\t/**\n\t * Resolves to true when the remote API is ready for\n\t * Comlink communication, but not necessarily fully initialized yet.\n\t */\n\tisConnected: () => Promise<void>;\n\t/**\n\t * Resolves to true when the remote API is declares it's\n\t * fully loaded and ready to be used.\n\t */\n\tisReady: () => Promise<void>;\n};\nexport type RemoteAPI<T> = Remote<T> & WithAPIState;\n\nexport async function consumeAPISync<APIType>(\n\tremote: IsomorphicMessagePort\n): Promise<APIType> {\n\tsetupTransferHandlers();\n\tconst transport = await NodeSABSyncReceiveMessageTransport.create();\n\treturn Comlink.wrapSync<APIType>(remote, transport);\n}\n\nexport function consumeAPI<APIType>(\n\tremote: Worker | Window | NodeEndpoint,\n\tcontext: undefined | EventTarget = undefined\n): RemoteAPI<APIType> {\n\tsetupTransferHandlers();\n\n\tlet endpoint;\n\tconst appearsToBeNodeEnvironment = import.meta.url.startsWith('file://');\n\tif (appearsToBeNodeEnvironment) {\n\t\tendpoint = nodeEndpoint(remote as NodeEndpoint);\n\t} else {\n\t\tendpoint =\n\t\t\tremote instanceof Worker\n\t\t\t\t? remote\n\t\t\t\t: Comlink.windowEndpoint(remote as Window, context);\n\t}\n\n\t/**\n\t * This shouldn't be necessary, but Comlink doesn't seem to\n\t * handle the initial isConnected() call correctly unless it's\n\t * explicitly provided here. This is especially weird\n\t * since the only thing this proxy does is to call the\n\t * isConnected() method on the remote API.\n\t *\n\t * @TODO: Remove this workaround.\n\t */\n\tconst api = Comlink.wrap<APIType & WithAPIState>(endpoint);\n\tconst methods = proxyClone(api);\n\treturn new Proxy(methods, {\n\t\tget: (target, prop) => {\n\t\t\tif (prop === 'isConnected') {\n\t\t\t\treturn async () => {\n\t\t\t\t\t// Keep retrying until the remote API confirms it's connected.\n\t\t\t\t\twhile (true) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait runWithTimeout(api.isConnected(), 200);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t// Timeout exceeded, try again. We can't just use a single\n\t\t\t\t\t\t\t// `runWithTimeout` call because it won't reach the remote API\n\t\t\t\t\t\t\t// if it's not connected yet. Instead, we need to keep retrying\n\t\t\t\t\t\t\t// until the remote API is connected and registers a handler\n\t\t\t\t\t\t\t// for the `isConnected` method.\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn (api as any)[prop];\n\t\t},\n\t}) as unknown as RemoteAPI<APIType>;\n}\n\nasync function runWithTimeout<T>(\n\tpromise: Promise<T>,\n\ttimeout: number\n): Promise<T> {\n\treturn new Promise<T>((resolve, reject) => {\n\t\tsetTimeout(reject, timeout);\n\t\tpromise.then(resolve);\n\t});\n}\n\nexport type PublicAPI<Methods, PipedAPI = unknown> = RemoteAPI<\n\tMethods & PipedAPI\n>;\n\nexport function exposeAPI<Methods, PipedAPI>(\n\tapiMethods?: Methods,\n\tpipedApi?: PipedAPI,\n\ttargetWorker?: NodeEndpoint\n): [() => void, (e: Error) => void, PublicAPI<Methods, PipedAPI>] {\n\tconst { setReady, setFailed, exposedApi } = prepareForExpose(\n\t\tapiMethods,\n\t\tpipedApi\n\t);\n\tlet endpoint: Endpoint | undefined;\n\tif (targetWorker) {\n\t\t// NOTE: If there are other target types, we could expand this later,\n\t\t// but for now, we only need support for NodeEndpoints.\n\t\tendpoint = nodeEndpoint(targetWorker);\n\t} else {\n\t\tendpoint =\n\t\t\ttypeof window !== 'undefined'\n\t\t\t\t? Comlink.windowEndpoint(self.parent)\n\t\t\t\t: undefined;\n\t}\n\tComlink.expose(exposedApi, endpoint);\n\treturn [setReady, setFailed, exposedApi as PublicAPI<Methods, PipedAPI>];\n}\n\nexport async function exposeSyncAPI<Methods>(\n\tapiMethods: Methods,\n\tport: IsomorphicMessagePort\n): Promise<[() => void, (e: Error) => void, Methods]> {\n\tconst { setReady, setFailed, exposedApi } = prepareForExpose(apiMethods);\n\tconst transport = await NodeSABSyncReceiveMessageTransport.create();\n\tconst endpoint = nodeEndpoint(port as any);\n\tComlink.exposeSync(exposedApi, endpoint, transport);\n\treturn [setReady, setFailed, exposedApi as Methods];\n}\n\nfunction prepareForExpose<Methods, PipedAPI>(\n\tapiMethods?: Methods,\n\tpipedApi?: PipedAPI\n) {\n\tsetupTransferHandlers();\n\n\tconst connected = Promise.resolve();\n\n\tlet setReady: any;\n\tlet setFailed: any;\n\tconst ready = new Promise((resolve, reject) => {\n\t\tsetReady = resolve;\n\t\tsetFailed = reject;\n\t});\n\n\tconst methods = proxyClone(apiMethods);\n\tconst exposedApi = new Proxy(methods, {\n\t\tget: (target, prop) => {\n\t\t\tif (prop === 'isConnected') {\n\t\t\t\treturn () => connected;\n\t\t\t} else if (prop === 'isReady') {\n\t\t\t\treturn () => ready;\n\t\t\t} else if (prop in target) {\n\t\t\t\treturn target[prop];\n\t\t\t}\n\t\t\treturn (pipedApi as any)?.[prop];\n\t\t},\n\t}) as unknown as PublicAPI<Methods, PipedAPI>;\n\n\treturn { setReady, setFailed, exposedApi };\n}\n\nlet isTransferHandlersSetup = false;\nfunction setupTransferHandlers() {\n\tif (isTransferHandlersSetup) {\n\t\treturn;\n\t}\n\tisTransferHandlersSetup = true;\n\tComlink.transferHandlers.set('EVENT', {\n\t\tcanHandle: (obj): obj is CustomEvent => obj instanceof CustomEvent,\n\t\tserialize: (ev: CustomEvent) => {\n\t\t\treturn [\n\t\t\t\t{\n\t\t\t\t\tdetail: ev.detail,\n\t\t\t\t},\n\t\t\t\t[],\n\t\t\t];\n\t\t},\n\t\tdeserialize: (obj) => obj,\n\t});\n\tComlink.transferHandlers.set('FUNCTION', {\n\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\n\t\tcanHandle: (obj: unknown): obj is Function => typeof obj === 'function',\n\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\n\t\tserialize(obj: Function) {\n\t\t\tconst { port1, port2 } = new MessageChannel();\n\t\t\tComlink.expose(obj, port1);\n\t\t\treturn [port2, [port2]];\n\t\t},\n\t\tdeserialize(port: any) {\n\t\t\tport.start();\n\t\t\treturn Comlink.wrap(port);\n\t\t},\n\t});\n\tComlink.transferHandlers.set('MESSAGE_PORT', {\n\t\tcanHandle: (obj: unknown): obj is MessagePort =>\n\t\t\tobj instanceof MessagePort,\n\t\tserialize(port: MessagePort): [MessagePort, Transferable[]] {\n\t\t\treturn [port, [port]];\n\t\t},\n\t\tdeserialize(port: MessagePort): MessagePort {\n\t\t\treturn port;\n\t\t},\n\t});\n\tComlink.transferHandlers.set('PHPResponse', {\n\t\tcanHandle: (obj: unknown): obj is PHPResponseData =>\n\t\t\ttypeof obj === 'object' &&\n\t\t\tobj !== null &&\n\t\t\t'headers' in obj &&\n\t\t\t'bytes' in obj &&\n\t\t\t'errors' in obj &&\n\t\t\t'exitCode' in obj &&\n\t\t\t'httpStatusCode' in obj,\n\t\tserialize(obj: PHPResponse): [PHPResponseData, Transferable[]] {\n\t\t\treturn [obj.toRawData(), []];\n\t\t},\n\t\tdeserialize(responseData: PHPResponseData): PHPResponse {\n\t\t\treturn PHPResponse.fromRawData(responseData);\n\t\t},\n\t});\n\t// Augment Comlink's throw handler to include Error the response and source\n\t// information in the serialized error object. BasePHP may throw\n\t// PHPExecutionFailureError which includes those information and we'll want to\n\t// display them for the user.\n\tconst throwHandler = Comlink.transferHandlers.get('throw')!;\n\tconst originalSerialize = throwHandler?.serialize;\n\tthrowHandler.serialize = ({ value }: any) => {\n\t\tconst serialized = originalSerialize({ value }) as any;\n\t\tif (value.response) {\n\t\t\tserialized[0].value.response = value.response;\n\t\t}\n\t\tif (value.source) {\n\t\t\tserialized[0].value.source = value.source;\n\t\t}\n\t\treturn serialized;\n\t};\n\n\tComlink.transferHandlers.set('StreamedPHPResponse', {\n\t\tcanHandle: (obj: unknown): obj is StreamedPHPResponse =>\n\t\t\tobj instanceof StreamedPHPResponse,\n\t\tserialize(obj: StreamedPHPResponse): [any, Transferable[]] {\n\t\t\tconst supportsStreams = supportsTransferableStreams();\n\t\t\tconst exitCodePort = promiseToPort(obj.exitCode);\n\t\t\tif (supportsStreams) {\n\t\t\t\tconst payload = {\n\t\t\t\t\t__type: 'StreamedPHPResponse',\n\t\t\t\t\theaders: (obj as any)['headersStream'],\n\t\t\t\t\tstdout: obj.stdout,\n\t\t\t\t\tstderr: obj.stderr,\n\t\t\t\t\texitCodePort,\n\t\t\t\t};\n\t\t\t\treturn [payload, [exitCodePort]];\n\t\t\t}\n\t\t\t// Fallback: bridge streams via MessagePorts\n\t\t\tconst headersPort = streamToPort((obj as any)['headersStream']);\n\t\t\tconst stdoutPort = streamToPort(obj.stdout);\n\t\t\tconst stderrPort = streamToPort(obj.stderr);\n\t\t\tconst payload = {\n\t\t\t\t__type: 'StreamedPHPResponse',\n\t\t\t\theadersPort,\n\t\t\t\tstdoutPort,\n\t\t\t\tstderrPort,\n\t\t\t\texitCodePort,\n\t\t\t};\n\t\t\treturn [\n\t\t\t\tpayload,\n\t\t\t\t[headersPort, stdoutPort, stderrPort, exitCodePort],\n\t\t\t];\n\t\t},\n\t\tdeserialize(data: any): StreamedPHPResponse {\n\t\t\tif (data.headers && data.stdout && data.stderr) {\n\t\t\t\tconst exitCode = portToPromise(\n\t\t\t\t\tdata.exitCodePort as MessagePort\n\t\t\t\t);\n\t\t\t\treturn new StreamedPHPResponse(\n\t\t\t\t\tdata.headers as ReadableStream<Uint8Array>,\n\t\t\t\t\tdata.stdout as ReadableStream<Uint8Array>,\n\t\t\t\t\tdata.stderr as ReadableStream<Uint8Array>,\n\t\t\t\t\texitCode\n\t\t\t\t);\n\t\t\t}\n\t\t\tconst headers = portToStream(data.headersPort as MessagePort);\n\t\t\tconst stdout = portToStream(data.stdoutPort as MessagePort);\n\t\t\tconst stderr = portToStream(data.stderrPort as MessagePort);\n\t\t\tconst exitCode = portToPromise(data.exitCodePort as MessagePort);\n\t\t\treturn new StreamedPHPResponse(headers, stdout, stderr, exitCode);\n\t\t},\n\t});\n}\n\n// Utilities for transferring ReadableStreams and Promises via MessagePorts:\n\n/**\n * Safari does not support transferable streams, so we need to fallback to\n * MessagePorts.\n * Feature-detects whether this runtime supports transferring ReadableStreams\n * directly through postMessage (aka \"transferable streams\"). When false,\n * we must fall back to port-bridged streaming.\n */\nfunction supportsTransferableStreams(): boolean {\n\ttry {\n\t\tif (typeof ReadableStream === 'undefined') return false;\n\t\tconst { port1 } = new MessageChannel();\n\t\tconst rs = new ReadableStream();\n\t\tport1.postMessage(rs as any);\n\t\ttry {\n\t\t\tport1.close();\n\t\t} catch (_e) {\n\t\t\tvoid _e;\n\t\t}\n\t\treturn true;\n\t} catch (_e) {\n\t\tvoid _e;\n\t\treturn false;\n\t}\n}\n\n/**\n * Bridges a ReadableStream to a MessagePort by reading chunks and posting\n * messages to the port. Used as a fallback when transferable streams are not\n * supported (e.g., Safari).\n *\n * Protocol of the returned MessagePort:\n *\n *   { t: 'chunk', b: ArrayBuffer } – next binary chunk\n *   { t: 'close' }                 – end of stream\n *   { t: 'error', m: string }      – terminal error\n */\nfunction streamToPort(stream: ReadableStream<Uint8Array>): MessagePort {\n\tconst { port1, port2 } = new MessageChannel();\n\t(async () => {\n\t\tconst reader = stream.getReader();\n\t\ttry {\n\t\t\twhile (true) {\n\t\t\t\tconst { done, value } = await reader.read();\n\t\t\t\tif (done) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tport1.postMessage({ t: 'close' });\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Ignore error\n\t\t\t\t\t}\n\t\t\t\t\ttry {\n\t\t\t\t\t\tport1.close();\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Ignore error\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (value) {\n\t\t\t\t\t// Ensure we transfer an owned buffer\n\t\t\t\t\tconst owned =\n\t\t\t\t\t\tvalue.byteOffset === 0 &&\n\t\t\t\t\t\tvalue.byteLength === value.buffer.byteLength\n\t\t\t\t\t\t\t? value\n\t\t\t\t\t\t\t: value.slice();\n\t\t\t\t\tconst buf = owned.buffer;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tport1.postMessage({ t: 'chunk', b: buf }, [\n\t\t\t\t\t\t\tbuf as unknown as Transferable,\n\t\t\t\t\t\t]);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tport1.postMessage({\n\t\t\t\t\t\t\tt: 'chunk',\n\t\t\t\t\t\t\tb: owned.buffer.slice(0),\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\ttry {\n\t\t\t\tport1.postMessage({ t: 'error', m: e?.message || String(e) });\n\t\t\t} catch {\n\t\t\t\t// Ignore error\n\t\t\t}\n\t\t} finally {\n\t\t\ttry {\n\t\t\t\tport1.close();\n\t\t\t} catch {\n\t\t\t\t// Ignore error\n\t\t\t}\n\t\t}\n\t})();\n\treturn port2;\n}\n\n/**\n * Reconstructs a ReadableStream from a MessagePort using the inverse of the\n * streamToPort protocol. Each message enqueues data, closes, or errors.\n */\nfunction portToStream(port: MessagePort): ReadableStream<Uint8Array> {\n\treturn new ReadableStream<Uint8Array>({\n\t\tstart(controller) {\n\t\t\tconst onMessage = (ev: MessageEvent) => {\n\t\t\t\tconst data: any = (ev as any).data;\n\t\t\t\tif (!data) return;\n\t\t\t\tswitch (data.t) {\n\t\t\t\t\tcase 'chunk':\n\t\t\t\t\t\tcontroller.enqueue(new Uint8Array(data.b));\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'close':\n\t\t\t\t\t\tcontroller.close();\n\t\t\t\t\t\tcleanup();\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'error':\n\t\t\t\t\t\tcontroller.error(new Error(data.m || 'Stream error'));\n\t\t\t\t\t\tcleanup();\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst cleanup = () => {\n\t\t\t\ttry {\n\t\t\t\t\tport.removeEventListener?.('message', onMessage as any);\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore error\n\t\t\t\t}\n\t\t\t\ttry {\n\t\t\t\t\tport.onmessage = null;\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore error\n\t\t\t\t}\n\t\t\t\ttry {\n\t\t\t\t\tport.close();\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore error\n\t\t\t\t}\n\t\t\t};\n\t\t\tif (port.addEventListener) {\n\t\t\t\tport.addEventListener('message', onMessage as any);\n\t\t\t} else if ((port as any).on) {\n\t\t\t\t(port as any).on('message', (data: any) =>\n\t\t\t\t\tonMessage({ data } as any)\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tport.onmessage = onMessage as any;\n\t\t\t}\n\t\t\tif (typeof port.start === 'function') {\n\t\t\t\tport.start();\n\t\t\t}\n\t\t},\n\t\tcancel() {\n\t\t\ttry {\n\t\t\t\tport.close();\n\t\t\t} catch {\n\t\t\t\t// Ignore error\n\t\t\t}\n\t\t},\n\t});\n}\n\n/**\n * Bridges a Promise to a MessagePort so it can be delivered across threads.\n *\n * Protocol of the returned MessagePort:\n *\n *   { t: 'resolve', v: any } – promise resolved with value v\n *   { t: 'reject',  m: str } – promise rejected with message m\n */\nfunction promiseToPort(promise: Promise<any>): MessagePort {\n\tconst { port1, port2 } = new MessageChannel();\n\tpromise\n\t\t.then((value) => {\n\t\t\ttry {\n\t\t\t\tport1.postMessage({ t: 'resolve', v: value });\n\t\t\t} catch {\n\t\t\t\t// Ignore error\n\t\t\t}\n\t\t})\n\t\t.catch((err) => {\n\t\t\ttry {\n\t\t\t\tport1.postMessage({\n\t\t\t\t\tt: 'reject',\n\t\t\t\t\tm: (err as any)?.message || String(err),\n\t\t\t\t});\n\t\t\t} catch {\n\t\t\t\t// Ignore error\n\t\t\t}\n\t\t})\n\t\t.finally(() => {\n\t\t\ttry {\n\t\t\t\tport1.close();\n\t\t\t} catch {\n\t\t\t\t// Ignore error\n\t\t\t}\n\t\t});\n\treturn port2;\n}\n\n/**\n * Reconstructs a Promise from a MessagePort using the inverse of\n * promiseToPort. Resolves or rejects when the corresponding message arrives.\n */\nfunction portToPromise(port: MessagePort): Promise<any> {\n\treturn new Promise((resolve, reject) => {\n\t\tconst onMessage = (ev: MessageEvent) => {\n\t\t\tconst data: any = (ev as any).data;\n\t\t\tif (!data) return;\n\t\t\tif (data.t === 'resolve') {\n\t\t\t\tcleanup();\n\t\t\t\tresolve(data.v);\n\t\t\t} else if (data.t === 'reject') {\n\t\t\t\tcleanup();\n\t\t\t\treject(new Error(data.m || ''));\n\t\t\t}\n\t\t};\n\t\tconst cleanup = () => {\n\t\t\ttry {\n\t\t\t\tport.removeEventListener?.('message', onMessage as any);\n\t\t\t} catch {\n\t\t\t\t// Ignore error\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tport.onmessage = null;\n\t\t\t} catch {\n\t\t\t\t// Ignore error\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tport.close();\n\t\t\t} catch {\n\t\t\t\t// Ignore error\n\t\t\t}\n\t\t};\n\t\tif (port.addEventListener) {\n\t\t\tport.addEventListener('message', onMessage as any);\n\t\t} else if ((port as any).on) {\n\t\t\t(port as any).on('message', (data: any) =>\n\t\t\t\tonMessage({ data } as any)\n\t\t\t);\n\t\t} else {\n\t\t\tport.onmessage = onMessage as any;\n\t\t}\n\t\tif (typeof port.start === 'function') {\n\t\t\tport.start();\n\t\t}\n\t});\n}\n\n// Augment Comlink's throw handler to include all the information carried by\n// the thrown object, including the cause, additional properties, etc.\ninterface UnserializedError {\n\tvalue: unknown;\n}\ntype SerializedError =\n\t| { isError: true; value: ErrorSerializer.ErrorObject }\n\t| { isError: false; value: unknown };\n\nconst throwTransferHandler = Comlink.transferHandlers.get(\n\t'throw'\n) as Comlink.TransferHandler<UnserializedError, SerializedError>;\n\nconst throwTransferHandlerCustom: Comlink.TransferHandler<\n\tUnserializedError,\n\tSerializedError\n> = {\n\tcanHandle: throwTransferHandler.canHandle,\n\tserialize: ({ value }) => {\n\t\tlet serialized: SerializedError;\n\t\tif (value instanceof Error) {\n\t\t\tserialized = {\n\t\t\t\tisError: true,\n\t\t\t\tvalue: ErrorSerializer.serializeError(value),\n\t\t\t};\n\t\t\t// The error class name is not serialized by serialize-error, let's add it manually.\n\t\t\tserialized.value['originalErrorClassName'] = value.constructor.name;\n\t\t} else {\n\t\t\tserialized = { isError: false, value };\n\t\t}\n\t\treturn [serialized, []];\n\t},\n\tdeserialize: (serialized) => {\n\t\tif (serialized.isError) {\n\t\t\tconst error = ErrorSerializer.deserializeError(serialized.value);\n\t\t\t/**\n\t\t\t * The original error from the web worker does not include any call\n\t\t\t * stack from the Playground web app. Let's include that information\n\t\t\t * in the error chain.\n\t\t\t *\n\t\t\t * We'll place it at the bottom of the error chain. This way the API\n\t\t\t * consumer gets the original error object and not an opaque\n\t\t\t * \"Comlink method call failed\" error, but they can still inspect\n\t\t\t * it further to see the full call stack.\n\t\t\t */\n\t\t\tconst additionalCallStack = new Error('Comlink method call failed');\n\t\t\tlet deepestError = error;\n\t\t\twhile (deepestError.cause) {\n\t\t\t\tdeepestError = deepestError.cause;\n\t\t\t}\n\t\t\tdeepestError.cause = additionalCallStack;\n\t\t\tthrow error;\n\t\t}\n\t\tthrow serialized.value;\n\t},\n};\n\nComlink.transferHandlers.set('throw', throwTransferHandlerCustom);\n\nfunction proxyClone(object: any): any {\n\treturn new Proxy(object, {\n\t\tget(target, prop) {\n\t\t\tswitch (typeof target[prop]) {\n\t\t\t\tcase 'function':\n\t\t\t\t\treturn (...args: any[]) => target[prop](...args);\n\t\t\t\tcase 'object':\n\t\t\t\t\tif (target[prop] === null) {\n\t\t\t\t\t\treturn target[prop];\n\t\t\t\t\t}\n\t\t\t\t\treturn proxyClone(target[prop]);\n\t\t\t\tcase 'undefined':\n\t\t\t\tcase 'number':\n\t\t\t\tcase 'string':\n\t\t\t\t\treturn target[prop];\n\t\t\t\tdefault:\n\t\t\t\t\treturn Comlink.proxy(target[prop]);\n\t\t\t}\n\t\t},\n\t});\n}\n","export function flipObject(obj: Record<any, any>) {\n\treturn Object.fromEntries(Object.entries(obj).map(([k, v]) => [v, k]));\n}\n\nexport function as2Bytes(value: number): Uint8Array {\n\treturn new Uint8Array([(value >> 8) & 0xff, value & 0xff]);\n}\n\nexport function as3Bytes(value: number): Uint8Array {\n\treturn new Uint8Array([\n\t\t(value >> 16) & 0xff,\n\t\t(value >> 8) & 0xff,\n\t\tvalue & 0xff,\n\t]);\n}\n\nexport function as8Bytes(value: number): Uint8Array {\n\tconst buffer = new ArrayBuffer(8);\n\tconst view = new DataView(buffer);\n\tview.setBigUint64(0, BigInt(value), false); // false for big-endian\n\treturn new Uint8Array(buffer);\n}\nexport class ArrayBufferReader {\n\tprivate view: DataView;\n\toffset = 0;\n\tprivate buffer: ArrayBuffer;\n\n\tconstructor(buffer: ArrayBuffer) {\n\t\tthis.buffer = buffer;\n\t\tthis.view = new DataView(buffer);\n\t}\n\n\treadUint8(): number {\n\t\tconst value = this.view.getUint8(this.offset);\n\t\tthis.offset += 1;\n\t\treturn value;\n\t}\n\treadUint16(): number {\n\t\tconst value = this.view.getUint16(this.offset);\n\t\tthis.offset += 2;\n\t\treturn value;\n\t}\n\treadUint32(): number {\n\t\tconst value = this.view.getUint32(this.offset);\n\t\tthis.offset += 4;\n\t\treturn value;\n\t}\n\treadUint8Array(length: number): Uint8Array {\n\t\tconst value = this.buffer.slice(this.offset, this.offset + length);\n\t\tthis.offset += length;\n\t\treturn new Uint8Array(value);\n\t}\n\n\tisFinished() {\n\t\treturn this.offset >= this.buffer.byteLength;\n\t}\n}\n\nexport class ArrayBufferWriter {\n\tbuffer: ArrayBuffer;\n\tview: DataView;\n\tuint8Array: Uint8Array;\n\n\tprivate offset = 0;\n\n\tconstructor(length: number) {\n\t\tthis.buffer = new ArrayBuffer(length);\n\t\tthis.uint8Array = new Uint8Array(this.buffer);\n\t\tthis.view = new DataView(this.buffer);\n\t}\n\n\twriteUint8(value: number) {\n\t\tthis.view.setUint8(this.offset, value);\n\t\tthis.offset += 1;\n\t}\n\n\twriteUint16(value: number) {\n\t\tthis.view.setUint16(this.offset, value);\n\t\tthis.offset += 2;\n\t}\n\n\twriteUint32(value: number) {\n\t\tthis.view.setUint32(this.offset, value);\n\t\tthis.offset += 4;\n\t}\n\n\twriteUint8Array(value: Uint8Array) {\n\t\tthis.uint8Array.set(value, this.offset);\n\t\tthis.offset += value.length;\n\t}\n}\n","/**\n * IANA maintains a list of TLS extensions here:\n * https://www.iana.org/assignments/tls-extensiontype-values/tls-extensiontype-values.xhtml\n */\nexport const ExtensionTypes = {\n\tserver_name: 0,\n\tmax_fragment_length: 1,\n\tclient_certificate_url: 2,\n\ttrusted_ca_keys: 3,\n\ttruncated_hmac: 4,\n\tstatus_request: 5,\n\tuser_mapping: 6,\n\tclient_authz: 7,\n\tserver_authz: 8,\n\tcert_type: 9,\n\tsupported_groups: 10,\n\tec_point_formats: 11,\n\tsrp: 12,\n\tsignature_algorithms: 13,\n\tuse_srtp: 14,\n\theartbeat: 15,\n\tapplication_layer_protocol_negotiation: 16,\n\tstatus_request_v2: 17,\n\tsigned_certificate_timestamp: 18,\n\tclient_certificate_type: 19,\n\tserver_certificate_type: 20,\n\tpadding: 21,\n\tencrypt_then_mac: 22,\n\textended_master_secret: 23,\n\ttoken_binding: 24,\n\tcached_info: 25,\n\ttls_its: 26,\n\tcompress_certificate: 27,\n\trecord_size_limit: 28,\n\tpwd_protect: 29,\n\tpwo_clear: 30,\n\tpassword_salt: 31,\n\tticket_pinning: 32,\n\ttls_cert_with_extern_psk: 33,\n\tdelegated_credential: 34,\n\tsession_ticket: 35,\n\tTLMSP: 36,\n\tTLMSP_proxying: 37,\n\tTLMSP_delegate: 38,\n\tsupported_ekt_ciphers: 39,\n\tpre_shared_key: 41,\n\tearly_data: 42,\n\tsupported_versions: 43,\n\tcookie: 44,\n\tpsk_key_exchange_modes: 45,\n\treserved: 46,\n\tcertificate_authorities: 47,\n\toid_filters: 48,\n\tpost_handshake_auth: 49,\n\tsignature_algorithms_cert: 50,\n\tkey_share: 51,\n\ttransparency_info: 52,\n\tconnection_id: 54,\n} as const;\n\nimport { flipObject } from '../utils';\n\nexport type ExtensionType = keyof typeof ExtensionTypes;\n\nexport const ExtensionNames = flipObject(ExtensionTypes);\nexport type ExtensionName = keyof typeof ExtensionNames;\n","/**\n * TLS server_name extension\n * https://www.rfc-editor.org/rfc/rfc6066.html\n */\n\nimport { ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\n\nexport interface ServerNameList {\n\tserver_name_list: ServerName[];\n}\n\nexport interface ServerName {\n\tname_type: typeof ServerNameTypes;\n\tname: {\n\t\thost_name: string;\n\t};\n}\n\nexport const ServerNameTypes = {\n\thost_name: 0,\n} as const;\nexport type ServerNameType =\n\t(typeof ServerNameTypes)[keyof typeof ServerNameTypes];\nexport const ServerNameNames = flipObject(ServerNameTypes);\n\nexport class ServerNameExtension {\n\tstatic decodeFromClient(data: Uint8Array): ServerNameList {\n\t\tconst view = new DataView(data.buffer);\n\t\tlet offset = 0;\n\n\t\tconst listLength = view.getUint16(offset);\n\t\toffset += 2;\n\n\t\tconst serverNameList: ServerName[] = [];\n\n\t\twhile (offset < listLength + 2) {\n\t\t\tconst nameType = data[offset] as ServerNameType;\n\t\t\toffset += 1;\n\n\t\t\tconst valueLength = view.getUint16(offset);\n\t\t\toffset += 2;\n\n\t\t\tconst value = data.slice(offset, offset + valueLength);\n\t\t\toffset += valueLength;\n\n\t\t\tswitch (nameType) {\n\t\t\t\tcase ServerNameTypes.host_name:\n\t\t\t\t\tserverNameList.push({\n\t\t\t\t\t\tname_type: ServerNameNames[nameType],\n\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\thost_name: new TextDecoder().decode(value),\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new Error(`Unsupported name type ${nameType}`);\n\t\t\t}\n\t\t}\n\n\t\treturn { server_name_list: serverNameList };\n\t}\n\n\t/**\n\t * Encode the server_name extension\n\t *\n\t * +------------------------------------+\n\t * | Extension Type (server_name) [2B]  |\n\t * | 0x00 0x00                          |\n\t * +------------------------------------+\n\t * | Extension Length             [2B]  |\n\t * | 0x00 0x00                          |\n\t * +------------------------------------+\n\t */\n\tstatic encodeForClient(serverNames?: ServerNameList) {\n\t\tif (serverNames?.server_name_list.length) {\n\t\t\tthrow new Error(\n\t\t\t\t'Encoding non-empty lists for ClientHello is not supported yet. ' +\n\t\t\t\t\t'Only empty lists meant for ServerHello are supported today.'\n\t\t\t);\n\t\t}\n\n\t\tconst writer = new ArrayBufferWriter(4);\n\t\twriter.writeUint16(ExtensionTypes.server_name);\n\t\t// Zero body length encoded using two bytes\n\t\twriter.writeUint16(0);\n\t\treturn writer.uint8Array;\n\t}\n}\n","import { flipObject } from './utils';\n\n/**\n * TLS1 cipher suites sourced from OpenSSL:\n *\n * https://github.com/openssl/openssl/blob/36254fda37fe169e136079404a3c32aeea35cbd4/include/openssl/tls1.h#L371\n */\nexport const CipherSuites = {\n\tTLS1_CK_PSK_WITH_RC4_128_SHA: 0x008a,\n\tTLS1_CK_PSK_WITH_3DES_EDE_CBC_SHA: 0x008b,\n\tTLS1_CK_PSK_WITH_AES_128_CBC_SHA: 0x008c,\n\tTLS1_CK_PSK_WITH_AES_256_CBC_SHA: 0x008d,\n\tTLS1_CK_DHE_PSK_WITH_RC4_128_SHA: 0x008e,\n\tTLS1_CK_DHE_PSK_WITH_3DES_EDE_CBC_SHA: 0x008f,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CBC_SHA: 0x0090,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CBC_SHA: 0x0091,\n\tTLS1_CK_RSA_PSK_WITH_RC4_128_SHA: 0x0092,\n\tTLS1_CK_RSA_PSK_WITH_3DES_EDE_CBC_SHA: 0x0093,\n\tTLS1_CK_RSA_PSK_WITH_AES_128_CBC_SHA: 0x0094,\n\tTLS1_CK_RSA_PSK_WITH_AES_256_CBC_SHA: 0x0095,\n\tTLS1_CK_PSK_WITH_AES_128_GCM_SHA256: 0x00a8,\n\tTLS1_CK_PSK_WITH_AES_256_GCM_SHA384: 0x00a9,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_GCM_SHA256: 0x00aa,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_GCM_SHA384: 0x00ab,\n\tTLS1_CK_RSA_PSK_WITH_AES_128_GCM_SHA256: 0x00ac,\n\tTLS1_CK_RSA_PSK_WITH_AES_256_GCM_SHA384: 0x00ad,\n\tTLS1_CK_PSK_WITH_AES_128_CBC_SHA256: 0x00ae,\n\tTLS1_CK_PSK_WITH_AES_256_CBC_SHA384: 0x00af,\n\tTLS1_CK_PSK_WITH_NULL_SHA256: 0x00b0,\n\tTLS1_CK_PSK_WITH_NULL_SHA384: 0x00b1,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CBC_SHA256: 0x00b2,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CBC_SHA384: 0x00b3,\n\tTLS1_CK_DHE_PSK_WITH_NULL_SHA256: 0x00b4,\n\tTLS1_CK_DHE_PSK_WITH_NULL_SHA384: 0x00b5,\n\tTLS1_CK_RSA_PSK_WITH_AES_128_CBC_SHA256: 0x00b6,\n\tTLS1_CK_RSA_PSK_WITH_AES_256_CBC_SHA384: 0x00b7,\n\tTLS1_CK_RSA_PSK_WITH_NULL_SHA256: 0x00b8,\n\tTLS1_CK_RSA_PSK_WITH_NULL_SHA384: 0x00b9,\n\tTLS1_CK_PSK_WITH_NULL_SHA: 0x002c,\n\tTLS1_CK_DHE_PSK_WITH_NULL_SHA: 0x002d,\n\tTLS1_CK_RSA_PSK_WITH_NULL_SHA: 0x002e,\n\tTLS1_CK_RSA_WITH_AES_128_SHA: 0x002f,\n\tTLS1_CK_DH_DSS_WITH_AES_128_SHA: 0x0030,\n\tTLS1_CK_DH_RSA_WITH_AES_128_SHA: 0x0031,\n\tTLS1_CK_DHE_DSS_WITH_AES_128_SHA: 0x0032,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_SHA: 0x0033,\n\tTLS1_CK_ADH_WITH_AES_128_SHA: 0x0034,\n\tTLS1_CK_RSA_WITH_AES_256_SHA: 0x0035,\n\tTLS1_CK_DH_DSS_WITH_AES_256_SHA: 0x0036,\n\tTLS1_CK_DH_RSA_WITH_AES_256_SHA: 0x0037,\n\tTLS1_CK_DHE_DSS_WITH_AES_256_SHA: 0x0038,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_SHA: 0x0039,\n\tTLS1_CK_ADH_WITH_AES_256_SHA: 0x003a,\n\tTLS1_CK_RSA_WITH_NULL_SHA256: 0x003b,\n\tTLS1_CK_RSA_WITH_AES_128_SHA256: 0x003c,\n\tTLS1_CK_RSA_WITH_AES_256_SHA256: 0x003d,\n\tTLS1_CK_DH_DSS_WITH_AES_128_SHA256: 0x003e,\n\tTLS1_CK_DH_RSA_WITH_AES_128_SHA256: 0x003f,\n\tTLS1_CK_DHE_DSS_WITH_AES_128_SHA256: 0x0040,\n\tTLS1_CK_RSA_WITH_CAMELLIA_128_CBC_SHA: 0x0041,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_128_CBC_SHA: 0x0042,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_128_CBC_SHA: 0x0043,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA: 0x0044,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA: 0x0045,\n\tTLS1_CK_ADH_WITH_CAMELLIA_128_CBC_SHA: 0x0046,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_SHA256: 0x0067,\n\tTLS1_CK_DH_DSS_WITH_AES_256_SHA256: 0x0068,\n\tTLS1_CK_DH_RSA_WITH_AES_256_SHA256: 0x0069,\n\tTLS1_CK_DHE_DSS_WITH_AES_256_SHA256: 0x006a,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_SHA256: 0x006b,\n\tTLS1_CK_ADH_WITH_AES_128_SHA256: 0x006c,\n\tTLS1_CK_ADH_WITH_AES_256_SHA256: 0x006d,\n\tTLS1_CK_RSA_WITH_CAMELLIA_256_CBC_SHA: 0x0084,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_256_CBC_SHA: 0x0085,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_256_CBC_SHA: 0x0086,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA: 0x0087,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA: 0x0088,\n\tTLS1_CK_ADH_WITH_CAMELLIA_256_CBC_SHA: 0x0089,\n\tTLS1_CK_RSA_WITH_SEED_SHA: 0x0096,\n\tTLS1_CK_DH_DSS_WITH_SEED_SHA: 0x0097,\n\tTLS1_CK_DH_RSA_WITH_SEED_SHA: 0x0098,\n\tTLS1_CK_DHE_DSS_WITH_SEED_SHA: 0x0099,\n\tTLS1_CK_DHE_RSA_WITH_SEED_SHA: 0x009a,\n\tTLS1_CK_ADH_WITH_SEED_SHA: 0x009b,\n\tTLS1_CK_RSA_WITH_AES_128_GCM_SHA256: 0x009c,\n\tTLS1_CK_RSA_WITH_AES_256_GCM_SHA384: 0x009d,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_GCM_SHA256: 0x009e,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_GCM_SHA384: 0x009f,\n\tTLS1_CK_DH_RSA_WITH_AES_128_GCM_SHA256: 0x00a0,\n\tTLS1_CK_DH_RSA_WITH_AES_256_GCM_SHA384: 0x00a1,\n\tTLS1_CK_DHE_DSS_WITH_AES_128_GCM_SHA256: 0x00a2,\n\tTLS1_CK_DHE_DSS_WITH_AES_256_GCM_SHA384: 0x00a3,\n\tTLS1_CK_DH_DSS_WITH_AES_128_GCM_SHA256: 0x00a4,\n\tTLS1_CK_DH_DSS_WITH_AES_256_GCM_SHA384: 0x00a5,\n\tTLS1_CK_ADH_WITH_AES_128_GCM_SHA256: 0x00a6,\n\tTLS1_CK_ADH_WITH_AES_256_GCM_SHA384: 0x00a7,\n\tTLS1_CK_RSA_WITH_AES_128_CCM: 0xc09c,\n\tTLS1_CK_RSA_WITH_AES_256_CCM: 0xc09d,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_CCM: 0xc09e,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_CCM: 0xc09f,\n\tTLS1_CK_RSA_WITH_AES_128_CCM_8: 0xc0a0,\n\tTLS1_CK_RSA_WITH_AES_256_CCM_8: 0xc0a1,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_CCM_8: 0xc0a2,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_CCM_8: 0xc0a3,\n\tTLS1_CK_PSK_WITH_AES_128_CCM: 0xc0a4,\n\tTLS1_CK_PSK_WITH_AES_256_CCM: 0xc0a5,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CCM: 0xc0a6,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CCM: 0xc0a7,\n\tTLS1_CK_PSK_WITH_AES_128_CCM_8: 0xc0a8,\n\tTLS1_CK_PSK_WITH_AES_256_CCM_8: 0xc0a9,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CCM_8: 0xc0aa,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CCM_8: 0xc0ab,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_CCM: 0xc0ac,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_CCM: 0xc0ad,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_CCM_8: 0xc0ae,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_CCM_8: 0xc0af,\n\tTLS1_CK_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0x00ba,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_128_CBC_SHA256: 0x00bb,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0x00bc,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA256: 0x00bd,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0x00be,\n\tTLS1_CK_ADH_WITH_CAMELLIA_128_CBC_SHA256: 0x00bf,\n\tTLS1_CK_RSA_WITH_CAMELLIA_256_CBC_SHA256: 0x00c0,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_256_CBC_SHA256: 0x00c1,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_256_CBC_SHA256: 0x00c2,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA256: 0x00c3,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA256: 0x00c4,\n\tTLS1_CK_ADH_WITH_CAMELLIA_256_CBC_SHA256: 0x00c5,\n\tTLS1_CK_ECDH_ECDSA_WITH_NULL_SHA: 0xc001,\n\tTLS1_CK_ECDH_ECDSA_WITH_RC4_128_SHA: 0xc002,\n\tTLS1_CK_ECDH_ECDSA_WITH_DES_192_CBC3_SHA: 0xc003,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_128_CBC_SHA: 0xc004,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_256_CBC_SHA: 0xc005,\n\tTLS1_CK_ECDHE_ECDSA_WITH_NULL_SHA: 0xc006,\n\tTLS1_CK_ECDHE_ECDSA_WITH_RC4_128_SHA: 0xc007,\n\tTLS1_CK_ECDHE_ECDSA_WITH_DES_192_CBC3_SHA: 0xc008,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_CBC_SHA: 0xc009,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_CBC_SHA: 0xc00a,\n\tTLS1_CK_ECDH_RSA_WITH_NULL_SHA: 0xc00b,\n\tTLS1_CK_ECDH_RSA_WITH_RC4_128_SHA: 0xc00c,\n\tTLS1_CK_ECDH_RSA_WITH_DES_192_CBC3_SHA: 0xc00d,\n\tTLS1_CK_ECDH_RSA_WITH_AES_128_CBC_SHA: 0xc00e,\n\tTLS1_CK_ECDH_RSA_WITH_AES_256_CBC_SHA: 0xc00f,\n\tTLS1_CK_ECDHE_RSA_WITH_NULL_SHA: 0xc010,\n\tTLS1_CK_ECDHE_RSA_WITH_RC4_128_SHA: 0xc011,\n\tTLS1_CK_ECDHE_RSA_WITH_DES_192_CBC3_SHA: 0xc012,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_128_CBC_SHA: 0xc013,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_256_CBC_SHA: 0xc014,\n\tTLS1_CK_ECDH_anon_WITH_NULL_SHA: 0xc015,\n\tTLS1_CK_ECDH_anon_WITH_RC4_128_SHA: 0xc016,\n\tTLS1_CK_ECDH_anon_WITH_DES_192_CBC3_SHA: 0xc017,\n\tTLS1_CK_ECDH_anon_WITH_AES_128_CBC_SHA: 0xc018,\n\tTLS1_CK_ECDH_anon_WITH_AES_256_CBC_SHA: 0xc019,\n\tTLS1_CK_SRP_SHA_WITH_3DES_EDE_CBC_SHA: 0xc01a,\n\tTLS1_CK_SRP_SHA_RSA_WITH_3DES_EDE_CBC_SHA: 0xc01b,\n\tTLS1_CK_SRP_SHA_DSS_WITH_3DES_EDE_CBC_SHA: 0xc01c,\n\tTLS1_CK_SRP_SHA_WITH_AES_128_CBC_SHA: 0xc01d,\n\tTLS1_CK_SRP_SHA_RSA_WITH_AES_128_CBC_SHA: 0xc01e,\n\tTLS1_CK_SRP_SHA_DSS_WITH_AES_128_CBC_SHA: 0xc01f,\n\tTLS1_CK_SRP_SHA_WITH_AES_256_CBC_SHA: 0xc020,\n\tTLS1_CK_SRP_SHA_RSA_WITH_AES_256_CBC_SHA: 0xc021,\n\tTLS1_CK_SRP_SHA_DSS_WITH_AES_256_CBC_SHA: 0xc022,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_SHA256: 0xc023,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_SHA384: 0xc024,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_128_SHA256: 0xc025,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_256_SHA384: 0xc026,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_128_SHA256: 0xc027,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_256_SHA384: 0xc028,\n\tTLS1_CK_ECDH_RSA_WITH_AES_128_SHA256: 0xc029,\n\tTLS1_CK_ECDH_RSA_WITH_AES_256_SHA384: 0xc02a,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256: 0xc02b,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384: 0xc02c,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_128_GCM_SHA256: 0xc02d,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_256_GCM_SHA384: 0xc02e,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256: 0xc02f,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_256_GCM_SHA384: 0xc030,\n\tTLS1_CK_ECDH_RSA_WITH_AES_128_GCM_SHA256: 0xc031,\n\tTLS1_CK_ECDH_RSA_WITH_AES_256_GCM_SHA384: 0xc032,\n\tTLS1_CK_ECDHE_PSK_WITH_RC4_128_SHA: 0xc033,\n\tTLS1_CK_ECDHE_PSK_WITH_3DES_EDE_CBC_SHA: 0xc034,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_128_CBC_SHA: 0xc035,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_256_CBC_SHA: 0xc036,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_128_CBC_SHA256: 0xc037,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_256_CBC_SHA384: 0xc038,\n\tTLS1_CK_ECDHE_PSK_WITH_NULL_SHA: 0xc039,\n\tTLS1_CK_ECDHE_PSK_WITH_NULL_SHA256: 0xc03a,\n\tTLS1_CK_ECDHE_PSK_WITH_NULL_SHA384: 0xc03b,\n\tTLS1_CK_ECDHE_ECDSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc072,\n\tTLS1_CK_ECDHE_ECDSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc073,\n\tTLS1_CK_ECDH_ECDSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc074,\n\tTLS1_CK_ECDH_ECDSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc075,\n\tTLS1_CK_ECDHE_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc076,\n\tTLS1_CK_ECDHE_RSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc077,\n\tTLS1_CK_ECDH_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc078,\n\tTLS1_CK_ECDH_RSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc079,\n\tTLS1_CK_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc094,\n\tTLS1_CK_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc095,\n\tTLS1_CK_DHE_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc096,\n\tTLS1_CK_DHE_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc097,\n\tTLS1_CK_RSA_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc098,\n\tTLS1_CK_RSA_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc099,\n\tTLS1_CK_ECDHE_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc09a,\n\tTLS1_CK_ECDHE_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc09b,\n\tTLS1_CK_ECDHE_RSA_WITH_CHACHA20_POLY1305: 0xcca8,\n\tTLS1_CK_ECDHE_ECDSA_WITH_CHACHA20_POLY1305: 0xcca9,\n\tTLS1_CK_DHE_RSA_WITH_CHACHA20_POLY1305: 0xccaa,\n\tTLS1_CK_PSK_WITH_CHACHA20_POLY1305: 0xccab,\n\tTLS1_CK_ECDHE_PSK_WITH_CHACHA20_POLY1305: 0xccac,\n\tTLS1_CK_DHE_PSK_WITH_CHACHA20_POLY1305: 0xccad,\n\tTLS1_CK_RSA_PSK_WITH_CHACHA20_POLY1305: 0xccae,\n} as const;\n\nexport const CipherSuitesNames = flipObject(CipherSuites);\n","/**\n * TLS supported_groups extension\n * https://www.iana.org/go/rfc7919\n * https://www.iana.org/go/rfc8422\n */\n\nimport { ArrayBufferReader, ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\n\nexport const SupportedGroups = {\n\tsecp256r1: 23,\n\tsecp384r1: 24,\n\tsecp521r1: 25,\n\tx25519: 29,\n\tx448: 30,\n} as const;\nexport const SupportedGroupsNames = flipObject(SupportedGroups);\nexport type SupportedGroup = keyof typeof SupportedGroups;\n\nexport type ParsedSupportedGroups = (keyof typeof SupportedGroups)[];\n\nexport class SupportedGroupsExtension {\n\t/**\n\t * +--------------------------------------------------+\n\t * | Payload Length                            [2B]   |\n\t * +--------------------------------------------------+\n\t * | Supported Groups List Length              [2B]   |\n\t * +--------------------------------------------------+\n\t * | Supported Group 1                         [2B]   |\n\t * +--------------------------------------------------+\n\t * | Supported Group 2                         [2B]   |\n\t * +--------------------------------------------------+\n\t * | ...                                              |\n\t * +--------------------------------------------------+\n\t * | Supported Group n                         [2B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic decodeFromClient(data: Uint8Array): ParsedSupportedGroups {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\t// Skip the length field\n\t\treader.readUint16();\n\t\tconst groups = [];\n\t\twhile (!reader.isFinished()) {\n\t\t\tconst group = reader.readUint16();\n\t\t\tif (!(group in SupportedGroupsNames)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tgroups.push(SupportedGroupsNames[group]);\n\t\t}\n\t\treturn groups;\n\t}\n\n\t/**\n\t * +--------------------------------------------------+\n\t * | Extension Type (supported_groups)         [2B]   |\n\t * | 0x00 0x0A                                        |\n\t * +--------------------------------------------------+\n\t * | Extension Length                          [2B]   |\n\t * +--------------------------------------------------+\n\t * | Selected Group                            [2B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic encodeForClient(group: SupportedGroup): Uint8Array {\n\t\tconst writer = new ArrayBufferWriter(6);\n\t\twriter.writeUint16(ExtensionTypes.supported_groups);\n\t\twriter.writeUint16(2);\n\t\twriter.writeUint16(SupportedGroups[group]);\n\t\treturn writer.uint8Array;\n\t}\n}\n","/**\n * TLS ec_point_formats extension\n * https://www.rfc-editor.org/rfc/rfc4492#section-5.1.2\n */\n\nimport { ArrayBufferReader, ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\n\nexport const ECPointFormats = {\n\tuncompressed: 0,\n\tansiX962_compressed_prime: 1,\n\tansiX962_compressed_char2: 2,\n} as const;\nexport type ECPointFormat = keyof typeof ECPointFormats;\n\nexport const ECPointFormatNames = flipObject(ECPointFormats);\n\nexport type ParsedECPointFormats = (keyof typeof ECPointFormats)[];\n\nexport class ECPointFormatsExtension {\n\t/**\n\t * +--------------------------------------------------+\n\t * | Payload Length                            [2B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Formats Length                   [1B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format 1                         [1B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format 2                         [1B]   |\n\t * +--------------------------------------------------+\n\t * | ...                                              |\n\t * +--------------------------------------------------+\n\t * | EC Point Format n                         [1B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic decodeFromClient(data: Uint8Array): ParsedECPointFormats {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\t// Read the EC Point Formats Length\n\t\tconst length = reader.readUint8();\n\t\tconst formats = [];\n\t\tfor (let i = 0; i < length; i++) {\n\t\t\tconst format = reader.readUint8();\n\t\t\tif (format in ECPointFormatNames) {\n\t\t\t\tformats.push(ECPointFormatNames[format]);\n\t\t\t}\n\t\t}\n\t\treturn formats;\n\t}\n\n\t/**\n\t * Encode the ec_point_formats extension\n\t *\n\t * +--------------------------------------------------+\n\t * | Extension Type (ec_point_formats)         [2B]   |\n\t * | 0x00 0x0B                                        |\n\t * +--------------------------------------------------+\n\t * | Body Length                               [2B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format Length                    [1B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format                           [1B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic encodeForClient(format: ECPointFormat): Uint8Array {\n\t\tconst writer = new ArrayBufferWriter(6);\n\t\twriter.writeUint16(ExtensionTypes.ec_point_formats);\n\t\twriter.writeUint16(2); // Body length\n\t\twriter.writeUint8(1); // EC Point Formats Length\n\t\twriter.writeUint8(ECPointFormats[format]);\n\t\treturn writer.uint8Array;\n\t}\n}\n","/**\n * TLS signature_algorithms extension\n * https://www.rfc-editor.org/rfc/rfc8446.html#page-41\n */\n\nimport { ArrayBufferReader, ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\nimport { logger } from '@php-wasm/logger';\n\n/**\n * A list of supported signature algorithms,\n * one byte per algorithm.\n */\nexport type SignatureAlgorithms = Uint8Array;\n\n/**\n * Signature algorithms from\n * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.1.4.1\n */\nexport const SignatureAlgorithms = {\n\tanonymous: 0,\n\trsa: 1,\n\tdsa: 2,\n\tecdsa: 3,\n};\nexport type SignatureAlgorithm = keyof typeof SignatureAlgorithms;\nexport const SignatureAlgorithmsNames = flipObject(SignatureAlgorithms);\n\n/**\n * Hash algorithms from\n * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.1.4.1\n */\nexport const HashAlgorithms = {\n\tnone: 0,\n\tmd5: 1,\n\tsha1: 2,\n\tsha224: 3,\n\tsha256: 4,\n\tsha384: 5,\n\tsha512: 6,\n};\nexport type HashAlgorithm = keyof typeof HashAlgorithms;\nexport const HashAlgorithmsNames = flipObject(HashAlgorithms);\n\nexport type ParsedSignatureAlgorithm = {\n\thash: HashAlgorithm;\n\talgorithm: SignatureAlgorithm;\n};\n\n/**\n * Handles the signature algorithms extension as defined in\n * https://www.rfc-editor.org/rfc/rfc8446.html#page-41\n */\nexport class SignatureAlgorithmsExtension {\n\t/**\n\t * Binary layout:\n\t *\n\t * +------------------------------------+\n\t * | Payload Length              [2B]   |\n\t * +------------------------------------+\n\t * | Hash Algorithm 1            [1B]   |\n\t * | Signature Algorithm 1       [1B]   |\n\t * +------------------------------------+\n\t * | Hash Algorithm 2            [1B]   |\n\t * | Signature Algorithm 2       [1B]   |\n\t * +------------------------------------+\n\t * | ...                                |\n\t * +------------------------------------+\n\t */\n\tstatic decodeFromClient(data: Uint8Array): ParsedSignatureAlgorithm[] {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\treader.readUint16(); // Skip algorithms length\n\t\tconst parsedAlgorithms: ParsedSignatureAlgorithm[] = [];\n\t\twhile (!reader.isFinished()) {\n\t\t\tconst hash = reader.readUint8();\n\t\t\tconst algorithm = reader.readUint8();\n\t\t\tif (!SignatureAlgorithmsNames[algorithm]) {\n\t\t\t\t// Unknown signature algorithm. It's fine, the client just supports\n\t\t\t\t// more algorithms than the server.\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (!HashAlgorithmsNames[hash]) {\n\t\t\t\tlogger.warn(`Unknown hash algorithm: ${hash}`);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tparsedAlgorithms.push({\n\t\t\t\talgorithm: SignatureAlgorithmsNames[algorithm],\n\t\t\t\thash: HashAlgorithmsNames[hash],\n\t\t\t});\n\t\t}\n\t\treturn parsedAlgorithms;\n\t}\n\n\t/**\n\t * +--------------------------------------------------+\n\t * | Extension Type (signature_algorithms)     [2B]   |\n\t * | 0x00 0x0D                                        |\n\t * +--------------------------------------------------+\n\t * | Body Length                               [2B]   |\n\t * +--------------------------------------------------+\n\t * | Hash Algorithm                            [1B]   |\n\t * | Signature Algorithm                       [1B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic encodeforClient(\n\t\thash: HashAlgorithm,\n\t\talgorithm: SignatureAlgorithm\n\t): Uint8Array {\n\t\tconst writer = new ArrayBufferWriter(6);\n\t\twriter.writeUint16(ExtensionTypes.signature_algorithms);\n\t\twriter.writeUint16(2);\n\t\twriter.writeUint8(HashAlgorithms[hash]);\n\t\twriter.writeUint8(SignatureAlgorithms[algorithm]);\n\t\treturn writer.uint8Array;\n\t}\n}\n","/**\n * TLS 1.2 Record layer types defined after the structs\n * from the TLS 1.2 RFC.\n * https://datatracker.ietf.org/doc/html/rfc5246#section-6.2\n */\n\nimport type { ParsedExtension } from '../extensions/parse-extensions';\nimport { flipObject } from '../utils';\n\nexport const CompressionMethod = {\n\tNull: 0,\n\tDeflate: 1,\n} as const;\nexport type CompressionMethod =\n\t(typeof CompressionMethod)[keyof typeof CompressionMethod];\n\n/**\n * TLS 1.2 Record layer types defined after the structs\n * from the TLS 1.2 RFC.\n * https://datatracker.ietf.org/doc/html/rfc5246#section-6.2.1\n */\n\nexport interface TLSRecord {\n\ttype: ContentType; // 1 byte\n\tversion: ProtocolVersion; // 2 bytes\n\tlength: number; // 2 bytes\n\tfragment: Uint8Array; // variable length\n}\n\nexport interface ProtocolVersion {\n\tmajor: number;\n\tminor: number;\n}\n\nexport interface GenericStreamCipher {\n\tcontent: Uint8Array;\n\tMAC: Uint8Array;\n}\n\nexport interface GenericBlockCipher {\n\tIV: Uint8Array;\n\tblock_ciphered: BlockCiphered;\n}\n\nexport interface BlockCiphered {\n\tcontent: Uint8Array;\n\tMAC: Uint8Array;\n\tpadding: Uint8Array;\n\tpadding_length: number;\n}\n\nexport interface GenericAEADCipher {\n\tnonce_explicit: Uint8Array;\n\taead_encrypted: Uint8Array;\n}\n\n/**\n * TLS 1.2 Handshake types defined after the structs\n * from the TLS 1.2 RFC.\n * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4\n */\n\nexport type TLSMessage =\n\t| AlertMessage\n\t| HandshakeMessage<any>\n\t| ChangeCipherSpecMessage\n\t| ApplicationDataMessage;\n\nexport interface AlertMessage {\n\ttype: typeof ContentTypes.Alert;\n\tlevel: AlertLevel;\n\tdescription: AlertDescription;\n}\n\nexport const AlertLevels = {\n\tWarning: 1,\n\tFatal: 2,\n} as const;\nexport type AlertLevel = (typeof AlertLevels)[keyof typeof AlertLevels];\nexport const AlertLevelNames = flipObject(AlertLevels);\n\nexport const AlertDescriptions = {\n\tCloseNotify: 0,\n\tUnexpectedMessage: 10,\n\tBadRecordMac: 20,\n\tDecryptionFailed: 21,\n\tRecordOverflow: 22,\n\tDecompressionFailure: 30,\n\tHandshakeFailure: 40,\n\tNoCertificate: 41,\n\tBadCertificate: 42,\n\tUnsupportedCertificate: 43,\n\tCertificateRevoked: 44,\n\tCertificateExpired: 45,\n\tCertificateUnknown: 46,\n\tIllegalParameter: 47,\n\tUnknownCa: 48,\n\tAccessDenied: 49,\n\tDecodeError: 50,\n\tDecryptError: 51,\n\tExportRestriction: 60,\n\tProtocolVersion: 70,\n\tInsufficientSecurity: 71,\n\tInternalError: 80,\n\tUserCanceled: 90,\n\tNoRenegotiation: 100,\n\tUnsupportedExtension: 110,\n} as const;\nexport type AlertDescription =\n\t(typeof AlertDescriptions)[keyof typeof AlertDescriptions];\nexport const AlertDescriptionNames = flipObject(AlertDescriptions);\n\nexport interface ChangeCipherSpecMessage {\n\ttype: typeof ContentTypes.ChangeCipherSpec;\n\tbody: Uint8Array;\n}\n\nexport interface ApplicationDataMessage {\n\ttype: typeof ContentTypes.ApplicationData;\n\tbody: Uint8Array;\n}\n\nexport const ContentTypes = {\n\tChangeCipherSpec: 20,\n\tAlert: 21,\n\tHandshake: 22,\n\tApplicationData: 23,\n} as const;\nexport type ContentType = (typeof ContentTypes)[keyof typeof ContentTypes];\n\nexport const HandshakeType = {\n\tHelloRequest: 0,\n\tClientHello: 1,\n\tServerHello: 2,\n\tCertificate: 11,\n\tServerKeyExchange: 12,\n\tCertificateRequest: 13,\n\tServerHelloDone: 14,\n\tCertificateVerify: 15,\n\tClientKeyExchange: 16,\n\tFinished: 20,\n} as const;\nexport type HandshakeType = (typeof HandshakeType)[keyof typeof HandshakeType];\n\nexport type HandshakeMessageBody =\n\t| HelloRequest\n\t| ClientHello\n\t| ServerHello\n\t| Certificate\n\t| ServerKeyExchange\n\t| CertificateRequest\n\t| ServerHelloDone\n\t| CertificateVerify\n\t| ClientKeyExchange\n\t| Finished;\n\nexport interface HandshakeMessage<Body extends HandshakeMessageBody> {\n\ttype: typeof ContentTypes.Handshake;\n\tmsg_type: HandshakeType; // 1 byte\n\tlength: number; // 2 bytes\n\t// Custom property to hold the raw body of the message\n\tbody: Body;\n}\n\n// Specific Handshake Message Types\n// eslint-disable-next-line @typescript-eslint/no-empty-object-type\nexport interface HelloRequest {} // Empty for TLS 1.2\n\n/**\n * 1 byte\n */\nexport type SessionId = Uint8Array;\nexport interface ClientHello {\n\tclient_version: Uint8Array; // 2 bytes\n\trandom: Uint8Array; // 32 bytes\n\tsession_id: SessionId;\n\tcipher_suites: string[];\n\tcompression_methods: Uint8Array;\n\textensions: ParsedExtension[];\n}\n\nexport interface ServerHello {\n\tserver_version: Uint8Array; // 2 bytes\n\trandom: Uint8Array; // 32 bytes\n\tsession_id: Uint8Array;\n\tcipher_suite: Uint8Array; // 2 bytes\n\tcompression_method: number;\n\textensions?: Uint8Array;\n}\n\nexport interface Certificate {\n\tcertificate_list: Uint8Array[];\n}\n\nexport interface ServerKeyExchange {\n\tparams: Uint8Array;\n\tsigned_params: Uint8Array;\n}\n\n/**\n * ECCurveType from\n * https://datatracker.ietf.org/doc/html/rfc4492#section-5.4\n */\nexport const ECCurveTypes = {\n\t/**\n\t * Indicates the elliptic curve domain parameters are\n\t * conveyed verbosely, and the underlying finite field is a prime\n\t * field.\n\t */\n\tExplicitPrime: 1,\n\t/**\n\t * Indicates the elliptic curve domain parameters are\n\t * conveyed verbosely, and the underlying finite field is a\n\t * characteristic-2 field.\n\t */\n\tExplicitChar2: 2,\n\t/**\n\t * Indicates that a named curve is used.  This option\n\t * SHOULD be used when applicable.\n\t */\n\tNamedCurve: 3,\n\t/**\n\t * Values 248 through 255 are reserved for private use.\n\t */\n};\n\n/**\n * Named elliptic curves from\n * https://datatracker.ietf.org/doc/html/rfc4492#section-5.1.1\n */\nexport const ECNamedCurves = {\n\tsect163k1: 1,\n\tsect163r1: 2,\n\tsect163r2: 3,\n\tsect193r1: 4,\n\tsect193r2: 5,\n\tsect233k1: 6,\n\tsect233r1: 7,\n\tsect239k1: 8,\n\tsect283k1: 9,\n\tsect283r1: 10,\n\tsect409k1: 11,\n\tsect409r1: 12,\n\tsecp256k1: 22,\n\tsecp256r1: 23,\n\tsecp384r1: 24,\n\tsecp521r1: 25,\n\tarbitrary_explicit_prime_curves: 0xff01,\n\tarbitrary_explicit_char2_curves: 0xff02,\n};\n\nexport interface CertificateRequest {\n\tcertificate_types: Uint8Array;\n\tsupported_signature_algorithms: Uint8Array;\n\tcertificate_authorities: Uint8Array;\n}\n\n// eslint-disable-next-line @typescript-eslint/no-empty-object-type\nexport interface ServerHelloDone {} // Empty for TLS 1.2\n\nexport interface CertificateVerify {\n\talgorithm: Uint8Array;\n\tsignature: Uint8Array;\n}\n\nexport interface ClientKeyExchange {\n\texchange_keys: Uint8Array;\n}\n\nexport interface Finished {\n\tverify_data: Uint8Array;\n}\n\nexport type SessionKeys = {\n\tmasterSecret: Uint8Array;\n\tclientWriteKey: CryptoKey;\n\tserverWriteKey: CryptoKey;\n\tclientIV: Uint8Array;\n\tserverIV: Uint8Array;\n};\n","import { concatUint8Arrays } from '@php-wasm/util';\n\nimport { ServerNameExtension } from '../extensions/0_server_name';\nimport { CipherSuitesNames } from '../cipher-suites';\nimport { CipherSuites } from '../cipher-suites';\nimport { parseClientHelloExtensions } from '../extensions/parse-extensions';\nimport { ArrayBufferReader, as2Bytes, as3Bytes, as8Bytes } from '../utils';\nimport {\n\tHashAlgorithms,\n\tSignatureAlgorithms,\n} from '../extensions/13_signature_algorithms';\nimport { tls12Prf } from './prf';\nimport type {\n\tSessionKeys,\n\tHandshakeMessage,\n\tClientHello,\n\tClientKeyExchange,\n\tFinished,\n\tApplicationDataMessage,\n\tAlertMessage,\n\tChangeCipherSpecMessage,\n\tTLSMessage,\n\tContentType,\n\tTLSRecord,\n\tHandshakeMessageBody,\n\tHelloRequest,\n} from './types';\nimport {\n\tCompressionMethod,\n\tHandshakeType,\n\tContentTypes,\n\tAlertLevelNames,\n\tAlertDescriptionNames,\n\tECCurveTypes,\n\tECNamedCurves,\n} from './types';\n\nclass TLSConnectionClosed extends Error {}\nconst TLS_Version_1_2 = new Uint8Array([0x03, 0x03]);\n\n/**\n * Reuse the same ECDHE key pair for all connections to\n * save some CPU cycles. We can do this because this TLS\n * implementation is not meant to be secure.\n */\nconst generalEcdheKeyPair = crypto.subtle.generateKey(\n\t{\n\t\tname: 'ECDH',\n\t\tnamedCurve: 'P-256', // Use secp256r1 curve\n\t},\n\ttrue, // Extractable\n\t['deriveKey', 'deriveBits'] // Key usage\n);\n\n/**\n * This isomorphic class implements the server end of\n * the client <-> server TLS 1.2 connection. It has two ends:\n *\n * * Client end, that emits and accepts TLS encrypted data.\n * * Server end, that emits and accepts unencrypted data.\n *\n * The API consumer is responsible for connecting both ends\n * to the appropriate handlers.\n *\n * See https://datatracker.ietf.org/doc/html/rfc5246.\n *\n * ## Warning\n *\n * **WARNING** NEVER USE THIS CODE AS A SERVER-SIDE TLS HANDLER.\n *\n * This code is not secure. It is a minimal subset required\n * to decrypt the TLS traffic from a PHP-wasm worker. Yes,\n * it can speak TLS. No, it won't protect your data.\n *\n * ## Rationale\n *\n * This is useful for running PHP.wasm in web browsers.\n * Function calls such as `file_get_contents(\"https://w.org\")`\n * emit encrypted TLS traffic. With this class, you\n * can decrypt it, serve the requested data, and encrypt\n * the response before passing it back to the PHP.wasm\n * module.\n *\n * ## Implementation details\n *\n * TLS_1_2_Connection implements the minimal subset of TLS 1.2\n * required to exchange encrypted data with PHP.wasm:\n *\n * * TLS Handshake\n * * All TLS 1.2 record types, including messages spanning multiple\n *   records and empty records.\n * * Encryption and decryption of application data.\n * * Auto-chunking long data blobs before encrypting them to\n *   respect the AES-GCM record size limit.\n *\n * The logic is based on numerous RFCs:\n *\n * * RFC 5246: The TLS Protocol Version 1.2\n * * RFC 8446: TLS 1.3\n * * RFC 6066: TLS Extensions\n * * RFC 4492: Elliptic Curve Cryptography (ECC) Cipher Suites for TLS\n * * RFC 5288: AES Galois Counter Mode (GCM) Cipher Suites for TLS\n * * RFC 6070: PKCS #5: Password-Based Key Derivation Function 2 (PBKDF2) Test Vectors\n *\n * ... and a few others.\n *\n * ## Limitations\n *\n * * Multiple ChangeCipherSpec messages are not supported.\n * * Only uncompressed mode (compression method 0) is supported.\n * * Only the TLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256 cipher suite is\n *   supported, primarily because `crypto.subtle` supports AES-GCM.\n *   For AES-GCM details, see https://datatracker.ietf.org/doc/html/rfc5288.\n */\nexport class TLS_1_2_Connection {\n\t/**\n\t * Sequence number of the last received TLS  record.\n\t *\n\t * AES-GCM requires transmitting the sequence number\n\t * in the clear in the additional data to prevent a\n\t * potential attacker from re-transmitting the same\n\t * TLS record in a different context.\n\t */\n\tprivate receivedRecordSequenceNumber = 0;\n\n\t/**\n\t * Sequence number of the last sent TLS record.\n\t *\n\t * AES-GCM requires transmitting the sequence number\n\t * in the clear in the additional data to prevent a\n\t * potential attacker from re-transmitting the same\n\t * TLS record in a different context.\n\t */\n\tprivate sentRecordSequenceNumber = 0;\n\n\t/**\n\t * Encryption keys for this connection derived during\n\t * the TLS handshake.\n\t */\n\tprivate sessionKeys: SessionKeys | undefined;\n\n\t/**\n\t * Whether this connection have been closed.\n\t */\n\tprivate closed = false;\n\n\t/**\n\t * Bytes received from the client but not yet parsed\n\t * as TLS records.\n\t */\n\tprivate receivedBytesBuffer: Uint8Array = new Uint8Array();\n\n\t/**\n\t * TLS records received from the client but not yet\n\t * parsed as TLS messages.\n\t */\n\tprivate receivedTLSRecords: Array<TLSRecord> = [];\n\n\t/**\n\t * TLS messages can span multiple TLS records. This\n\t * map holds partial TLS messages that are still incomplete\n\t * after parsing one or more TLS records.\n\t */\n\tprivate partialTLSMessages: Partial<Record<ContentType, Uint8Array>> = {};\n\n\t/**\n\t * A log of all the exchanged TLS handshake messages.\n\t * This is required to build the Finished message and\n\t * verify the integrity of the handshake.\n\t */\n\tprivate handshakeMessages: Uint8Array[] = [];\n\n\t/**\n\t * Maximum chunk size supported by the cipher suite used\n\t * in this TLS implementation.\n\t */\n\tprivate MAX_CHUNK_SIZE = 1024 * 16;\n\n\t/**\n\t * The client end of the TLS connection.\n\t * This is where the WASM module can write and read the\n\t * encrypted data.\n\t */\n\tclientEnd = {\n\t\t// We don't need to chunk the encrypted data.\n\t\t// OpenSSL already done that for us.\n\t\tupstream: new TransformStream<Uint8Array, Uint8Array>(),\n\t\tdownstream: new TransformStream<Uint8Array, Uint8Array>(),\n\t};\n\n\tprivate clientDownstreamWriter =\n\t\tthis.clientEnd.downstream.writable.getWriter();\n\tprivate clientUpstreamReader = this.clientEnd.upstream.readable.getReader();\n\n\t/**\n\t * The server end of the TLS connection.\n\t * This is where the JavaScript handler can write and read the\n\t * unencrypted data.\n\t */\n\tserverEnd = {\n\t\tupstream: new TransformStream<Uint8Array, Uint8Array>(),\n\t\t/**\n\t\t * Chunk the data before encrypting it. The\n\t\t * TLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256 cipher suite\n\t\t * only supports up to 16KB of data per record.\n\t\t *\n\t\t * This will spread some messages across multiple records,\n\t\t * but TLS supports it so that's fine.\n\t\t */\n\t\tdownstream: chunkStream(this.MAX_CHUNK_SIZE),\n\t};\n\n\tprivate serverUpstreamWriter = this.serverEnd.upstream.writable.getWriter();\n\n\tconstructor() {\n\t\t// eslint-disable-next-line @typescript-eslint/no-this-alias\n\t\tconst tlsConnection = this;\n\t\t// Whenever the \"server handler\" produces data, encrypt it\n\t\t// and send it back to the client.\n\t\tthis.serverEnd.downstream.readable\n\t\t\t.pipeTo(\n\t\t\t\tnew WritableStream({\n\t\t\t\t\tasync write(chunk) {\n\t\t\t\t\t\tawait tlsConnection.writeTLSRecord(\n\t\t\t\t\t\t\tContentTypes.ApplicationData,\n\t\t\t\t\t\t\tchunk\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\tasync abort(e) {\n\t\t\t\t\t\ttlsConnection.clientDownstreamWriter.releaseLock();\n\t\t\t\t\t\ttlsConnection.clientEnd.downstream.writable.abort(e);\n\t\t\t\t\t\ttlsConnection.close();\n\t\t\t\t\t},\n\t\t\t\t\tclose() {\n\t\t\t\t\t\ttlsConnection.close();\n\t\t\t\t\t},\n\t\t\t\t})\n\t\t\t)\n\t\t\t.catch(() => {\n\t\t\t\t// Ignore failures arising from stream errors. The caller\n\t\t\t\t// should react to the readable stream erroring out.\n\t\t\t});\n\t}\n\n\t/**\n\t * Marks this connections as closed and closes all the associated\n\t * streams.\n\t */\n\tasync close() {\n\t\tif (this.closed) {\n\t\t\treturn;\n\t\t}\n\t\tthis.closed = true;\n\t\ttry {\n\t\t\tawait this.clientDownstreamWriter.close();\n\t\t} catch {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.clientUpstreamReader.cancel();\n\t\t} catch {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.serverUpstreamWriter.close();\n\t\t} catch {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.clientEnd.upstream.readable.cancel();\n\t\t} catch {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.clientEnd.downstream.writable.close();\n\t\t} catch {\n\t\t\t// Ignore\n\t\t}\n\t}\n\n\t/**\n\t * TLS handshake as per RFC 5246.\n\t *\n\t * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4\n\t */\n\tasync TLSHandshake(\n\t\tcertificatePrivateKey: CryptoKey,\n\t\tcertificatesDER: Uint8Array[]\n\t): Promise<void> {\n\t\t// Step 1: Receive ClientHello\n\t\tconst clientHelloRecord = await this.readNextHandshakeMessage(\n\t\t\tHandshakeType.ClientHello\n\t\t);\n\t\tif (!clientHelloRecord.body.cipher_suites.length) {\n\t\t\tthrow new Error(\n\t\t\t\t'Client did not propose any supported cipher suites.'\n\t\t\t);\n\t\t}\n\n\t\t// Step 2: Choose hashing, encryption etc. and tell the\n\t\t//         client about our choices. Also share the certificate\n\t\t//         and the encryption keys.\n\t\tconst serverRandom = crypto.getRandomValues(new Uint8Array(32));\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tMessageEncoder.serverHello(\n\t\t\t\tclientHelloRecord.body,\n\t\t\t\tserverRandom,\n\t\t\t\tCompressionMethod.Null\n\t\t\t)\n\t\t);\n\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tMessageEncoder.certificate(certificatesDER)\n\t\t);\n\n\t\tconst ecdheKeyPair = await generalEcdheKeyPair;\n\t\tconst clientRandom = clientHelloRecord.body.random;\n\t\tconst serverKeyExchange = await MessageEncoder.ECDHEServerKeyExchange(\n\t\t\tclientRandom,\n\t\t\tserverRandom,\n\t\t\tecdheKeyPair,\n\t\t\tcertificatePrivateKey\n\t\t);\n\t\tawait this.writeTLSRecord(ContentTypes.Handshake, serverKeyExchange);\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tMessageEncoder.serverHelloDone()\n\t\t);\n\n\t\t// Step 3: Receive the client's response, encryption keys, and\n\t\t//         decrypt the first encrypted message.\n\t\tconst clientKeyExchangeRecord = await this.readNextHandshakeMessage(\n\t\t\tHandshakeType.ClientKeyExchange\n\t\t);\n\t\tawait this.readNextMessage(ContentTypes.ChangeCipherSpec);\n\n\t\tthis.sessionKeys = await this.deriveSessionKeys({\n\t\t\tclientRandom,\n\t\t\tserverRandom,\n\t\t\tserverPrivateKey: ecdheKeyPair.privateKey,\n\t\t\tclientPublicKey: await crypto.subtle.importKey(\n\t\t\t\t'raw',\n\t\t\t\tclientKeyExchangeRecord.body.exchange_keys,\n\t\t\t\t{ name: 'ECDH', namedCurve: 'P-256' },\n\t\t\t\tfalse,\n\t\t\t\t[]\n\t\t\t),\n\t\t});\n\n\t\tawait this.readNextHandshakeMessage(HandshakeType.Finished);\n\n\t\t// We're not actually verifying the hash provided by client\n\t\t// as we're not concerned with the client's identity.\n\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.ChangeCipherSpec,\n\t\t\tMessageEncoder.changeCipherSpec()\n\t\t);\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tawait MessageEncoder.createFinishedMessage(\n\t\t\t\tthis.handshakeMessages,\n\t\t\t\tthis.sessionKeys!.masterSecret\n\t\t\t)\n\t\t);\n\t\t// Clean up the handshake messages as they are no longer needed.\n\t\tthis.handshakeMessages = [];\n\n\t\tthis.pollForClientMessages();\n\t}\n\n\t/**\n\t * Derives the session keys from the random values and the\n\t * pre-master secret – as per RFC 5246.\n\t */\n\tprivate async deriveSessionKeys({\n\t\tclientRandom,\n\t\tserverRandom,\n\t\tserverPrivateKey,\n\t\tclientPublicKey,\n\t}: {\n\t\tclientRandom: Uint8Array;\n\t\tserverRandom: Uint8Array;\n\t\tserverPrivateKey: CryptoKey;\n\t\tclientPublicKey: CryptoKey;\n\t}): Promise<SessionKeys> {\n\t\tconst preMasterSecret = await crypto.subtle.deriveBits(\n\t\t\t{\n\t\t\t\tname: 'ECDH',\n\t\t\t\tpublic: clientPublicKey,\n\t\t\t},\n\t\t\tserverPrivateKey,\n\t\t\t256 // Length of the derived secret (256 bits for P-256)\n\t\t);\n\n\t\tconst masterSecret = new Uint8Array(\n\t\t\tawait tls12Prf(\n\t\t\t\tpreMasterSecret,\n\t\t\t\tnew TextEncoder().encode('master secret'),\n\t\t\t\tconcatUint8Arrays([clientRandom, serverRandom]),\n\t\t\t\t48\n\t\t\t)\n\t\t);\n\n\t\tconst keyBlock = await tls12Prf(\n\t\t\tmasterSecret,\n\t\t\tnew TextEncoder().encode('key expansion'),\n\t\t\tconcatUint8Arrays([serverRandom, clientRandom]),\n\t\t\t// Client key, server key, client IV, server IV\n\t\t\t16 + 16 + 4 + 4\n\t\t);\n\n\t\tconst reader = new ArrayBufferReader(keyBlock);\n\t\tconst clientWriteKey = reader.readUint8Array(16);\n\t\tconst serverWriteKey = reader.readUint8Array(16);\n\t\tconst clientIV = reader.readUint8Array(4);\n\t\tconst serverIV = reader.readUint8Array(4);\n\n\t\treturn {\n\t\t\tmasterSecret,\n\t\t\tclientWriteKey: await crypto.subtle.importKey(\n\t\t\t\t'raw',\n\t\t\t\tclientWriteKey,\n\t\t\t\t{ name: 'AES-GCM' },\n\t\t\t\tfalse,\n\t\t\t\t['encrypt', 'decrypt']\n\t\t\t),\n\t\t\tserverWriteKey: await crypto.subtle.importKey(\n\t\t\t\t'raw',\n\t\t\t\tserverWriteKey,\n\t\t\t\t{ name: 'AES-GCM' },\n\t\t\t\tfalse,\n\t\t\t\t['encrypt', 'decrypt']\n\t\t\t),\n\t\t\tclientIV,\n\t\t\tserverIV,\n\t\t};\n\t}\n\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType: typeof HandshakeType.ClientHello\n\t): Promise<HandshakeMessage<ClientHello>>;\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType: typeof HandshakeType.ClientKeyExchange\n\t): Promise<HandshakeMessage<ClientKeyExchange>>;\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType: typeof HandshakeType.Finished\n\t): Promise<HandshakeMessage<Finished>>;\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType:\n\t\t\t| typeof HandshakeType.ClientHello\n\t\t\t| typeof HandshakeType.ClientKeyExchange\n\t\t\t| typeof HandshakeType.Finished\n\t): Promise<HandshakeMessage<any>> {\n\t\tconst message = await this.readNextMessage(ContentTypes.Handshake);\n\t\tif (message.msg_type !== messageType) {\n\t\t\tthrow new Error(`Expected ${messageType} message`);\n\t\t}\n\t\treturn message;\n\t}\n\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['Handshake']\n\t): Promise<HandshakeMessage<any>>;\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['ApplicationData']\n\t): Promise<ApplicationDataMessage>;\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['Alert']\n\t): Promise<AlertMessage>;\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['ChangeCipherSpec']\n\t): Promise<ChangeCipherSpecMessage>;\n\tprivate async readNextMessage<Message extends TLSMessage>(\n\t\trequestedType: ContentType\n\t): Promise<Message> {\n\t\tlet record: TLSRecord;\n\t\tlet accumulatedPayload: false | Uint8Array = false;\n\t\tdo {\n\t\t\trecord = await this.readNextTLSRecord(requestedType);\n\t\t\taccumulatedPayload = await this.accumulateUntilMessageIsComplete(\n\t\t\t\trecord\n\t\t\t);\n\t\t} while (accumulatedPayload === false);\n\n\t\tconst message = TLSDecoder.TLSMessage(\n\t\t\trecord.type,\n\t\t\taccumulatedPayload\n\t\t) as Message;\n\t\tif (record.type === ContentTypes.Handshake) {\n\t\t\tthis.handshakeMessages.push(record.fragment);\n\t\t}\n\t\treturn message;\n\t}\n\n\tprivate async readNextTLSRecord(\n\t\trequestedType: ContentType\n\t): Promise<TLSRecord> {\n\t\twhile (true) {\n\t\t\t// First, check if we have a complete record of the requested type.\n\t\t\tfor (let i = 0; i < this.receivedTLSRecords.length; i++) {\n\t\t\t\tconst record = this.receivedTLSRecords[i];\n\t\t\t\tif (record.type !== requestedType) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tthis.receivedTLSRecords.splice(i, 1);\n\t\t\t\treturn record;\n\t\t\t}\n\n\t\t\t// We don't have a complete record of the requested type yet.\n\t\t\t// Let's read the next TLS record, then.\n\t\t\tconst header = await this.pollBytes(5);\n\t\t\tconst length = (header[3] << 8) | header[4];\n\t\t\tconst type = header[0];\n\t\t\tconst fragment = await this.pollBytes(length);\n\t\t\tconst record = {\n\t\t\t\ttype,\n\t\t\t\tversion: {\n\t\t\t\t\tmajor: header[1],\n\t\t\t\t\tminor: header[2],\n\t\t\t\t},\n\t\t\t\tlength,\n\t\t\t\tfragment:\n\t\t\t\t\tthis.sessionKeys && type !== ContentTypes.ChangeCipherSpec\n\t\t\t\t\t\t? await this.decryptData(type, fragment)\n\t\t\t\t\t\t: fragment,\n\t\t\t} as TLSRecord;\n\n\t\t\tif (record.type === ContentTypes.Alert) {\n\t\t\t\tconst severity = AlertLevelNames[record.fragment[0]];\n\t\t\t\tconst description = AlertDescriptionNames[record.fragment[1]];\n\t\t\t\t/**\n\t\t\t\t * @TODO: Handle TLS warnings, e.g. this one:\n\t\t\t\t *\n\t\t\t\t * close_notify\n\t\t\t\t *     Either party may initiate a close by sending a close_notify alert.\n\t\t\t\t *     Any data received after a closure alert is ignored.\n\t\t\t\t *\n\t\t\t\t *     Unless some other fatal alert has been transmitted, each party is\n\t\t\t\t *     required to send a close_notify alert before closing the write side\n\t\t\t\t *     of the connection.  The other party MUST respond with a close_notify\n\t\t\t\t *     alert of its own and close down the connection immediately,\n\t\t\t\t *     discarding any pending writes.\n\t\t\t\t */\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`TLS non-warning alert received: ${severity} ${description}`\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tthis.receivedTLSRecords.push(record);\n\t\t}\n\t}\n\n\t/**\n\t * Returns the requested number of bytes from the client.\n\t * Waits for the bytes to arrive if necessary.\n\t */\n\tprivate async pollBytes(length: number) {\n\t\twhile (this.receivedBytesBuffer.length < length) {\n\t\t\tconst { value, done } = await this.clientUpstreamReader.read();\n\t\t\tif (done) {\n\t\t\t\tawait this.close();\n\t\t\t\tthrow new TLSConnectionClosed('TLS connection closed');\n\t\t\t}\n\t\t\tthis.receivedBytesBuffer = concatUint8Arrays([\n\t\t\t\tthis.receivedBytesBuffer,\n\t\t\t\tvalue,\n\t\t\t]);\n\t\t\tif (this.receivedBytesBuffer.length >= length) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Patience is the key...\n\t\t\tawait new Promise((resolve) => setTimeout(resolve, 100));\n\t\t}\n\t\tconst requestedBytes = this.receivedBytesBuffer.slice(0, length);\n\t\tthis.receivedBytesBuffer = this.receivedBytesBuffer.slice(length);\n\t\treturn requestedBytes;\n\t}\n\n\t/**\n\t * Listens for all incoming messages and passes them to the\n\t * server handler.\n\t */\n\tprivate async pollForClientMessages() {\n\t\ttry {\n\t\t\twhile (true) {\n\t\t\t\tconst appData = await this.readNextMessage(\n\t\t\t\t\tContentTypes.ApplicationData\n\t\t\t\t);\n\t\t\t\tthis.serverUpstreamWriter.write(appData.body);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (e instanceof TLSConnectionClosed) {\n\t\t\t\t// Connection closed, no more application data to emit.\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\t/**\n\t * Decrypts data in a TLS 1.2-compliant manner using\n\t * the AES-GCM algorithm.\n\t */\n\tprivate async decryptData(\n\t\tcontentType: number,\n\t\tpayload: Uint8Array\n\t): Promise<Uint8Array> {\n\t\tconst implicitIV = this.sessionKeys!.clientIV;\n\t\t// Part of the IV is randomly generated for each record\n\t\t// and prepended in its unencrypted form before the\n\t\t// ciphertext.\n\t\tconst explicitIV = payload.slice(0, 8);\n\t\tconst iv = new Uint8Array([...implicitIV, ...explicitIV]);\n\n\t\tconst decrypted = await crypto.subtle.decrypt(\n\t\t\t{\n\t\t\t\tname: 'AES-GCM',\n\t\t\t\tiv,\n\t\t\t\tadditionalData: new Uint8Array([\n\t\t\t\t\t...as8Bytes(this.receivedRecordSequenceNumber),\n\t\t\t\t\tcontentType,\n\t\t\t\t\t...TLS_Version_1_2,\n\t\t\t\t\t// Payload length without IV and tag\n\t\t\t\t\t...as2Bytes(payload.length - 8 - 16),\n\t\t\t\t]),\n\t\t\t\ttagLength: 128,\n\t\t\t},\n\t\t\tthis.sessionKeys!.clientWriteKey,\n\t\t\t// Payload without the explicit IV\n\t\t\tpayload.slice(8)\n\t\t);\n\t\t++this.receivedRecordSequenceNumber;\n\n\t\treturn new Uint8Array(decrypted);\n\t}\n\n\tprivate async accumulateUntilMessageIsComplete(\n\t\trecord: TLSRecord\n\t): Promise<false | Uint8Array> {\n\t\tthis.partialTLSMessages[record.type] = concatUint8Arrays([\n\t\t\tthis.partialTLSMessages[record.type] || new Uint8Array(),\n\t\t\trecord.fragment,\n\t\t]);\n\t\tconst message = this.partialTLSMessages[record.type]!;\n\t\tswitch (record.type) {\n\t\t\tcase ContentTypes.Handshake: {\n\t\t\t\t// We don't have the message header yet, let's wait for more data.\n\t\t\t\tif (message.length < 4) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tconst length = (message[1] << 8) | message[2];\n\t\t\t\tif (message.length < 3 + length) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase ContentTypes.Alert: {\n\t\t\t\tif (message.length < 2) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase ContentTypes.ChangeCipherSpec:\n\t\t\tcase ContentTypes.ApplicationData:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`TLS: Unsupported record type ${record.type}`);\n\t\t}\n\t\tdelete this.partialTLSMessages[record.type];\n\t\treturn message;\n\t}\n\n\t/**\n\t * Passes a TLS record to the client.\n\t *\n\t * Accepts unencrypted data and ensures it gets encrypted\n\t * if needed before sending it to the client. The encryption\n\t * only kicks in after the handshake is complete.\n\t */\n\tprivate async writeTLSRecord(\n\t\tcontentType: number,\n\t\tpayload: Uint8Array\n\t): Promise<void> {\n\t\tif (contentType === ContentTypes.Handshake) {\n\t\t\tthis.handshakeMessages.push(payload);\n\t\t}\n\t\tif (this.sessionKeys && contentType !== ContentTypes.ChangeCipherSpec) {\n\t\t\tpayload = await this.encryptData(contentType, payload);\n\t\t}\n\n\t\tconst version = TLS_Version_1_2;\n\t\tconst length = payload.length;\n\t\tconst header = new Uint8Array(5);\n\t\theader[0] = contentType;\n\t\theader[1] = version[0];\n\t\theader[2] = version[1];\n\t\theader[3] = (length >> 8) & 0xff;\n\t\theader[4] = length & 0xff;\n\n\t\tconst record = concatUint8Arrays([header, payload]);\n\t\tthis.clientDownstreamWriter.write(record);\n\t}\n\n\t/**\n\t * Encrypts data in a TLS 1.2-compliant manner using\n\t * the AES-GCM algorithm.\n\t */\n\tprivate async encryptData(\n\t\tcontentType: number,\n\t\tpayload: Uint8Array\n\t): Promise<Uint8Array> {\n\t\tconst implicitIV = this.sessionKeys!.serverIV;\n\t\t// Part of the IV is randomly generated for each record\n\t\t// and prepended in its unencrypted form before the\n\t\t// ciphertext.\n\t\tconst explicitIV = crypto.getRandomValues(new Uint8Array(8));\n\t\tconst iv = new Uint8Array([...implicitIV, ...explicitIV]);\n\n\t\tconst additionalData = new Uint8Array([\n\t\t\t...as8Bytes(this.sentRecordSequenceNumber),\n\t\t\tcontentType,\n\t\t\t...TLS_Version_1_2,\n\t\t\t// Payload length without IV and tag\n\t\t\t...as2Bytes(payload.length),\n\t\t]);\n\t\tconst ciphertextWithTag = await crypto.subtle.encrypt(\n\t\t\t{\n\t\t\t\tname: 'AES-GCM',\n\t\t\t\tiv,\n\t\t\t\tadditionalData,\n\t\t\t\ttagLength: 128,\n\t\t\t},\n\t\t\tthis.sessionKeys!.serverWriteKey,\n\t\t\tpayload\n\t\t);\n\t\t++this.sentRecordSequenceNumber;\n\n\t\tconst encrypted = concatUint8Arrays([\n\t\t\texplicitIV,\n\t\t\tnew Uint8Array(ciphertextWithTag),\n\t\t]);\n\n\t\treturn encrypted;\n\t}\n}\n\nclass TLSDecoder {\n\tstatic TLSMessage(\n\t\ttype: ContentType,\n\t\taccumulatedPayload: Uint8Array\n\t): TLSMessage {\n\t\tswitch (type) {\n\t\t\tcase ContentTypes.Handshake: {\n\t\t\t\treturn TLSDecoder.clientHandshake(accumulatedPayload);\n\t\t\t}\n\t\t\tcase ContentTypes.Alert: {\n\t\t\t\treturn TLSDecoder.alert(accumulatedPayload);\n\t\t\t}\n\t\t\tcase ContentTypes.ChangeCipherSpec: {\n\t\t\t\treturn TLSDecoder.changeCipherSpec();\n\t\t\t}\n\t\t\tcase ContentTypes.ApplicationData: {\n\t\t\t\treturn TLSDecoder.applicationData(accumulatedPayload);\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`TLS: Unsupported TLS record type ${type}`);\n\t\t}\n\t}\n\n\t/**\n\t * Parses the cipher suites from the server hello message.\n\t *\n\t * The cipher suites are encoded as a list of 2-byte values.\n\t *\n\t * Binary layout:\n\t *\n\t * +----------------------------+\n\t * | Cipher Suites Length       |  2 bytes\n\t * +----------------------------+\n\t * | Cipher Suite 1             |  2 bytes\n\t * +----------------------------+\n\t * | Cipher Suite 2             |  2 bytes\n\t * +----------------------------+\n\t * | ...                        |\n\t * +----------------------------+\n\t * | Cipher Suite n             |  2 bytes\n\t * +----------------------------+\n\t *\n\t * The full list of supported cipher suites values is available at:\n\t *\n\t * https://www.iana.org/assignments/tls-parameters/tls-parameters.xhtml#tls-parameters-4\n\t */\n\tstatic parseCipherSuites(buffer: ArrayBuffer): string[] {\n\t\tconst reader = new ArrayBufferReader(buffer);\n\t\t// Skip the length of the cipher suites\n\t\treader.readUint16();\n\n\t\tconst cipherSuites = [];\n\t\twhile (!reader.isFinished()) {\n\t\t\tconst suite = reader.readUint16();\n\t\t\tif (!(suite in CipherSuitesNames)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tcipherSuites.push(CipherSuitesNames[suite]);\n\t\t}\n\t\treturn cipherSuites;\n\t}\n\n\tstatic applicationData(message: Uint8Array): ApplicationDataMessage {\n\t\treturn {\n\t\t\ttype: ContentTypes.ApplicationData,\n\t\t\tbody: message,\n\t\t};\n\t}\n\n\tstatic changeCipherSpec(): ChangeCipherSpecMessage {\n\t\treturn {\n\t\t\ttype: ContentTypes.ChangeCipherSpec,\n\t\t\tbody: new Uint8Array(),\n\t\t};\n\t}\n\n\tstatic alert(message: Uint8Array): AlertMessage {\n\t\treturn {\n\t\t\ttype: ContentTypes.Alert,\n\t\t\tlevel: AlertLevelNames[message[0]],\n\t\t\tdescription: AlertDescriptionNames[message[1]],\n\t\t};\n\t}\n\n\tstatic clientHandshake<T extends HandshakeMessageBody>(\n\t\tmessage: Uint8Array\n\t): HandshakeMessage<T> {\n\t\tconst msg_type = message[0];\n\t\tconst length = (message[1] << 16) | (message[2] << 8) | message[3];\n\t\tconst bodyBytes = message.slice(4);\n\t\tlet body: HandshakeMessageBody | undefined = undefined;\n\t\tswitch (msg_type) {\n\t\t\tcase HandshakeType.HelloRequest:\n\t\t\t\tbody = TLSDecoder.clientHelloRequestPayload();\n\t\t\t\tbreak;\n\t\t\tcase HandshakeType.ClientHello:\n\t\t\t\tbody = TLSDecoder.clientHelloPayload(bodyBytes);\n\t\t\t\tbreak;\n\t\t\tcase HandshakeType.ClientKeyExchange:\n\t\t\t\tbody = TLSDecoder.clientKeyExchangePayload(bodyBytes);\n\t\t\t\tbreak;\n\t\t\tcase HandshakeType.Finished:\n\t\t\t\tbody = TLSDecoder.clientFinishedPayload(bodyBytes);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Invalid handshake type ${msg_type}`);\n\t\t}\n\t\treturn {\n\t\t\ttype: ContentTypes.Handshake,\n\t\t\tmsg_type,\n\t\t\tlength,\n\t\t\tbody: body as T,\n\t\t};\n\t}\n\n\tstatic clientHelloRequestPayload(): HelloRequest {\n\t\treturn {};\n\t}\n\n\t/**\n\t *\tOffset  Size    Field\n\t *\t(bytes) (bytes)\n\t *\t+------+------+---------------------------+\n\t *\t| 0000 |  1   | Handshake Type (1 = ClientHello)\n\t *\t+------+------+---------------------------+\n\t *\t| 0001 |  3   | Length of ClientHello\n\t *\t+------+------+---------------------------+\n\t *\t| 0004 |  2   | Protocol Version\n\t *\t+------+------+---------------------------+\n\t *\t| 0006 |  32  | Client Random\n\t *\t|      |      | (4 bytes timestamp +\n\t *\t|      |      |  28 bytes random)\n\t *\t+------+------+---------------------------+\n\t *\t| 0038 |  1   | Session ID Length\n\t *\t+------+------+---------------------------+\n\t *\t| 0039 |  0+  | Session ID (variable)\n\t *\t|      |      | (0-32 bytes)\n\t *\t+------+------+---------------------------+\n\t *\t| 003A*|  2   | Cipher Suites Length\n\t *\t+------+------+---------------------------+\n\t *\t| 003C*|  2+  | Cipher Suites\n\t *\t|      |      | (2 bytes each)\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  1   | Compression Methods Length\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  1+  | Compression Methods\n\t *\t|      |      | (1 byte each)\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  2   | Extensions Length\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  2   | Extension Type\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  2   | Extension Length\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  v   | Extension Data\n\t *\t+------+------+---------------------------+\n\t *\t|      |      | (Additional extensions...)\n\t *\t+------+------+---------------------------+\n\t */\n\tstatic clientHelloPayload(data: Uint8Array): ClientHello {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\tconst buff: Partial<ClientHello> = {\n\t\t\tclient_version: reader.readUint8Array(2),\n\t\t\t/**\n\t\t\t * Technically this consists of a GMT timestamp\n\t\t\t * and 28 random bytes, but we don't need to\n\t\t\t * parse this further.\n\t\t\t */\n\t\t\trandom: reader.readUint8Array(32),\n\t\t};\n\t\tconst sessionIdLength = reader.readUint8();\n\t\tbuff.session_id = reader.readUint8Array(sessionIdLength);\n\n\t\tconst cipherSuitesLength = reader.readUint16();\n\t\tbuff.cipher_suites = TLSDecoder.parseCipherSuites(\n\t\t\treader.readUint8Array(cipherSuitesLength).buffer\n\t\t);\n\n\t\tconst compressionMethodsLength = reader.readUint8();\n\t\tbuff.compression_methods = reader.readUint8Array(\n\t\t\tcompressionMethodsLength\n\t\t);\n\n\t\tconst extensionsLength = reader.readUint16();\n\t\tbuff.extensions = parseClientHelloExtensions(\n\t\t\treader.readUint8Array(extensionsLength)\n\t\t);\n\t\treturn buff as ClientHello;\n\t}\n\n\t/**\n\t * Binary layout:\n\t *\n\t *\t+------------------------------------+\n\t *\t| ECDH Client Public Key Length [1B] |\n\t *\t+------------------------------------+\n\t *\t| ECDH Client Public Key   [variable]|\n\t *\t+------------------------------------+\n\t */\n\tstatic clientKeyExchangePayload(data: Uint8Array): ClientKeyExchange {\n\t\treturn {\n\t\t\t// Skip the first byte, which is the length of the public key\n\t\t\texchange_keys: data.slice(1, data.length),\n\t\t};\n\t}\n\n\tstatic clientFinishedPayload(data: Uint8Array): Finished {\n\t\treturn {\n\t\t\tverify_data: data,\n\t\t};\n\t}\n}\n\n/**\n * Creates a stream that emits chunks not larger than\n * the specified size.\n */\nfunction chunkStream(chunkSize: number) {\n\treturn new TransformStream({\n\t\ttransform(chunk, controller) {\n\t\t\twhile (chunk.length > 0) {\n\t\t\t\tcontroller.enqueue(chunk.slice(0, chunkSize));\n\t\t\t\tchunk = chunk.slice(chunkSize);\n\t\t\t}\n\t\t},\n\t});\n}\n\nclass MessageEncoder {\n\tstatic certificate(certificatesDER: ArrayBuffer[]): Uint8Array {\n\t\tconst certsBodies: Uint8Array[] = [];\n\t\tfor (const cert of certificatesDER) {\n\t\t\tcertsBodies.push(as3Bytes(cert.byteLength));\n\t\t\tcertsBodies.push(new Uint8Array(cert));\n\t\t}\n\t\tconst certsBody = concatUint8Arrays(certsBodies);\n\t\tconst body = new Uint8Array([\n\t\t\t...as3Bytes(certsBody.byteLength),\n\t\t\t...certsBody,\n\t\t]);\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.Certificate,\n\t\t\t...as3Bytes(body.length),\n\t\t\t...body,\n\t\t]);\n\t}\n\n\t/*\n\t * Byte layout of the ServerKeyExchange message:\n\t *\n\t * +-----------------------------------+\n\t * |    ServerKeyExchange Message      |\n\t * +-----------------------------------+\n\t * | Handshake type (1 byte)           |\n\t * +-----------------------------------+\n\t * | Length (3 bytes)                  |\n\t * +-----------------------------------+\n\t * | Curve Type (1 byte)               |\n\t * +-----------------------------------+\n\t * | Named Curve (2 bytes)             |\n\t * +-----------------------------------+\n\t * | EC Point Format (1 byte)          |\n\t * +-----------------------------------+\n\t * | Public Key Length (1 byte)        |\n\t * +-----------------------------------+\n\t * | Public Key (variable)             |\n\t * +-----------------------------------+\n\t * | Signature Algorithm (2 bytes)     |\n\t * +-----------------------------------+\n\t * | Signature Length (2 bytes)        |\n\t * +-----------------------------------+\n\t * | Signature (variable)              |\n\t * +-----------------------------------+\n\t *\n\t * @param clientRandom - 32 bytes from ClientHello\n\t * @param serverRandom - 32 bytes from ServerHello\n\t * @param ecdheKeyPair - ECDHE key pair\n\t * @param rsaPrivateKey - RSA private key for signing\n\t * @returns\n\t */\n\tstatic async ECDHEServerKeyExchange(\n\t\tclientRandom: Uint8Array,\n\t\tserverRandom: Uint8Array,\n\t\tecdheKeyPair: CryptoKeyPair,\n\t\trsaPrivateKey: CryptoKey\n\t): Promise<Uint8Array> {\n\t\t// 65 bytes (04 followed by x and y coordinates)\n\t\tconst publicKey = new Uint8Array(\n\t\t\tawait crypto.subtle.exportKey('raw', ecdheKeyPair.publicKey)\n\t\t);\n\n\t\t/*\n\t\t * The ServerKeyExchange message is extended as follows.\n\t\t *\n\t\t * select (KeyExchangeAlgorithm) {\n\t\t *     case ec_diffie_hellman:\n\t\t *         ServerECDHParams    params;\n\t\t *         Signature           signed_params;\n\t\t * } ServerKeyExchange;\n\t\t *\n\t\t * struct {\n\t\t *   ECCurveType     curve_type;\n\t\t *   NamedCurve      namedcurve;\n\t\t *   ECPoint         public;\n\t\t * } ServerECDHParams;\n\t\t */\n\t\tconst params = new Uint8Array([\n\t\t\t// Curve type (1 byte)\n\t\t\tECCurveTypes.NamedCurve,\n\t\t\t// Curve name (2 bytes)\n\t\t\t...as2Bytes(ECNamedCurves.secp256r1),\n\n\t\t\t// Public key length (1 byte)\n\t\t\tpublicKey.byteLength,\n\n\t\t\t// Public key (65 bytes, uncompressed format)\n\t\t\t...publicKey,\n\t\t]);\n\n\t\t/**\n\t\t * signed_params:\n\t\t *    A hash of the params, with the signature appropriate to that hash\n\t\t *    applied.  The private key corresponding to the certified public key\n\t\t *    in the server's Certificate message is used for signing.\n\t\t *\n\t\t *    Signature = encrypt(SHA(\n\t\t *       ClientHello.random + ServerHello.random + ServerECDHParams\n\t\t *    ));\n\t\t */\n\t\tconst signedParams = await crypto.subtle.sign(\n\t\t\t{\n\t\t\t\tname: 'RSASSA-PKCS1-v1_5',\n\t\t\t\thash: 'SHA-256',\n\t\t\t},\n\t\t\trsaPrivateKey,\n\t\t\tnew Uint8Array([...clientRandom, ...serverRandom, ...params])\n\t\t);\n\t\tconst signatureBytes = new Uint8Array(signedParams);\n\n\t\t/**\n\t\t * SignatureAlgorithm is \"rsa\" for the ECDHE_RSA key exchange\n\t\t * These cases are defined in TLS [RFC2246].\n\t\t */\n\t\tconst signatureAlgorithm = new Uint8Array([\n\t\t\tHashAlgorithms.sha256,\n\t\t\tSignatureAlgorithms.rsa,\n\t\t]);\n\n\t\t// Step 6: Construct the complete Server Key Exchange message\n\t\tconst body = new Uint8Array([\n\t\t\t...params,\n\t\t\t...signatureAlgorithm,\n\t\t\t...as2Bytes(signatureBytes.length),\n\t\t\t...signatureBytes,\n\t\t]);\n\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.ServerKeyExchange,\n\t\t\t...as3Bytes(body.length),\n\t\t\t...body,\n\t\t]);\n\t}\n\n\t/**\n\t * +------------------------------------+\n\t * | Content Type (Handshake)     [1B]  |\n\t * | 0x16                               |\n\t * +------------------------------------+\n\t * | Version (TLS 1.2)            [2B]  |\n\t * | 0x03 0x03                          |\n\t * +------------------------------------+\n\t * | Length                       [2B]  |\n\t * +------------------------------------+\n\t * | Handshake Type (ServerHello) [1B]  |\n\t * | 0x02                               |\n\t * +------------------------------------+\n\t * | Handshake Length             [3B]  |\n\t * +------------------------------------+\n\t * | Server Version               [2B]  |\n\t * +------------------------------------+\n\t * | Server Random               [32B]  |\n\t * +------------------------------------+\n\t * | Session ID Length            [1B]  |\n\t * +------------------------------------+\n\t * | Session ID             [0-32B]     |\n\t * +------------------------------------+\n\t * | Cipher Suite                 [2B]  |\n\t * +------------------------------------+\n\t * | Compression Method           [1B]  |\n\t * +------------------------------------+\n\t * | Extensions Length            [2B]  |\n\t * +------------------------------------+\n\t * | Extension: ec_point_formats        |\n\t * |   Type (0x00 0x0B)           [2B]  |\n\t * |   Length                     [2B]  |\n\t * |   EC Point Formats Length    [1B]  |\n\t * |   EC Point Format            [1B]  |\n\t * +------------------------------------+\n\t * | Other Extensions...                |\n\t * +------------------------------------+\n\t */\n\tstatic serverHello(\n\t\tclientHello: ClientHello,\n\t\tserverRandom: Uint8Array,\n\t\tcompressionAlgorithm: number\n\t): Uint8Array {\n\t\tconst extensionsParts: Uint8Array[] = clientHello.extensions\n\t\t\t.map((extension) => {\n\t\t\t\tswitch (extension['type']) {\n\t\t\t\t\tcase 'server_name':\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * The server SHALL include an extension of type \"server_name\" in the\n\t\t\t\t\t\t * (extended) server hello.  The \"extension_data\" field of this extension\n\t\t\t\t\t\t * SHALL be empty.\n\t\t\t\t\t\t *\n\t\t\t\t\t\t * Source: dfile:///Users/cloudnik/Library/Application%20Support/Dash/User%20Contributed/RFCs/RFCs.docset/Contents/Resources/Documents/rfc6066.html#section-3\n\t\t\t\t\t\t */\n\t\t\t\t\t\treturn ServerNameExtension.encodeForClient();\n\t\t\t\t}\n\t\t\t\treturn undefined;\n\t\t\t})\n\t\t\t.filter((x): x is Uint8Array => x !== undefined);\n\t\tconst extensions = concatUint8Arrays(extensionsParts);\n\n\t\tconst body = new Uint8Array([\n\t\t\t// Version field – 0x03, 0x03 means TLS 1.2\n\t\t\t...TLS_Version_1_2,\n\n\t\t\t...serverRandom,\n\n\t\t\tclientHello.session_id.length,\n\t\t\t...clientHello.session_id,\n\n\t\t\t...as2Bytes(CipherSuites.TLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256),\n\n\t\t\tcompressionAlgorithm,\n\n\t\t\t// Extensions length (2 bytes)\n\t\t\t...as2Bytes(extensions.length),\n\n\t\t\t...extensions,\n\t\t]);\n\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.ServerHello,\n\t\t\t...as3Bytes(body.length),\n\t\t\t...body,\n\t\t]);\n\t}\n\n\tstatic serverHelloDone(): Uint8Array {\n\t\treturn new Uint8Array([HandshakeType.ServerHelloDone, ...as3Bytes(0)]);\n\t}\n\n\t/**\n\t * Server finished message.\n\t * The structure is defined in:\n\t * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.9\n\t *\n\t * struct {\n\t *     opaque verify_data[verify_data_length];\n\t * } Finished;\n\t *\n\t * verify_data\n\t *    PRF(master_secret, finished_label, Hash(handshake_messages))\n\t *       [0..verify_data_length-1];\n\t *\n\t * finished_label\n\t *    For Finished messages sent by the client, the string\n\t *    \"client finished\".  For Finished messages sent by the server,\n\t *    the string \"server finished\".\n\t */\n\tstatic async createFinishedMessage(\n\t\thandshakeMessages: Uint8Array[],\n\t\tmasterSecret: ArrayBuffer\n\t): Promise<Uint8Array> {\n\t\t// Step 1: Compute the hash of the handshake messages\n\t\tconst handshakeHash = await crypto.subtle.digest(\n\t\t\t'SHA-256',\n\t\t\tconcatUint8Arrays(handshakeMessages)\n\t\t);\n\n\t\t// Step 2: Compute the verify_data using the PRF\n\t\tconst verifyData = new Uint8Array(\n\t\t\tawait tls12Prf(\n\t\t\t\tmasterSecret,\n\t\t\t\tnew TextEncoder().encode('server finished'),\n\t\t\t\thandshakeHash,\n\t\t\t\t// verify_data length. TLS 1.2 specifies 12 bytes for verify_data\n\t\t\t\t12\n\t\t\t)\n\t\t);\n\n\t\t// Step 3: Construct the Finished message\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.Finished,\n\t\t\t...as3Bytes(verifyData.length),\n\t\t\t...verifyData,\n\t\t]);\n\t}\n\n\tstatic changeCipherSpec(): Uint8Array {\n\t\treturn new Uint8Array([0x01]);\n\t}\n}\n","const DEFAULT_RESPONSE_TIMEOUT = 25000;\n\nlet lastRequestId = 0;\n\n/**\n * Posts a message branded with a unique `requestId` to the given `target`.\n * Then returns the `requestId` so it can be used to await a reply.\n * Effectively, it implements the request/response dynamics on\n * of JavaScript's `postMessage`\n *\n * @example\n *\n * In the main app:\n *\n * ```js\n * import { postMessageExpectReply, awaitReply } from 'php-wasm-browser';\n * const iframeWindow = iframe.contentWindow;\n * const requestId = postMessageExpectReply(iframeWindow, {\n *    type: \"get_php_version\"\n * });\n * const response = await awaitReply(iframeWindow, requestId);\n * console.log(response);\n * // \"8.0.24\"\n * ```\n *\n * In the iframe:\n *\n * ```js\n * import { responseTo } from 'php-wasm-browser';\n * window.addEventListener('message', (event) => {\n *    let response = '8.0.24';\n *    if(event.data.type === 'get_php_version') {\n *       response = '8.0.24';\n *    } else {\n *       throw new Error(`Unexpected message type: ${event.data.type}`);\n *    }\n *\n *    // When `requestId` is present, the other thread expects a response:\n *    if (event.data.requestId) {\n *       const response = responseTo(event.data.requestId, response);\n *       window.parent.postMessage(response, event.origin);\n *    }\n * });\n * ```\n *\n * @param  target          An object that has a `postMessage` method.\n * @param  message         A key-value object that can be serialized to JSON.\n * @param  postMessageArgs Additional arguments to pass to `postMessage`.\n * @returns The message ID for awaitReply().\n */\nexport function postMessageExpectReply(\n\ttarget: PostMessageTarget,\n\tmessage: Record<string, any>,\n\t...postMessageArgs: any[]\n): number {\n\tconst requestId = getNextRequestId();\n\ttarget.postMessage(\n\t\t{\n\t\t\t...message,\n\t\t\trequestId,\n\t\t},\n\t\t...postMessageArgs\n\t);\n\treturn requestId;\n}\n\nexport function getNextRequestId() {\n\treturn ++lastRequestId;\n}\n\n/**\n * Awaits a reply to the message with the given ID.\n *\n * @see postMessageExpectReply\n * @throws {@link Error} If the reply is not received within the timeout.\n * @param  messageTarget EventEmitter emitting `message` events, e.g. `window`\n *                       or a `Worker` instance.\n * @param  requestId     The message ID returned by postMessageExpectReply().\n * @param  timeout       The number of milliseconds to wait for a reply before\n *                       throwing an error.\n * @returns The reply from the messageTarget.\n */\nexport function awaitReply(\n\tmessageTarget: IsomorphicEventTarget,\n\trequestId: number,\n\ttimeout: number = DEFAULT_RESPONSE_TIMEOUT\n): Promise<any> {\n\treturn new Promise((resolve, reject) => {\n\t\tconst responseHandler = (event: MessageEvent) => {\n\t\t\tif (\n\t\t\t\tevent.data.type === 'response' &&\n\t\t\t\tevent.data.requestId === requestId\n\t\t\t) {\n\t\t\t\tmessageTarget.removeEventListener('message', responseHandler);\n\t\t\t\tclearTimeout(failOntimeout);\n\t\t\t\tresolve(event.data.response);\n\t\t\t}\n\t\t};\n\n\t\tconst failOntimeout = setTimeout(() => {\n\t\t\treject(new Error('Request timed out'));\n\t\t\tmessageTarget.removeEventListener('message', responseHandler);\n\t\t}, timeout);\n\n\t\tmessageTarget.addEventListener('message', responseHandler);\n\t});\n}\n\n/**\n * Creates a response message to the given message ID.\n *\n * @see postMessageExpectReply\n * @param  requestId The message ID sent from the other thread by\n *                   `postMessageExpectReply` in the `message` event.\n * @param  response  The response to send back to the messageTarget.\n * @returns A message object that can be sent back to the other thread.\n */\nexport function responseTo<T>(\n\trequestId: number,\n\tresponse: T\n): MessageResponse<T> {\n\treturn {\n\t\ttype: 'response',\n\t\trequestId,\n\t\tresponse,\n\t};\n}\n\nexport interface MessageResponse<T> {\n\ttype: 'response';\n\trequestId: number;\n\tresponse: T;\n}\n\ninterface PostMessageTarget {\n\tpostMessage(message: any, ...args: any[]): void;\n}\n\ninterface IsomorphicEventTarget {\n\taddEventListener(type: string, listener: (event: any) => void): void;\n\tremoveEventListener(type: string, listener: (event: any) => void): void;\n}\n","import { concatUint8Arrays } from '@php-wasm/util';\n\n/**\n * A TransformStream that decodes HTTP chunked transfer encoding.\n * Each chunk starts with the chunk size in hex followed by CRLF,\n * then the chunk data, then CRLF. A chunk size of 0 indicates the end.\n */\nexport class ChunkedDecoderStream extends TransformStream<\n\tUint8Array,\n\tUint8Array\n> {\n\tconstructor() {\n\t\tlet buffer = new Uint8Array(0);\n\t\tlet state:\n\t\t\t| 'SCAN_CHUNK_SIZE'\n\t\t\t| 'SCAN_CHUNK_DATA'\n\t\t\t| 'SCAN_CHUNK_TRAILER'\n\t\t\t| 'SCAN_FINAL_CHUNK' = 'SCAN_CHUNK_SIZE';\n\t\tlet chunkRemainingBytes = 0;\n\n\t\tsuper({\n\t\t\ttransform(chunk, controller) {\n\t\t\t\t// Add new chunk to buffer\n\t\t\t\tbuffer = concatUint8Arrays([buffer, chunk]);\n\n\t\t\t\twhile (buffer.length > 0) {\n\t\t\t\t\tif (state === 'SCAN_CHUNK_SIZE') {\n\t\t\t\t\t\t// Need at least \"0\\r\\n\" (3 bytes)\n\t\t\t\t\t\tif (buffer.length < 3) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Find the chunk size hex digits\n\t\t\t\t\t\tlet chunkBytesNb = 0;\n\t\t\t\t\t\twhile (chunkBytesNb < buffer.length) {\n\t\t\t\t\t\t\tconst byte = buffer[chunkBytesNb];\n\t\t\t\t\t\t\tconst isHexDigit =\n\t\t\t\t\t\t\t\t(byte >= 48 && byte <= 57) || // 0-9\n\t\t\t\t\t\t\t\t(byte >= 97 && byte <= 102) || // a-f\n\t\t\t\t\t\t\t\t(byte >= 65 && byte <= 70); // A-F\n\t\t\t\t\t\t\tif (!isHexDigit) break;\n\t\t\t\t\t\t\tchunkBytesNb++;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (chunkBytesNb === 0) {\n\t\t\t\t\t\t\tthrow new Error('Invalid chunk size format');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Look for CRLF after chunk size\n\t\t\t\t\t\tif (buffer.length < chunkBytesNb + 2) {\n\t\t\t\t\t\t\t// Not enough data, let's wait for more\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tbuffer[chunkBytesNb] !== 13 || // \\r\n\t\t\t\t\t\t\tbuffer[chunkBytesNb + 1] !== 10 // \\n\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t\t'Invalid chunk size format. Expected CRLF after chunk size'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Parse the chunk size\n\t\t\t\t\t\tconst chunkSizeHex = new TextDecoder().decode(\n\t\t\t\t\t\t\tbuffer.slice(0, chunkBytesNb)\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst chunkSize = parseInt(chunkSizeHex, 16);\n\n\t\t\t\t\t\t// Remove chunk header from buffer\n\t\t\t\t\t\tbuffer = buffer.slice(chunkBytesNb + 2);\n\n\t\t\t\t\t\tif (chunkSize === 0) {\n\t\t\t\t\t\t\tstate = 'SCAN_FINAL_CHUNK';\n\t\t\t\t\t\t\tcontroller.terminate();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tchunkRemainingBytes = chunkSize;\n\t\t\t\t\t\tstate = 'SCAN_CHUNK_DATA';\n\t\t\t\t\t} else if (state === 'SCAN_CHUNK_DATA') {\n\t\t\t\t\t\tconst bytesToRead = Math.min(\n\t\t\t\t\t\t\tchunkRemainingBytes,\n\t\t\t\t\t\t\tbuffer.length\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst data = buffer.slice(0, bytesToRead);\n\t\t\t\t\t\tbuffer = buffer.slice(bytesToRead);\n\t\t\t\t\t\tchunkRemainingBytes -= bytesToRead;\n\n\t\t\t\t\t\tcontroller.enqueue(data);\n\n\t\t\t\t\t\tif (chunkRemainingBytes === 0) {\n\t\t\t\t\t\t\tstate = 'SCAN_CHUNK_TRAILER';\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (state === 'SCAN_CHUNK_TRAILER') {\n\t\t\t\t\t\tif (buffer.length < 2) {\n\t\t\t\t\t\t\t// Not enough data, let's wait for more\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (buffer[0] !== 13 || buffer[1] !== 10) {\n\t\t\t\t\t\t\t// \\r\\n\n\t\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t\t'Invalid chunk trailer format. Expected CRLF after chunk data'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbuffer = buffer.slice(2);\n\t\t\t\t\t\tstate = 'SCAN_CHUNK_SIZE';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t}\n}\n","/**\n * Setup a postMessage relay between the parent window and a nested iframe.\n *\n * When we're running a Playground instance inside an iframe, sometimes that\n * iframe will contain another iframe and so on. The parent application,\n * however, needs to be able to communicate with the innermost iframe. This\n * function relays the communication both ways. Call it in in every iframe\n * layer between the topmost window and the innermost iframe.\n *\n * @param nestedFrame The nested iframe element\n * @param expectedOrigin The origin that the nested iframe is expected to be on. If not\n *                       provided, any origin is allowed.\n */\nexport function setupPostMessageRelay(\n\tnestedFrame: HTMLIFrameElement,\n\texpectedOrigin?: string\n) {\n\t// Relay Messages from WP to Parent\n\twindow.addEventListener('message', (event) => {\n\t\tif (event.source !== nestedFrame.contentWindow) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (expectedOrigin && event.origin !== expectedOrigin) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (typeof event.data !== 'object' || event.data.type !== 'relay') {\n\t\t\treturn;\n\t\t}\n\n\t\twindow.parent.postMessage(event.data, '*');\n\t});\n\n\t// Relay Messages from Parent to WP\n\twindow.addEventListener('message', (event) => {\n\t\tif (event.source !== window.parent) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (typeof event.data !== 'object' || event.data.type !== 'relay') {\n\t\t\treturn;\n\t\t}\n\n\t\tnestedFrame?.contentWindow?.postMessage(event.data);\n\t});\n}\n","/**\n * Spawns a new Worker Thread.\n *\n * @param  workerUrl The absolute URL of the worker script.\n * @returns The spawned Worker Thread.\n */\nexport async function spawnPHPWorkerThread(workerUrl: string) {\n\tconst worker = new Worker(workerUrl, { type: 'module' });\n\treturn new Promise<Worker>((resolve, reject) => {\n\t\tworker.onerror = (e) => {\n\t\t\tconst error = new Error(\n\t\t\t\t`WebWorker failed to load at ${workerUrl}. ${\n\t\t\t\t\te.message ? `Original error: ${e.message}` : ''\n\t\t\t\t}`\n\t\t\t);\n\t\t\t(error as any).filename = e.filename;\n\t\t\treject(error);\n\t\t};\n\t\t// There is no way to know when the worker script has started\n\t\t// executing, so we use a message to signal that.\n\t\tfunction onStartup(event: { data: string }) {\n\t\t\tif (event.data === 'worker-script-started') {\n\t\t\t\tresolve(worker);\n\t\t\t\tworker.removeEventListener('message', onStartup);\n\t\t\t}\n\t\t}\n\t\tworker.addEventListener('message', onStartup);\n\t});\n}\n","import type { PHP, UniversalPHP } from '@php-wasm/universal';\nimport { __private__dont__use } from '@php-wasm/universal';\nimport { Semaphore, basename, joinPaths } from '@php-wasm/util';\nimport { logger } from '@php-wasm/logger';\n\nexport type EmscriptenFS = any;\n\n/**\n * Represents a stream in the Emscripten file system.\n */\nexport type EmscriptenFSStream = {\n\t/** The path of the node associated with this stream. */\n\tpath: string;\n\t/** The node associated with the stream. */\n\tnode: EmscriptenFSNode;\n};\n\n/**\n * Represents a node in the Emscripten file system.\n */\nexport type EmscriptenFSNode = {\n\t/**\n\t * The name of the file or directory.\n\t */\n\tname: string;\n\t/**\n\t * A binary flag encoding information about this note,\n\t * e.g. whether it's file or a directory.\n\t */\n\tmode: number;\n\t/**\n\t * A dictionary of functions representing operations\n\t * that can be performed on the node.\n\t */\n\tnode_ops: any;\n};\n\n/**\n * Represents the type of node in PHP file system.\n */\nexport type FSNodeType = 'file' | 'directory';\n\n/**\n * Represents an update operation on a file system node.\n */\nexport type UpdateFileOperation = {\n\t/** The type of operation being performed. */\n\toperation: 'WRITE';\n\t/** The path of the node being updated. */\n\tpath: string;\n\t/** Optional. The new contents of the file. */\n\tdata?: Uint8Array;\n\tnodeType: 'file';\n};\n\n/**\n * Represents a directory operation.\n */\nexport type CreateOperation = {\n\t/** The type of operation being performed. */\n\toperation: 'CREATE';\n\t/** The path of the node being created. */\n\tpath: string;\n\t/** The type of the node being created. */\n\tnodeType: FSNodeType;\n};\n\nexport type DeleteOperation = {\n\t/** The type of operation being performed. */\n\toperation: 'DELETE';\n\t/** The path of the node being updated. */\n\tpath: string;\n\t/** The type of the node being updated. */\n\tnodeType: FSNodeType;\n};\n\n/**\n * Represents a rename operation on a file or directory in PHP file system.\n */\nexport type RenameOperation = {\n\t/** The type of operation being performed. */\n\toperation: 'RENAME';\n\t/** The original path of the file or directory being renamed. */\n\tpath: string;\n\t/** The new path of the file or directory after the rename operation. */\n\ttoPath: string;\n\t/** The type of node being renamed (file or directory). */\n\tnodeType: FSNodeType;\n};\n\n/**\n * Represents a node in the file system.\n */\nexport type FSNode = {\n\t/** The name of this file or directory. */\n\tname: string;\n\t/** The type of this node (file or directory). */\n\ttype: FSNodeType;\n\t/** The contents of the file, if it is a file and it's stored in memory. */\n\tcontents?: string;\n\t/** The child nodes of the directory, if it is a directory. */\n\tchildren?: FSNode[];\n};\n\nexport type FilesystemOperation =\n\t| CreateOperation\n\t| UpdateFileOperation\n\t| DeleteOperation\n\t| RenameOperation;\n\nexport function journalFSEvents(\n\tphp: PHP,\n\tfsRoot: string,\n\tonEntry: (entry: FilesystemOperation) => void = () => {}\n) {\n\tfunction bindToCurrentRuntime() {\n\t\tfsRoot = normalizePath(fsRoot);\n\t\tconst FS = php[__private__dont__use].FS;\n\t\tconst FSHooks = createFSHooks(FS, (entry: FilesystemOperation) => {\n\t\t\t// Only journal entries inside the specified root directory.\n\t\t\tif (entry.path.startsWith(fsRoot)) {\n\t\t\t\tonEntry(entry);\n\t\t\t} else if (\n\t\t\t\tentry.operation === 'RENAME' &&\n\t\t\t\tentry.toPath.startsWith(fsRoot)\n\t\t\t) {\n\t\t\t\tfor (const op of recordExistingPath(\n\t\t\t\t\tphp,\n\t\t\t\t\tentry.path,\n\t\t\t\t\tentry.toPath\n\t\t\t\t)) {\n\t\t\t\t\tonEntry(op);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t/**\n\t\t * Override the original FS functions with ones running the hooks.\n\t\t * We could use a Proxy object here if the Emscripten JavaScript module\n\t\t * did not use hard-coded references to the FS object.\n\t\t */\n\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\n\t\tconst originalFunctions: Record<string, Function> = {};\n\t\tfor (const [name] of Object.entries(FSHooks)) {\n\t\t\toriginalFunctions[name] = FS[name];\n\t\t}\n\n\t\t// eslint-disable-next-line no-inner-declarations\n\t\tfunction bind() {\n\t\t\tfor (const [name, hook] of Object.entries(FSHooks)) {\n\t\t\t\tFS[name] = function (...args: any[]) {\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\thook(...args);\n\t\t\t\t\treturn originalFunctions[name].apply(this, args);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\t// eslint-disable-next-line no-inner-declarations\n\t\tfunction unbind() {\n\t\t\t// Restore the original FS functions.\n\t\t\tfor (const [name, fn] of Object.entries(originalFunctions)) {\n\t\t\t\tphp[__private__dont__use].FS[name] = fn;\n\t\t\t}\n\t\t}\n\n\t\tphp[__private__dont__use].journal = {\n\t\t\tbind,\n\t\t\tunbind,\n\t\t};\n\t\tbind();\n\t}\n\tphp.addEventListener('runtime.initialized', bindToCurrentRuntime);\n\tif (php[__private__dont__use]) {\n\t\tbindToCurrentRuntime();\n\t}\n\n\tfunction unbindFromOldRuntime() {\n\t\tphp[__private__dont__use].journal.unbind();\n\t\tdelete php[__private__dont__use].journal;\n\t}\n\tphp.addEventListener('runtime.beforeExit', unbindFromOldRuntime);\n\n\treturn function unbind() {\n\t\tphp.removeEventListener('runtime.initialized', bindToCurrentRuntime);\n\t\tphp.removeEventListener('runtime.beforeExit', unbindFromOldRuntime);\n\t\treturn php[__private__dont__use].journal.unbind();\n\t};\n}\n\nconst createFSHooks = (\n\tFS: EmscriptenFS,\n\trecordEntry: (entry: FilesystemOperation) => void = () => {}\n) => ({\n\twrite(stream: EmscriptenFSStream) {\n\t\trecordEntry({\n\t\t\toperation: 'WRITE',\n\t\t\tpath: stream.path,\n\t\t\tnodeType: 'file',\n\t\t});\n\t},\n\ttruncate(path: string) {\n\t\tlet node;\n\t\tif (typeof path == 'string') {\n\t\t\tconst lookup = FS.lookupPath(path, {\n\t\t\t\tfollow: true,\n\t\t\t});\n\t\t\tnode = lookup.node;\n\t\t} else {\n\t\t\tnode = path;\n\t\t}\n\t\trecordEntry({\n\t\t\toperation: 'WRITE',\n\t\t\tpath: FS.getPath(node),\n\t\t\tnodeType: 'file',\n\t\t});\n\t},\n\tunlink(path: string) {\n\t\trecordEntry({\n\t\t\toperation: 'DELETE',\n\t\t\tpath,\n\t\t\tnodeType: 'file',\n\t\t});\n\t},\n\tmknod(path: string, mode: number) {\n\t\tif (FS.isFile(mode)) {\n\t\t\trecordEntry({\n\t\t\t\toperation: 'CREATE',\n\t\t\t\tpath,\n\t\t\t\tnodeType: 'file',\n\t\t\t});\n\t\t}\n\t},\n\tmkdir(path: string) {\n\t\trecordEntry({\n\t\t\toperation: 'CREATE',\n\t\t\tpath,\n\t\t\tnodeType: 'directory',\n\t\t});\n\t},\n\trmdir(path: string) {\n\t\trecordEntry({\n\t\t\toperation: 'DELETE',\n\t\t\tpath,\n\t\t\tnodeType: 'directory',\n\t\t});\n\t},\n\trename(old_path: string, new_path: string) {\n\t\ttry {\n\t\t\tconst oldLookup = FS.lookupPath(old_path, {\n\t\t\t\tfollow: true,\n\t\t\t});\n\t\t\tconst newParentPath = FS.lookupPath(new_path, {\n\t\t\t\tparent: true,\n\t\t\t}).path;\n\n\t\t\trecordEntry({\n\t\t\t\toperation: 'RENAME',\n\t\t\t\tnodeType: FS.isDir(oldLookup.node.mode) ? 'directory' : 'file',\n\t\t\t\tpath: oldLookup.path,\n\t\t\t\ttoPath: joinPaths(newParentPath, basename(new_path)),\n\t\t\t});\n\t\t} catch {\n\t\t\t// We're running a bunch of FS lookups that may fail at this point.\n\t\t\t// Let's ignore the failures and let the actual rename operation\n\t\t\t// fail if it needs to.\n\t\t}\n\t},\n});\n\n/**\n * Replays a list of filesystem operations on a PHP instance.\n *\n * @param php\n * @param entries\n */\nexport function replayFSJournal(php: PHP, entries: FilesystemOperation[]) {\n\t// We need to restore the original functions to the FS object\n\t// before proceeding, or each replayed FS operation will be journaled.\n\t//\n\t// Unfortunately we can't just call the non-journaling versions directly,\n\t// because they call other low-level FS functions like `FS.mkdir()`\n\t// and will trigger the journaling hooks anyway.\n\tphp[__private__dont__use].journal.unbind();\n\ttry {\n\t\tfor (const entry of entries) {\n\t\t\tif (entry.operation === 'CREATE') {\n\t\t\t\tif (entry.nodeType === 'file') {\n\t\t\t\t\tphp.writeFile(entry.path, ' ');\n\t\t\t\t} else {\n\t\t\t\t\tphp.mkdir(entry.path);\n\t\t\t\t}\n\t\t\t} else if (entry.operation === 'DELETE') {\n\t\t\t\tif (entry.nodeType === 'file') {\n\t\t\t\t\tphp.unlink(entry.path);\n\t\t\t\t} else {\n\t\t\t\t\tphp.rmdir(entry.path);\n\t\t\t\t}\n\t\t\t} else if (entry.operation === 'WRITE') {\n\t\t\t\tphp.writeFile(entry.path, entry.data!);\n\t\t\t} else if (entry.operation === 'RENAME') {\n\t\t\t\tphp.mv(entry.path, entry.toPath);\n\t\t\t}\n\t\t}\n\t} finally {\n\t\tphp[__private__dont__use].journal.bind();\n\t}\n}\n\nexport function* recordExistingPath(\n\tphp: PHP,\n\tfromPath: string,\n\ttoPath: string\n): Generator<FilesystemOperation> {\n\tif (php.isDir(fromPath)) {\n\t\t// The rename operation moved a directory from outside root directory\n\t\t// into the root directory. We need to traverse the entire tree\n\t\t// and provide a create operation for each file and directory.\n\t\tyield {\n\t\t\toperation: 'CREATE',\n\t\t\tpath: toPath,\n\t\t\tnodeType: 'directory',\n\t\t};\n\t\tfor (const file of php.listFiles(fromPath)) {\n\t\t\tyield* recordExistingPath(\n\t\t\t\tphp,\n\t\t\t\tjoinPaths(fromPath, file),\n\t\t\t\tjoinPaths(toPath, file)\n\t\t\t);\n\t\t}\n\t} else {\n\t\t// The rename operation moved a file from outside root directory\n\t\t// into the root directory. Let's rewrite it as a create operation.\n\t\tyield {\n\t\t\toperation: 'CREATE',\n\t\t\tpath: toPath,\n\t\t\tnodeType: 'file',\n\t\t};\n\t\tyield {\n\t\t\toperation: 'WRITE',\n\t\t\tnodeType: 'file',\n\t\t\tpath: toPath,\n\t\t};\n\t}\n}\n\nfunction normalizePath(path: string) {\n\treturn path.replace(/\\/$/, '').replace(/\\/\\/+/g, '/');\n}\n\n/**\n * Normalizes a list of filesystem operations to remove\n * redundant operations.\n *\n * This is crucial because the journal doesn't store the file contents\n * on write, but only the information that the write happened. We only\n * read the contents of the file on flush. However, at that time the file\n * could have been moved to another location so we need this function to\n * rewrite the journal to reflect the current file location. Only then\n * will the hydrateUpdateFileOps() function be able to do its job.\n *\n * @param journal The original journal.\n * @returns The normalized journal.\n */\nexport function normalizeFilesystemOperations(\n\tinput: FilesystemOperation[]\n): FilesystemOperation[] {\n\tlet journal = input;\n\twhile (true) {\n\t\tconst substitutions: Record<number, any> = {};\n\t\tfor (let i = journal.length - 1; i >= 0; i--) {\n\t\t\tfor (let j = i - 1; j >= 0; j--) {\n\t\t\t\tconst formerType = checkRelationship(journal[i], journal[j]);\n\t\t\t\tif (formerType === 'none') {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst latter = journal[i];\n\t\t\t\tconst former = journal[j];\n\t\t\t\tif (\n\t\t\t\t\tlatter.operation === 'RENAME' &&\n\t\t\t\t\tformer.operation === 'RENAME'\n\t\t\t\t) {\n\t\t\t\t\t// Normalizing a double rename is a complex scenario so let's just give\n\t\t\t\t\t// up. There's just too many possible scenarios to handle.\n\t\t\t\t\t//\n\t\t\t\t\t// For example, the following scenario may not be possible to normalize:\n\t\t\t\t\t// RENAME /dir_a /dir_b\n\t\t\t\t\t// RENAME /dir_b/subdir /dir_c\n\t\t\t\t\t// RENAME /dir_b /dir_d\n\t\t\t\t\t//\n\t\t\t\t\t// Similarly, how should we normalize the following list?\n\t\t\t\t\t// CREATE_FILE /file\n\t\t\t\t\t// CREATE_DIR /dir_a\n\t\t\t\t\t// RENAME /file /dir_a/file\n\t\t\t\t\t// RENAME /dir_a /dir_b\n\t\t\t\t\t// RENAME /dir_b/file /dir_b/file_2\n\t\t\t\t\t//\n\t\t\t\t\t// The shortest way to recreate the same structure would be this:\n\t\t\t\t\t// CREATE_DIR /dir_b\n\t\t\t\t\t// CREATE_FILE /dir_b/file_2\n\t\t\t\t\t//\n\t\t\t\t\t// But that's not a straightforward transformation so let's just not\n\t\t\t\t\t// handle it for now.\n\t\t\t\t\tlogger.warn(\n\t\t\t\t\t\t'[FS Journal] Normalizing a double rename is not yet supported:',\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcurrent: latter,\n\t\t\t\t\t\t\tlast: former,\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tif (\n\t\t\t\t\tformer.operation === 'CREATE' ||\n\t\t\t\t\tformer.operation === 'WRITE'\n\t\t\t\t) {\n\t\t\t\t\tif (latter.operation === 'RENAME') {\n\t\t\t\t\t\tif (formerType === 'same_node') {\n\t\t\t\t\t\t\t// Creating a node and then renaming it is equivalent to creating\n\t\t\t\t\t\t\t// it in the new location.\n\t\t\t\t\t\t\tsubstitutions[j] = [];\n\t\t\t\t\t\t\tsubstitutions[i] = [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t...former,\n\t\t\t\t\t\t\t\t\tpath: latter.toPath,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t...(substitutions[i] || []),\n\t\t\t\t\t\t\t];\n\t\t\t\t\t\t} else if (formerType === 'descendant') {\n\t\t\t\t\t\t\t// Creating a node and then renaming its parent directory is\n\t\t\t\t\t\t\t// equivalent to creating it in the new location.\n\t\t\t\t\t\t\tsubstitutions[j] = [];\n\t\t\t\t\t\t\tsubstitutions[i] = [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t...former,\n\t\t\t\t\t\t\t\t\tpath: joinPaths(\n\t\t\t\t\t\t\t\t\t\tlatter.toPath,\n\t\t\t\t\t\t\t\t\t\tformer.path.substring(\n\t\t\t\t\t\t\t\t\t\t\tlatter.path.length\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t...(substitutions[i] || []),\n\t\t\t\t\t\t\t];\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (\n\t\t\t\t\t\tlatter.operation === 'WRITE' &&\n\t\t\t\t\t\tformerType === 'same_node'\n\t\t\t\t\t) {\n\t\t\t\t\t\t// Updating the same node twice is equivalent to updating it once\n\t\t\t\t\t\t// at the later time.\n\t\t\t\t\t\tsubstitutions[j] = [];\n\t\t\t\t\t} else if (\n\t\t\t\t\t\tlatter.operation === 'DELETE' &&\n\t\t\t\t\t\tformerType === 'same_node'\n\t\t\t\t\t) {\n\t\t\t\t\t\t// A CREATE/WRITE followed by a DELETE on the same node.\n\t\t\t\t\t\t// The CREATE/WRITE is redundant.\n\t\t\t\t\t\tsubstitutions[j] = [];\n\n\t\t\t\t\t\t// The DELETE is redundant only if the node was created\n\t\t\t\t\t\t// in this journal.\n\t\t\t\t\t\tif (former.operation === 'CREATE') {\n\t\t\t\t\t\t\tsubstitutions[i] = [];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (Object.keys(substitutions).length === 0) {\n\t\t\treturn journal;\n\t\t}\n\n\t\tjournal = journal.flatMap((op, index) => {\n\t\t\tif (!(index in substitutions)) {\n\t\t\t\treturn [op];\n\t\t\t}\n\t\t\treturn substitutions[index];\n\t\t});\n\t}\n}\n\ntype RelatedOperationInfo = 'same_node' | 'ancestor' | 'descendant' | 'none';\nfunction checkRelationship(\n\tlatter: FilesystemOperation,\n\tformer: FilesystemOperation\n): RelatedOperationInfo {\n\tconst latterPath = latter.path;\n\tconst latterIsDir =\n\t\tlatter.operation !== 'WRITE' && latter.nodeType === 'directory';\n\tconst formerIsDir =\n\t\tformer.operation !== 'WRITE' && former.nodeType === 'directory';\n\tconst formerPath =\n\t\tformer.operation === 'RENAME' ? former.toPath : former.path;\n\n\tif (formerPath === latterPath) {\n\t\treturn 'same_node';\n\t} else if (formerIsDir && latterPath.startsWith(formerPath + '/')) {\n\t\treturn 'ancestor';\n\t} else if (latterIsDir && formerPath.startsWith(latterPath + '/')) {\n\t\treturn 'descendant';\n\t}\n\treturn 'none';\n}\n\n/**\n * Populates each WRITE operation with the contents of\n * said file.\n *\n * Mutates the original array.\n *\n * @param php\n * @param entries\n */\nexport async function hydrateUpdateFileOps(\n\tphp: UniversalPHP,\n\tentries: FilesystemOperation[]\n) {\n\tconst updateFileOps = entries.filter(\n\t\t(op): op is UpdateFileOperation => op.operation === 'WRITE'\n\t);\n\tconst updates = updateFileOps.map((op) => hydrateOp(php, op));\n\tawait Promise.all(updates);\n\treturn entries;\n}\n\nconst hydrateLock = new Semaphore({ concurrency: 15 });\nasync function hydrateOp(php: UniversalPHP, op: UpdateFileOperation) {\n\tconst release = await hydrateLock.acquire();\n\n\t// There is a race condition here:\n\t// The file could have been removed from the filesystem\n\t// between the flush() call and now. If that happens, we won't\n\t// be able to read it here.\n\t//\n\t// If the file was DELETEd, we're fine as the next flush() will\n\t// propagate the DELETE operation.\n\t//\n\t// If the file was RENAMEd, we're in trouble as we're about to\n\t// tell the other peer to create an empty file and the next\n\t// flush() will rename that empty file.\n\t//\n\t// This issue requires a particular timing and is unlikely to ever happen,\n\t// but is definitely possible. We could mitigate it by either:\n\t//\n\t// * Peeking into the buffered journal entries since the last flush() to\n\t//   source the file path from\n\t// * Storing the data at the journaling stage instead of the flush() stage,\n\t//   (and using potentially a lot of additional memory to keep track of all\n\t//    the intermediate stages)\n\t//\n\t// For now, htough, let's just add error logging and keep an eye on this\n\t// to see if this actually ever happens.\n\ttry {\n\t\top.data = await php.readFileAsBuffer(op.path);\n\t} catch (e) {\n\t\t// Log the error but don't throw.\n\t\tlogger.warn(\n\t\t\t`Journal failed to hydrate a file on flush: the ` +\n\t\t\t\t`path ${op.path} no longer exists`\n\t\t);\n\t\tlogger.error(e);\n\t}\n\n\trelease();\n}\n","// @ts-ignore\nimport css from './style.module.css';\n\nexport interface ProgressBarOptions {\n\tcaption?: string;\n\tprogress?: number;\n\tisIndefinite?: boolean;\n\tvisible?: boolean;\n}\n\nclass ProgressBar {\n\telement: HTMLDivElement;\n\tcaptionElement: HTMLHeadingElement;\n\tcaption = 'Preparing WordPress';\n\tprogress = 0;\n\tisIndefinite = false;\n\tvisible = true;\n\n\tconstructor(options: ProgressBarOptions = {}) {\n\t\tthis.element = document.createElement('div');\n\t\tthis.captionElement = document.createElement('h3');\n\t\tthis.element.appendChild(this.captionElement);\n\t\tthis.setOptions(options);\n\t}\n\n\tsetOptions(options: ProgressBarOptions) {\n\t\tif ('caption' in options && options.caption) {\n\t\t\tthis.caption = options.caption!;\n\t\t}\n\t\tif ('progress' in options) {\n\t\t\tthis.progress = options.progress!;\n\t\t}\n\t\tif ('isIndefinite' in options) {\n\t\t\tthis.isIndefinite = options.isIndefinite!;\n\t\t}\n\t\tif ('visible' in options) {\n\t\t\tthis.visible = options.visible!;\n\t\t}\n\n\t\tthis.updateElement();\n\t}\n\n\tdestroy() {\n\t\tthis.setOptions({\n\t\t\tvisible: false,\n\t\t});\n\t\tsetTimeout(() => {\n\t\t\tthis.element.remove();\n\t\t}, 500);\n\t}\n\n\tupdateElement() {\n\t\tthis.element.className = '';\n\t\tthis.element.classList.add(css['overlay']);\n\n\t\tif (!this.visible) {\n\t\t\tthis.element.classList.add(css['isHidden']);\n\t\t}\n\n\t\tthis.captionElement.className = '';\n\t\tthis.captionElement.classList.add(css['caption']);\n\t\tthis.captionElement.textContent = this.caption + '...';\n\n\t\tconst progressBarWrapper = this.element.querySelector(\n\t\t\t`.${css['wrapper']}`\n\t\t);\n\t\tif (progressBarWrapper) {\n\t\t\tthis.element.removeChild(progressBarWrapper);\n\t\t}\n\n\t\tif (this.isIndefinite) {\n\t\t\tthis.element.appendChild(this.createProgressIndefinite());\n\t\t} else {\n\t\t\tthis.element.appendChild(this.createProgress());\n\t\t}\n\t}\n\n\tcreateProgress() {\n\t\tconst wrapper = document.createElement('div');\n\t\twrapper.classList.add(css['wrapper'], css['wrapperDefinite']);\n\n\t\tconst progressBar = document.createElement('div');\n\t\tprogressBar.classList.add(css['progressBar'], css['isDefinite']);\n\t\tprogressBar.style.width = this.progress + '%';\n\n\t\twrapper.appendChild(progressBar);\n\t\treturn wrapper;\n\t}\n\n\tcreateProgressIndefinite() {\n\t\tconst wrapper = document.createElement('div');\n\t\twrapper.classList.add(css['wrapper'], css['wrapperIndefinite']);\n\n\t\tconst progressBar = document.createElement('div');\n\t\tprogressBar.classList.add(css['progressBar'], css['isIndefinite']);\n\n\t\twrapper.appendChild(progressBar);\n\t\treturn wrapper;\n\t}\n}\n\nexport default ProgressBar;\n","import type { MessageListener } from '@php-wasm/universal';\nimport type { SyncProgressCallback } from '@php-wasm/web';\nimport {\n\tspawnPHPWorkerThread,\n\texposeAPI,\n\tconsumeAPI,\n\tsetupPostMessageRelay,\n} from '@php-wasm/web';\n\nimport type {\n\tPlaygroundWorkerEndpoint,\n\tWorkerBootOptions,\n\tMountDescriptor,\n} from './playground-worker-endpoint';\nexport type { MountDescriptor, WorkerBootOptions };\nimport type { WebClientMixin } from './playground-client';\nimport type { ProgressBarOptions } from './progress-bar';\nimport ProgressBar from './progress-bar';\n\n// @ts-ignore\nimport serviceWorkerPath from '../../service-worker.ts?worker&url';\nimport type { FilesystemOperation } from '@php-wasm/fs-journal';\nimport { logger } from '@php-wasm/logger';\nimport { PhpWasmError } from '@php-wasm/util';\nimport { responseTo } from '@php-wasm/web-service-worker';\n\n// Select worker runtime (v1 or v2) based on query parameter\n// @ts-ignore\nimport workerV1Url from './playground-worker-endpoint-blueprints-v1.ts?worker&url';\n// @ts-ignore\nimport workerV2Url from './playground-worker-endpoint-blueprints-v2.ts?worker&url';\n\n// Avoid literal \"import.meta.url\" on purpose as vite would attempt\n// to resolve it during build time. This should specifically be\n// resolved by the browser at runtime to reflect the current origin.\nconst origin = new URL('/', (import.meta || {}).url).origin;\n\nfunction getWorkerUrl(): string {\n\tconst runner = new URL(document.location.href).searchParams.get('blueprints-runner');\n\tconst isV2 = runner === 'v2';\n\tconst selected = isV2 ? workerV2Url : workerV1Url;\n\treturn new URL(selected, origin) + '';\n}\n\nexport const serviceWorkerUrl = new URL(serviceWorkerPath, origin);\n\n// Prevent Vite from hot-reloading this file – it would\n// cause bootPlaygroundRemote() to register another web worker\n// without unregistering the previous one. The first web worker\n// would then fight for service worker requests with the second\n// one. It's a difficult problem to debug and HMR isn't that useful\n// here anyway – let's just disable it for this file.\n// @ts-ignore\nif (import.meta.hot) {\n\t// @ts-ignore\n\timport.meta.hot.accept(() => {});\n}\n\nconst query = new URL(document.location.href).searchParams;\nexport async function bootPlaygroundRemote() {\n\tassertNotInfiniteLoadingLoop();\n\n\tconst hasProgressBar = query.has('progressbar');\n\tlet bar: ProgressBar | undefined;\n\tif (hasProgressBar) {\n\t\tbar = new ProgressBar();\n\t\tdocument.body.prepend(bar.element);\n\t}\n\tconst sw = navigator.serviceWorker;\n\tif (!sw) {\n\t\t/**\n\t\t * Service workers may only run in secure contexts.\n\t\t * See https://w3c.github.io/webappsec-secure-contexts/\n\t\t */\n\t\tif (window.isSecureContext) {\n\t\t\tthrow new PhpWasmError(\n\t\t\t\t'Service workers are not supported in your browser.'\n\t\t\t);\n\t\t} else {\n\t\t\tthrow new PhpWasmError(\n\t\t\t\t'WordPress Playground uses service workers and may only work on HTTPS and http://localhost/ sites, but the current site is neither.'\n\t\t\t);\n\t\t}\n\t}\n\n\tconst registration = await sw.register(serviceWorkerUrl + '', {\n\t\ttype: 'module',\n\t\t// Always bypass HTTP cache when fetching the new Service Worker script:\n\t\tupdateViaCache: 'none',\n\t});\n\n\t// Check if there's a new service worker available and, if so, enqueue\n\t// the update:\n\ttry {\n\t\tawait registration.update();\n\t} catch (e) {\n\t\t// registration.update() throws if it can't reach the server.\n\t\t// We're swallowing the error to keep the app working in offline mode\n\t\t// or when playground.wordpress.net is down. We can be sure we have a\n\t\t// functional service worker at this point because sw.register() succeeded.\n\t\tlogger.error('Failed to update service worker.', e);\n\t}\n\n\tconst workerUrl = new URL(getWorkerUrl(), origin) + '';\n\n\tconst phpWorkerApi = consumeAPI<PlaygroundWorkerEndpoint>(\n\t\tawait spawnPHPWorkerThread(workerUrl)\n\t);\n\n\tconst wpFrame = document.querySelector('#wp') as HTMLIFrameElement;\n\tconst phpRemoteApi: WebClientMixin = {\n\t\tasync onDownloadProgress(fn) {\n\t\t\treturn phpWorkerApi.onDownloadProgress(fn);\n\t\t},\n\t\tasync journalFSEvents(root: string, callback) {\n\t\t\treturn phpWorkerApi.journalFSEvents(root, callback);\n\t\t},\n\t\tasync replayFSJournal(events: FilesystemOperation[]) {\n\t\t\treturn phpWorkerApi.replayFSJournal(events);\n\t\t},\n\t\tasync addEventListener(event, listener) {\n\t\t\treturn await phpWorkerApi.addEventListener(event, listener);\n\t\t},\n\t\tasync removeEventListener(event, listener) {\n\t\t\treturn await phpWorkerApi.removeEventListener(event, listener);\n\t\t},\n\t\tasync setProgress(options: ProgressBarOptions) {\n\t\t\tif (!bar) {\n\t\t\t\tthrow new Error('Progress bar not available');\n\t\t\t}\n\t\t\tbar.setOptions(options);\n\t\t},\n\t\tasync setLoaded() {\n\t\t\tif (!bar) {\n\t\t\t\tthrow new Error('Progress bar not available');\n\t\t\t}\n\t\t\tbar.destroy();\n\t\t},\n\n\t\t/**\n\t\t * Listens to Playground navigation.\n\t\t *\n\t\t * @param fn The function to be called when a navigation event occurs.\n\t\t */\n\t\tasync onNavigation(fn) {\n\t\t\t/**\n\t\t\t * Note: We do not manually clear the event listener and the interval set in this function.\n\t\t\t *\n\t\t\t * This is because we're inside remote.html – a Playground instance-specific iframe.\n\t\t\t * When a Playground is stopped the iframe is destroyed and the resources – cleaned up.\n\t\t\t * Even if we wanted to clean up these resources manually, it would have to be onbeforeunload.\n\t\t\t * We'll let the browser handle that.\n\t\t\t */\n\t\t\t// Listen for iframe load events (for navigation)\n\t\t\twpFrame.addEventListener('load', async (e: any) => {\n\t\t\t\ttry {\n\t\t\t\t\t/**\n\t\t\t\t\t * When navigating to a page with %0A sequences (encoded newlines)\n\t\t\t\t\t * in the query string, the `location.href` property of the\n\t\t\t\t\t * iframe's content window doesn't seem to reflect them. Everything\n\t\t\t\t\t * else is in place, but not the %0A sequences.\n\t\t\t\t\t *\n\t\t\t\t\t * Weirdly, these sequences are available after the next event\n\t\t\t\t\t * loop tick – hence the `setTimeout(0)`.\n\t\t\t\t\t *\n\t\t\t\t\t * The exact cause is unclear at the moment of writing of this\n\t\t\t\t\t * comment. The WHATWG HTML Standard [1] has a few hints:\n\t\t\t\t\t *\n\t\t\t\t\t * * Current and active session history entries may get out of\n\t\t\t\t\t *   sync for iframes.\n\t\t\t\t\t * * Documents inside iframes have \"is delaying load events\" set\n\t\t\t\t\t *   to true.\n\t\t\t\t\t *\n\t\t\t\t\t * But there doesn't seem to be any concrete explanation and no\n\t\t\t\t\t * recommended remediation. If anyone has a clue, please share it\n\t\t\t\t\t * in a GitHub issue or start a new PR.\n\t\t\t\t\t *\n\t\t\t\t\t * [1] https://html.spec.whatwg.org/multipage/document-sequences.html#nav-active-history-entry\n\t\t\t\t\t */\n\t\t\t\t\t// Get the content window while e.currentTarget is available.\n\t\t\t\t\t// It will be undefined on the next event loop tick.\n\t\t\t\t\tconst contentWindow = e.currentTarget!.contentWindow;\n\t\t\t\t\tawait new Promise((resolve) => setTimeout(resolve, 0));\n\t\t\t\t\tconst path = await playground.internalUrlToPath(\n\t\t\t\t\t\tcontentWindow.location.href\n\t\t\t\t\t);\n\t\t\t\t\tfn(path);\n\t\t\t\t} catch {\n\t\t\t\t\t// @TODO: The above call can fail if the remote iframe\n\t\t\t\t\t// is embedded in StackBlitz, or presumably, any other\n\t\t\t\t\t// environment with restrictive CSP. Any error thrown\n\t\t\t\t\t// due to CORS-related stuff crashes the entire remote\n\t\t\t\t\t// so let's ignore it for now and find a correct fix in time.\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Also propagate navigation changes twice a second for any\n\t\t\t// updates we don't receive via the iframe load event.\n\t\t\t//\n\t\t\t// For more details on the challenges related to the load event,\n\t\t\t// see:\n\t\t\t//\n\t\t\t// * https://github.com/WordPress/wordpress-playground/pull/1945\n\t\t\t// * https://html.spec.whatwg.org/multipage/document-sequences.html#nav-active-history-entry\n\t\t\t// * https://html.spec.whatwg.org/dev/browsing-the-web.html#centralized-modifications-of-session-history\n\t\t\tlet lastPath: string | undefined;\n\t\t\tsetInterval(async () => {\n\t\t\t\ttry {\n\t\t\t\t\tlet href = '';\n\t\t\t\t\tif (wpFrame.contentWindow) {\n\t\t\t\t\t\thref = wpFrame.contentWindow.location.href;\n\t\t\t\t\t} else {\n\t\t\t\t\t\thref = wpFrame.src;\n\t\t\t\t\t}\n\t\t\t\t\tconst path = await playground.internalUrlToPath(href);\n\t\t\t\t\tif (path !== lastPath) {\n\t\t\t\t\t\tlastPath = path;\n\t\t\t\t\t\tfn(path);\n\t\t\t\t\t}\n\t\t\t\t} catch {\n\t\t\t\t\t// Ignore errors due to CORS or CSP restrictions\n\t\t\t\t}\n\t\t\t}, 500);\n\t\t},\n\t\tasync goTo(requestedPath: string) {\n\t\t\tif (!requestedPath.startsWith('/')) {\n\t\t\t\trequestedPath = '/' + requestedPath;\n\t\t\t}\n\t\t\t/**\n\t\t\t * Workaround for a Safari bug: navigating to `/wp-admin`\n\t\t\t * without the trailing slash causes the browser to hang.\n\t\t\t * Chrome and Firefox correctly navigate to `/wp-admin`,\n\t\t\t * get a 302 redirect from PHPRequestHandler, and then follow\n\t\t\t * it to `/wp-admin/`.\n\t\t\t *\n\t\t\t * Interestingly, opening pretty permalinks without the trailing slash\n\t\t\t * works correctly. For example, `/sample-page` works as expected.\n\t\t\t */\n\t\t\tif (requestedPath === '/wp-admin') {\n\t\t\t\trequestedPath = '/wp-admin/';\n\t\t\t}\n\t\t\tconst newUrl = await playground.pathToInternalUrl(requestedPath);\n\t\t\tconst oldUrl = wpFrame.src;\n\n\t\t\t// If the URL is the same, we need to force a reload\n\t\t\t// because otherwise the iframe will not reload the page.\n\t\t\tif (newUrl === oldUrl && wpFrame.contentWindow) {\n\t\t\t\ttry {\n\t\t\t\t\twpFrame.contentWindow.location.href = newUrl;\n\t\t\t\t\treturn;\n\t\t\t\t} catch {\n\t\t\t\t\t// The above call can fail if we're embedded in an\n\t\t\t\t\t// environment with a restrictive CSP policy.\n\t\t\t\t}\n\t\t\t}\n\t\t\twpFrame.src = newUrl;\n\t\t},\n\t\tasync getCurrentURL() {\n\t\t\tlet url = '';\n\t\t\ttry {\n\t\t\t\turl = wpFrame.contentWindow!.location.href;\n\t\t\t} catch {\n\t\t\t\t// The above call can fail if we're embedded in an\n\t\t\t\t// environment with a restrictive CSP policy.\n\t\t\t}\n\t\t\tif (!url) {\n\t\t\t\t// If we can't get the URL from the iframe (e.g. it's not loaded\n\t\t\t\t// yet), let's refer to the src attribute of the iframe itself.\n\t\t\t\t// This is less reliable because the src attribute may not be\n\t\t\t\t// updated when the iframe navigates to a new URL.\n\t\t\t\turl = wpFrame.src;\n\t\t\t}\n\t\t\treturn await playground.internalUrlToPath(url);\n\t\t},\n\t\tasync setIframeSandboxFlags(flags: string[]) {\n\t\t\twpFrame.setAttribute('sandbox', flags.join(' '));\n\t\t},\n\t\t/**\n\t\t * This function is merely here to explicitly call workerApi.onMessage.\n\t\t * Comlink should be able to handle that on its own, but something goes\n\t\t * wrong and if this function is not here, we see the following error:\n\t\t *\n\t\t * Error: Failed to execute 'postMessage' on 'Worker': function() {\n\t\t * } could not be cloned.\n\t\t *\n\t\t * In the future, this explicit declaration shouldn't be needed.\n\t\t *\n\t\t * @param callback\n\t\t * @returns\n\t\t */\n\t\tasync onMessage(callback: MessageListener) {\n\t\t\treturn await phpWorkerApi.onMessage(callback);\n\t\t},\n\n\t\t/**\n\t\t * Ditto for this function.\n\t\t * @see onMessage\n\t\t * @param callback\n\t\t * @returns\n\t\t */\n\t\tasync mountOpfs(\n\t\t\toptions: MountDescriptor,\n\t\t\tonProgress?: SyncProgressCallback\n\t\t) {\n\t\t\treturn await phpWorkerApi.mountOpfs(options, onProgress);\n\t\t},\n\n\t\t/**\n\t\t * Ditto for this function.\n\t\t * @see onMessage\n\t\t * @param mountpoint\n\t\t * @returns\n\t\t */\n\t\tasync unmountOpfs(mountpoint: string) {\n\t\t\treturn await phpWorkerApi.unmountOpfs(mountpoint);\n\t\t},\n\n\t\t/**\n\t\t * Download WordPress assets.\n\t\t * @see backfillStaticFilesRemovedFromMinifiedBuild in the worker-thread.ts\n\t\t */\n\t\tasync backfillStaticFilesRemovedFromMinifiedBuild() {\n\t\t\tawait phpWorkerApi.backfillStaticFilesRemovedFromMinifiedBuild();\n\t\t},\n\n\t\t/**\n\t\t * Checks whether we have the missing WordPress assets readily\n\t\t * available in the request cache.\n\t\t */\n\t\tasync hasCachedStaticFilesRemovedFromMinifiedBuild() {\n\t\t\treturn await phpWorkerApi.hasCachedStaticFilesRemovedFromMinifiedBuild();\n\t\t},\n\n\t\tasync boot(options) {\n\t\t\tawait phpWorkerApi.boot(options);\n\n\t\t\t// Proxy the service worker messages to the web worker:\n\t\t\tnavigator.serviceWorker.addEventListener(\n\t\t\t\t'message',\n\t\t\t\tasync function onMessage(event) {\n\t\t\t\t\t/**\n\t\t\t\t\t * Ignore events meant for other PHP instances to\n\t\t\t\t\t * avoid handling the same event twice.\n\t\t\t\t\t *\n\t\t\t\t\t * This is important because the service worker posts the\n\t\t\t\t\t * same message to all application instances across all browser tabs.\n\t\t\t\t\t */\n\t\t\t\t\tif (options.scope && event.data.scope !== options.scope) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Wait for the PHP API client to be set by bootPlaygroundRemote\n\t\t\t\t\tconst args = event.data.args || [];\n\t\t\t\t\tconst method = event.data\n\t\t\t\t\t\t.method as keyof PlaygroundWorkerEndpoint;\n\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\n\t\t\t\t\tconst result = await (phpWorkerApi[method] as Function)(\n\t\t\t\t\t\t...args\n\t\t\t\t\t);\n\t\t\t\t\tevent.source!.postMessage(\n\t\t\t\t\t\tresponseTo(event.data.requestId, result)\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t);\n\t\t\tsw.startMessages();\n\n\t\t\ttry {\n\t\t\t\tawait phpWorkerApi.isReady();\n\n\t\t\t\tsetupPostMessageRelay(\n\t\t\t\t\twpFrame,\n\t\t\t\t\tgetOrigin((await playground.absoluteUrl)!)\n\t\t\t\t);\n\n\t\t\t\tsetAPIReady();\n\t\t\t} catch (e) {\n\t\t\t\tsetAPIError(e as Error);\n\t\t\t\tthrow e;\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * When we're running WordPress from a minified bundle, we're missing some static assets.\n\t\t\t * The section below backfills them if needed. It doesn't do anything if the assets are already\n\t\t\t * in place, or when WordPress is loaded from a non-minified bundle.\n\t\t\t *\n\t\t\t * Minified bundles are shipped without most static assets to reduce the bundle size and\n\t\t\t * the loading time. When WordPress loads for the first time, the browser parses all the\n\t\t\t * <script src=\"\">, <link href=\"\">, etc. tags and fetches the missing assets from the server.\n\t\t\t *\n\t\t\t * Unfortunately, fetching these assets on demand wouldn't work in an offline mode.\n\t\t\t *\n\t\t\t * Below we're downloading a zipped bundle of the missing assets.\n\t\t\t */\n\t\t\tif (\n\t\t\t\tawait phpRemoteApi.hasCachedStaticFilesRemovedFromMinifiedBuild()\n\t\t\t) {\n\t\t\t\t/**\n\t\t\t\t * If we already have the static assets in the cache, the backfilling only\n\t\t\t\t * involves unzipping the archive. This is fast. Let's do it before the first\n\t\t\t\t * render.\n\t\t\t\t *\n\t\t\t\t * Why?\n\t\t\t\t *\n\t\t\t\t * Because otherwise the initial offline page render would lack CSS.\n\t\t\t\t * Without the static assets in /wordpress/wp-content, the browser would\n\t\t\t\t * attempt to fetch them from the server. However, we're in an offline mode\n\t\t\t\t * so nothing would be fetched.\n\t\t\t\t */\n\t\t\t\tawait phpRemoteApi.backfillStaticFilesRemovedFromMinifiedBuild();\n\t\t\t} else {\n\t\t\t\t/**\n\t\t\t\t * If we don't have the static assets in the cache, we need to fetch them.\n\t\t\t\t *\n\t\t\t\t * Let's wait for the initial page load before we start the backfilling.\n\t\t\t\t * The static assets are 12MB+ in size. Starting the download before\n\t\t\t\t * Playground is loaded would noticeably delay the first paint.\n\t\t\t\t */\n\t\t\t\twpFrame.addEventListener('load', () => {\n\t\t\t\t\tphpRemoteApi.backfillStaticFilesRemovedFromMinifiedBuild();\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t};\n\n\tawait phpWorkerApi.isConnected();\n\n\t// If onDownloadProgress is not explicitly re-exposed here,\n\t// Comlink will throw an error and claim the callback\n\t// cannot be cloned. Adding a transfer handler for functions\n\t// doesn't help:\n\t// https://github.com/GoogleChromeLabs/comlink/issues/426#issuecomment-578401454\n\t// @TODO: Handle the callback conversion automatically and don't explicitly re-expose\n\t//        the onDownloadProgress method\n\tconst [setAPIReady, setAPIError, playground] = exposeAPI(\n\t\tphpRemoteApi,\n\t\tphpWorkerApi\n\t);\n\n\t/*\n\t * An assertion to make sure Playground Client is compatible\n\t * with Remote<PlaygroundClient>\n\t */\n\treturn playground;\n}\n\nfunction getOrigin(url: string) {\n\treturn new URL(url, 'https://example.com').origin;\n}\n\n/**\n * When the service worker fails for any reason, the page displayed inside\n * the iframe won't be a WordPress instance we expect from the service worker.\n * Instead, it will be the original page trying to load the service worker. This\n * causes an infinite loop with a loader inside a loader inside a loader.\n */\nfunction assertNotInfiniteLoadingLoop() {\n\tlet isBrowserInABrowser = false;\n\ttry {\n\t\tisBrowserInABrowser =\n\t\t\twindow.parent !== window &&\n\t\t\t(window as any).parent.IS_WASM_WORDPRESS;\n\t} catch {\n\t\t// ignore\n\t}\n\tif (isBrowserInABrowser) {\n\t\tthrow new Error(\n\t\t\t`The service worker did not load correctly. This is a bug,\n\t\t\tplease report it on https://github.com/WordPress/wordpress-playground/issues`\n\t\t);\n\t}\n\t(window as any).IS_WASM_WORDPRESS = true;\n}\n","export { getWordPressModuleDetails } from './wordpress/get-wordpress-module-details';\nexport { getWordPressModule } from './wordpress/get-wordpress-module';\nexport {\n\tgetSqliteDriverModule,\n\tLatestSqliteDriverVersion,\n} from './sqlite-database-integration/get-sqlite-driver-module';\nexport { getSqliteDriverModuleDetails } from './sqlite-database-integration/get-sqlite-driver-module-details';\nimport MinifiedWordPressVersions from './wordpress/wp-versions.json';\n\nexport { MinifiedWordPressVersions };\nexport const MinifiedWordPressVersionsList = Object.keys(\n\tMinifiedWordPressVersions\n) as any as string[];\nexport const LatestMinifiedWordPressVersion =\n\tMinifiedWordPressVersionsList.filter((v) => v.match(/^\\d/))[0] as string;\n\nexport function wpVersionToStaticAssetsDirectory(\n\twpVersion: string\n): string | undefined {\n\treturn wpVersion in MinifiedWordPressVersions\n\t\t? `wp-${wpVersion}`\n\t\t: undefined;\n}\n","\n\t\t\tif (window.top != window.self) {\n\t\t\t\tdocument.body.classList.add('is-embedded');\n\t\t\t}\n\t\t\timport { bootPlaygroundRemote } from './src/index';\n\t\t\ttry {\n\t\t\t\twindow.playground = await bootPlaygroundRemote();\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(e);\n\t\t\t\tdocument.body.className = 'has-error';\n\t\t\t\tdocument.body.innerHTML = '';\n\n\t\t\t\tif (e?.name === 'NotSupportedError') {\n\t\t\t\t\tdocument.body.append(await renderStorageErrorUI());\n\t\t\t\t} else {\n\t\t\t\t\tdocument.body.append(renderGenericErrorUI(e));\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tdocument.body.classList.remove('is-loading');\n\t\t\t}\n\n\t\t\tfunction renderGenericErrorUI(error) {\n\t\t\t\tconst fragment = document.createDocumentFragment();\n\n\t\t\t\tconst div = document.createElement('div');\n\t\t\t\tdiv.className = 'error-message';\n\t\t\t\tconst userFriendlyMessage =\n\t\t\t\t\terror.userFriendlyMessage ||\n\t\t\t\t\t'See the developer tools for error details.';\n\t\t\t\tdiv.innerHTML =\n\t\t\t\t\t'Ooops! WordPress Playground had a hiccup! <br/><br/> ' +\n\t\t\t\t\tuserFriendlyMessage;\n\t\t\t\tfragment.append(div);\n\n\t\t\t\tconst button = document.createElement('button');\n\t\t\t\tbutton.innerText = 'Try again';\n\t\t\t\tbutton.onclick = () => {\n\t\t\t\t\twindow.location.reload();\n\t\t\t\t};\n\t\t\t\tfragment.append(button);\n\n\t\t\t\tconst reportIssues = document.createElement('p');\n\t\t\t\treportIssues.innerHTML = `\n\t\t\t\t\tIf the problem persists, please\n\t\t\t\t\t<a href=\"https://github.com/WordPress/playground-tools/issues/new\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t>report an issue on GitHub</a>.\n\t\t\t\t`;\n\t\t\t\tfragment.append(reportIssues);\n\n\t\t\t\treturn fragment;\n\t\t\t}\n\n\t\t\tasync function renderStorageErrorUI() {\n\t\t\t\tconst fragment = document.createDocumentFragment();\n\n\t\t\t\t/**\n\t\t\t\t * Chrome does not allow Service Workers to be registered from cross-origin iframes\n\t\t\t\t * when third-party cookies are disabled unless `requestStorageAccess()` is called\n\t\t\t\t * and the user grants storage access.\n\t\t\t\t *\n\t\t\t\t * Let's assess the situation and provide a helpful message.\n\t\t\t\t */\n\t\t\t\tlet hasStorageAccess = false;\n\t\t\t\ttry {\n\t\t\t\t\tconst { state } = await navigator.permissions.query({\n\t\t\t\t\t\tname: 'storage-access',\n\t\t\t\t\t});\n\t\t\t\t\thasStorageAccess = state === 'granted';\n\t\t\t\t} catch (e) {\n\t\t\t\t\t// noop\n\t\t\t\t}\n\n\t\t\t\tif (hasStorageAccess || !('requestStorageAccess' in document)) {\n\t\t\t\t\tconst div = document.createElement('div');\n\n\t\t\t\t\t// The user has granted storage access, but the error still persists.\n\t\t\t\t\t// Let's explain why.\n\t\t\t\t\tdiv.innerText =\n\t\t\t\t\t\t'It looks like you have disabled third-party cookies in your browser. This ' +\n\t\t\t\t\t\t'also disables the Service Worker API used by WordPress Playground. Please re-enable ' +\n\t\t\t\t\t\t'third-party cookies and try again.';\n\t\t\t\t\tfragment.append(div);\n\n\t\t\t\t\tconst button = document.createElement('button');\n\t\t\t\t\tbutton.innerText = 'Try again';\n\t\t\t\t\tbutton.onclick = () => {\n\t\t\t\t\t\twindow.location.reload();\n\t\t\t\t\t};\n\t\t\t\t\tfragment.append(button);\n\t\t\t\t} else {\n\t\t\t\t\tconst div = document.createElement('div');\n\n\t\t\t\t\t// The user has not granted storage access.\n\t\t\t\t\t// There's a chance we can fix this by asking for storage access.\n\t\t\t\t\tdiv.innerText =\n\t\t\t\t\t\t'WordPress Playground needs to use storage in your browser.';\n\t\t\t\t\tfragment.append(div);\n\n\t\t\t\t\tconst button = document.createElement('button');\n\t\t\t\t\tbutton.innerText = 'Allow storage access';\n\t\t\t\t\tfragment.append(button);\n\n\t\t\t\t\tbutton.onclick = async () => {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait document.requestStorageAccess();\n\t\t\t\t\t\t\twindow.location.reload();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t// Either the user denied storage access OR chrome is not allowing\n\t\t\t\t\t\t\t// storage access to be requested from an iframe for some reason.\n\n\t\t\t\t\t\t\t// The two errors are indistinguishable and just say \"requestStorageAccess not allowed\"\n\t\t\t\t\t\t\t// https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/core/dom/document.cc;drc=daf56cfa413f10dee6aa15b0b1e4572fcf5578df;l=462\n\t\t\t\t\t\t\t// It's confusing! But we can at least tell the user what to do.\n\t\t\t\t\t\t\tdiv.innerHTML = `\n\t\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t\tOops! Playground failed to start. Here's what to do:\n\t\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t\t<h3>Did you disable third-party cookies?</h3>\n\t\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t\tIt also disables the required Service Worker API. Please re-enable\n\t\t\t\t\t\t\t\t\tthird-party cookies and try again.\n\t\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t\t<h3>Did you refuse to grant Playground storage access?</h3>\n\t\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t\tClick the button below and grant storage access. Note the button may\n\t\t\t\t\t\t\t\t\tnot work if you have disabled third-party cookies in your browser.\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t\tIf neither method helped, please\n\t\t\t\t\t\t\t\t\t<a href=\"https://github.com/WordPress/playground-tools/issues/new\"\n\t\t\t\t\t\t\t\t\t\ttarget=\"_blank\">\n\t\t\t\t\t\t\t\t\t\treport an issue on GitHub\n\t\t\t\t\t\t\t\t\t</a>.\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\treturn fragment;\n\t\t\t}\n\t\t"],"names":["currentJsRuntime","asPromise","obj","resolve","reject","event","isByobSupported","inputBytes","stream","File","sources","fileName","options","date","reader","position","blob","controller","view","buffer","uint8array","bytesRead","CustomEvent","name","logEventType","logEvent","log","args","logger","logToConsole","prepareLogMessage","LogSeverity","logMessage","logs","addToLogArray","message","logToMemory","formatLogEntry","LogPrefix","Logger","handlers","logWithSeverity","handler","severity","getDefaultHandlers","prefix","formattedDate","formattedTime","now","SleepFinished","sleep","ms","AcquireTimeoutError","Semaphore","concurrency","timeout","acquired","value","released","fn","release","PhpWasmError","userFriendlyMessage","concatUint8Arrays","arrays","totalLength","a","result","offset","responseTexts","StreamedPHPResponse","headers","stdout","stderr","exitCode","statusCode","bytes","streamToBytes","streamToText","parseHeadersStream","headersStream","headersText","headersData","line","colonIndex","headerName","headerValue","text","done","chunks","acc","chunk","PHPResponse","httpStatusCode","body","errors","data","streamedResponse","proxyMarker","createEndpoint","releaseProxy","finalizer","throwMarker","WireValueType","MessageType","isObject","val","proxyTransferHandler","port1","port2","expose","port","wrap","throwTransferHandler","serialized","transferHandlers","isAllowedOrigin","allowedOrigins","origin","allowedOrigin","ep","afterResponseSent","callback","ev","id","type","path","argumentList","fromWireValue","returnValue","parent","prop","rawValue","proxy","transfer","wireValue","transferables","toWireValue","closeEndPoint","isMessagePort","endpoint","target","pendingListeners","resolver","createProxy","throwIfProxyReleased","isReleased","releaseEndpoint","requestResponseMessage","proxyCounter","proxyFinalizers","newCount","registerProxy","unregisterProxy","isProxyReleased","_target","r","p","_thisArg","rawArgumentList","last","processArguments","myFlat","arr","processed","v","transferCache","transfers","windowEndpoint","w","context","targetOrigin","msg","serializedValue","generateUUID","nodeEndpoint","nep","listeners","_","eh","l","list","constructor","errorConstructors","NonError","errorProperties","toJsonWasCalled","toJSON","from","json","newError","ErrorConstructor","destroyCircular","seen","to","forceEnumerable","maxDepth","depth","useToJSON","serialize","isErrorLike","continueDestroyCircular","key","property","enumerable","serializeError","deserializeError","isMinimumViableSerializedError","consumeAPI","remote","setupTransferHandlers","Comlink.windowEndpoint","api","Comlink.wrap","methods","proxyClone","runWithTimeout","promise","exposeAPI","apiMethods","pipedApi","targetWorker","setReady","setFailed","exposedApi","prepareForExpose","Comlink.expose","connected","ready","isTransferHandlersSetup","Comlink.transferHandlers","responseData","throwHandler","originalSerialize","supportsStreams","supportsTransferableStreams","exitCodePort","promiseToPort","headersPort","streamToPort","stdoutPort","stderrPort","portToPromise","portToStream","rs","owned","buf","e","onMessage","cleanup","err","throwTransferHandlerCustom","ErrorSerializer.serializeError","error","ErrorSerializer.deserializeError","additionalCallStack","deepestError","object","Comlink.proxy","flipObject","k","ExtensionTypes","ServerNameTypes","CipherSuites","SupportedGroups","ECPointFormats","SignatureAlgorithms","HashAlgorithms","AlertLevels","AlertDescriptions","responseTo","requestId","response","ChunkedDecoderStream","state","chunkRemainingBytes","chunkBytesNb","byte","chunkSizeHex","chunkSize","bytesToRead","setupPostMessageRelay","nestedFrame","expectedOrigin","spawnPHPWorkerThread","workerUrl","worker","onStartup","ProgressBar","css","progressBarWrapper","wrapper","progressBar","getWorkerUrl","selected","workerV2Url","workerV1Url","serviceWorkerUrl","serviceWorkerPath","query","bootPlaygroundRemote","assertNotInfiniteLoadingLoop","hasProgressBar","bar","sw","registration","phpWorkerApi","wpFrame","phpRemoteApi","root","events","listener","contentWindow","playground","lastPath","href","requestedPath","newUrl","oldUrl","url","flags","onProgress","mountpoint","method","getOrigin","setAPIReady","setAPIError","isBrowserInABrowser","MinifiedWordPressVersionsList","MinifiedWordPressVersions","renderStorageErrorUI","renderGenericErrorUI","fragment","div","button","reportIssues","hasStorageAccess"],"mappings":"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"}