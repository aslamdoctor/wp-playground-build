{"version":3,"file":"time-traveling-BuOzokPq.js","sources":["../../../../../packages/playground/website/demos/time-traveling.tsx"],"sourcesContent":["import React from 'react';\nimport { createRoot } from 'react-dom/client';\n\nimport { startPlaygroundWeb } from '@wp-playground/client';\nimport { login } from '@wp-playground/blueprints';\nimport {\n\tsetupPlaygroundSync,\n\tNoopTransport,\n\tloggerMiddleware,\n} from '@wp-playground/sync';\nimport type { TransportEnvelope, SyncMiddleware } from '@wp-playground/sync';\nimport { getRemoteUrl } from '../src/lib/config';\n\nconst clientId = 'time-traveling';\n\nexport async function restartDemo(initialJournal: TransportEnvelope[] = []) {\n\tconst autoincrementOffset = Math.round((1 + Math.random()) * 1_000_000);\n\tconsole.log({ autoincrementOffset });\n\tconst iframe = document.getElementById('wp') as HTMLIFrameElement;\n\tconst playground = await startPlaygroundWeb({\n\t\tiframe,\n\t\tremoteUrl: getRemoteUrl().toString(),\n\t\t// The new AST-based SQLite driver doesn't expose query information\n\t\t// via the \"sqlite_last_insert_id\", \"sqlite_translated_query_executed\",\n\t\t// and \"sqlite_transaction_query_executed\" hooks.\n\t\t// We need to use the old driver here.\n\t\tsqliteDriverVersion: 'v2.1.16',\n\t});\n\tconst transport = new NoopTransport();\n\tawait setupPlaygroundSync(playground, {\n\t\tautoincrementOffset,\n\t\ttransport,\n\t\tmiddlewares: [loggerMiddleware(clientId), timeTravellingMiddleware],\n\t});\n\tinitialJournal.forEach((envelope) => transport.injectChanges(envelope));\n\n\tawait login(playground, { username: 'admin', password: 'password' });\n\tawait playground.goTo('/');\n}\n\nconst timeTravellingMiddleware: SyncMiddleware = {\n\tbeforeSend(envelopes) {\n\t\tstoreEnvelopes(envelopes);\n\t\treturn envelopes;\n\t},\n\tafterReceive(envelopes) {\n\t\t// We're in the solo mode and not receiving anything from the server.\n\t\treturn envelopes;\n\t},\n};\n\ntype EnvelopeListProps = {\n\tenvelopes: EnvelopeWithId[];\n};\nconst EnvelopeList: React.FC<EnvelopeListProps> = ({\n\tenvelopes,\n}: EnvelopeListProps) => {\n\tconst [uncheckedEnvelopes, setUncheckedEnvelopes] = React.useState<\n\t\tSet<number>\n\t>(new Set());\n\tfunction toggleEnvelope(id: number) {\n\t\tsetUncheckedEnvelopes((uncheckedEnvelopes) => {\n\t\t\tconst newSet = new Set(uncheckedEnvelopes);\n\t\t\tif (newSet.has(id)) {\n\t\t\t\tnewSet.delete(id);\n\t\t\t} else {\n\t\t\t\tnewSet.add(id);\n\t\t\t}\n\t\t\treturn newSet;\n\t\t});\n\t}\n\tfunction replay() {\n\t\tconst checkedEnvelopes = envelopes.filter(\n\t\t\t(envelope) => !uncheckedEnvelopes.has(envelope.id)\n\t\t);\n\t\tconsole.log('Replaying');\n\t\trestartDemo(checkedEnvelopes);\n\t}\n\treturn (\n\t\t<>\n\t\t\t<button type=\"button\" onClick={replay}>\n\t\t\t\tReplay selected\n\t\t\t</button>\n\t\t\t<ul>\n\t\t\t\t{[...envelopes].reverse().map((envelope) => (\n\t\t\t\t\t<li key={envelope.id}>\n\t\t\t\t\t\t<label>\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<h4>\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype=\"checkbox\"\n\t\t\t\t\t\t\t\t\t\tchecked={\n\t\t\t\t\t\t\t\t\t\t\t!uncheckedEnvelopes.has(envelope.id)\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tonChange={() =>\n\t\t\t\t\t\t\t\t\t\t\ttoggleEnvelope(envelope.id)\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t&nbsp; Batch of changes #${envelope.id}\n\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<h5>SQL changes</h5>\n\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t\t{envelope.sql.map((sql, idx) => (\n\t\t\t\t\t\t\t\t\t<li key={idx}>{JSON.stringify(sql)}</li>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t\t<h5>FS changes</h5>\n\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t\t{envelope.fs.map((fs, idx) => (\n\t\t\t\t\t\t\t\t\t<li key={idx}>{JSON.stringify(fs)}</li>\n\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</li>\n\t\t\t\t))}\n\t\t\t</ul>\n\t\t</>\n\t);\n};\n\nconst domNode = document.getElementById('logs') as any;\nconst root = createRoot(domNode);\nroot.render(<EnvelopeList envelopes={[]} />);\n\ntype EnvelopeWithId = TransportEnvelope & { id: number };\nconst storedEnvelopes: EnvelopeWithId[] = [];\nfunction storeEnvelopes(envelope: TransportEnvelope) {\n\tif (!envelope.sql.length && !envelope.fs.length) return;\n\tstoredEnvelopes.push({ ...envelope, id: storedEnvelopes.length });\n\troot.render(<EnvelopeList envelopes={storedEnvelopes} />);\n}\n"],"names":["clientId","restartDemo","initialJournal","autoincrementOffset","iframe","playground","startPlaygroundWeb","getRemoteUrl","transport","NoopTransport","setupPlaygroundSync","loggerMiddleware","timeTravellingMiddleware","envelope","login","envelopes","storeEnvelopes","EnvelopeList","uncheckedEnvelopes","setUncheckedEnvelopes","React","toggleEnvelope","id","newSet","replay","checkedEnvelopes","jsxs","Fragment","jsx","sql","idx","fs","domNode","root","createRoot","storedEnvelopes"],"mappings":"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"}